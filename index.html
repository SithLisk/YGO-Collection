<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scott's Yu-Gi-Oh! Scott's Yu-Gi-Oh!<br>Collection Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
:root {
  --void: #080404;
  --deep: #1a0505;
  --mid: #3d0a0a;
  --bright: #8b1a1a;
  --accent: #c0392b;
  --gold: #f0c040;
  --gold-dim: #b8901a;
  --gold-pale: #fde68a;
  --silver: #c8c0d8;
  --silver-dim: #6b5f7a;
  --white: #f5f0ff;
  --border: rgba(180,40,40,0.35);
  --glow: 0 0 20px rgba(160,30,30,0.4);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--void); color: var(--white); font-family: 'Crimson Pro', Georgia, serif; min-height: 100vh; overflow-x: hidden; }
body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background: radial-gradient(ellipse 80% 50% at 50% -10%, rgba(160,30,30,0.25) 0%, transparent 60%),
              radial-gradient(ellipse 40% 30% at 80% 80%, rgba(120,15,15,0.15) 0%, transparent 50%);
}
.stars {
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background-image:
    radial-gradient(1px 1px at 15% 20%, rgba(255,255,255,0.6) 0%, transparent 100%),
    radial-gradient(1px 1px at 35% 8%, rgba(255,255,255,0.4) 0%, transparent 100%),
    radial-gradient(1px 1px at 60% 35%, rgba(255,255,255,0.5) 0%, transparent 100%),
    radial-gradient(1px 1px at 80% 15%, rgba(255,255,255,0.3) 0%, transparent 100%),
    radial-gradient(1.5px 1.5px at 50% 80%, rgba(240,192,64,0.5) 0%, transparent 100%);
}
.wrap { position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; padding: 0 24px 60px; }

header { text-align: center; padding: 48px 0 32px; border-bottom: 1px solid var(--border); margin-bottom: 32px; position: relative; }
header::after { content: ''; position: absolute; bottom: -1px; left: 50%; transform: translateX(-50%); width: 200px; height: 2px; background: linear-gradient(90deg, transparent, var(--gold), transparent); }
.eyebrow { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 6px; color: var(--gold-dim); text-transform: uppercase; margin-bottom: 12px; }
h1 { font-family: 'Cinzel Decorative', serif; font-size: clamp(22px,4vw,38px); font-weight: 700; background: linear-gradient(135deg, var(--gold-pale), var(--gold) 40%, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1.2; margin-bottom: 8px; }
.subtitle { font-size: 15px; color: var(--silver-dim); font-style: italic; }

.sync-bar { display: flex; align-items: center; justify-content: space-between; background: rgba(25,5,5,0.7); border: 1px solid var(--border); border-radius: 10px; padding: 10px 20px; margin-bottom: 20px; font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; flex-wrap: wrap; gap: 10px; }
.sync-row { display: flex; align-items: center; gap: 8px; }
.sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--silver-dim); transition: all 0.3s; }
.sync-dot.syncing { background: var(--gold); box-shadow: 0 0 8px var(--gold); animation: pulse 1s infinite; }
.sync-dot.synced  { background: #4ade80; box-shadow: 0 0 8px #4ade80; }
.sync-dot.error   { background: #f87171; box-shadow: 0 0 8px #f87171; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
#syncLabel { color: var(--silver-dim); }
#syncLabel.synced  { color: #4ade80; }
#syncLabel.syncing { color: var(--gold); }
#syncLabel.error   { color: #f87171; }

.search-panel { background: linear-gradient(135deg, rgba(35,5,5,0.9), rgba(8,4,4,0.95)); border: 1px solid var(--border); border-radius: 16px; padding: 28px 32px; margin-bottom: 28px; box-shadow: var(--glow); position: relative; }
.search-panel::before { content: '\2B21'; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); font-size: 20px; color: var(--gold); background: var(--void); padding: 0 8px; }
.sec-label { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 4px; color: var(--accent); text-transform: uppercase; margin-bottom: 14px; }

.test-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
.btn-test { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; background: rgba(160,30,30,0.3); color: var(--gold-pale); border: 1px solid rgba(160,30,30,0.5); border-radius: 6px; padding: 6px 14px; cursor: pointer; }
.btn-test:hover { background: rgba(160,30,30,0.5); }
#testResult { font-size: 13px; font-style: italic; color: var(--silver-dim); }

.search-row { display: flex; gap: 12px; align-items: center; }
.search-wrap { flex: 1; position: relative; }
input[type="text"] { width: 100%; background: rgba(12,3,3,0.8); border: 1px solid var(--border); border-radius: 10px; color: var(--white); font-family: 'Crimson Pro', serif; font-size: 17px; padding: 13px 18px; outline: none; transition: border-color 0.2s; }
input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(160,30,30,0.15); }
input[type="text"]::placeholder { color: var(--silver-dim); }
.status-msg { font-size: 13px; font-style: italic; color: var(--silver-dim); min-width: 100px; }

.ac-list { position: absolute; top: calc(100% + 6px); left: 0; right: 0; background: rgba(20,5,5,0.98); border: 1px solid var(--border); border-radius: 10px; max-height: 280px; overflow-y: auto; z-index: 100; box-shadow: 0 8px 32px rgba(0,0,0,0.6); display: none; }
.ac-list.open { display: block; }
.ac-item { padding: 10px 16px; cursor: pointer; font-size: 15px; border-bottom: 1px solid rgba(180,40,40,0.12); display: flex; justify-content: space-between; align-items: center; transition: background 0.15s; }
.ac-item:last-child { border-bottom: none; }
.ac-item:hover, .ac-item.hi { background: rgba(160,30,30,0.25); }
.tbadge { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 1px; padding: 2px 7px; border-radius: 4px; text-transform: uppercase; flex-shrink: 0; }
.bm { background: rgba(200,100,30,0.3); color: #f4a261; border: 1px solid rgba(200,100,30,0.4); }
.bs { background: rgba(20,138,138,0.3); color: #4ecdc4; border: 1px solid rgba(20,138,138,0.4); }
.bt { background: rgba(155,32,96,0.3); color: #f48fb1; border: 1px solid rgba(155,32,96,0.4); }

.card-preview { display: none; margin-top: 28px; border-top: 1px solid var(--border); padding-top: 24px; animation: fadeUp 0.3s ease; }
.card-preview.open { display: block; }
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.preview-grid { display: grid; grid-template-columns: 180px 1fr; gap: 24px; align-items: start; }
@media(max-width:640px){ .preview-grid { grid-template-columns: 1fr; } }
.img-wrap { border-radius: 10px; overflow: hidden; box-shadow: 0 4px 24px rgba(0,0,0,0.6), 0 0 20px rgba(240,192,64,0.4); border: 1px solid rgba(240,192,64,0.3); background: var(--deep); aspect-ratio: 59/86; display: flex; align-items: center; justify-content: center; }
.img-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }
.img-ph { font-size: 48px; opacity: 0.3; }
.card-info { display: flex; flex-direction: column; gap: 12px; }
.card-name { font-family: 'Cinzel', serif; font-size: 20px; font-weight: 700; color: var(--gold-pale); line-height: 1.2; }
.card-meta { display: flex; flex-wrap: wrap; gap: 8px; }
.mpill { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 1.5px; padding: 3px 10px; border-radius: 20px; text-transform: uppercase; border: 1px solid; }
.pm { color: #f4a261; border-color: rgba(244,162,97,0.4); background: rgba(244,162,97,0.08); }
.ps { color: #4ecdc4; border-color: rgba(78,205,196,0.4); background: rgba(78,205,196,0.08); }
.pt { color: #f48fb1; border-color: rgba(244,143,177,0.4); background: rgba(244,143,177,0.08); }
.pa { color: var(--accent); border-color: rgba(192,57,43,0.4); background: rgba(192,57,43,0.08); }
.atk-def { font-family: 'Cinzel', serif; font-size: 13px; color: var(--silver); letter-spacing: 2px; }
.atk-def b { color: var(--gold); }
.card-eff { font-size: 13.5px; color: var(--silver); line-height: 1.7; font-style: italic; border-left: 2px solid rgba(192,57,43,0.4); padding-left: 12px; max-height: 120px; overflow-y: auto; }
.card-set { font-size: 13px; color: var(--silver-dim); }
.card-set strong { color: var(--silver); }

.entry-form { display: none; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px; gap: 16px; flex-wrap: wrap; }
.entry-form.open { display: flex; }
.field { display: flex; flex-direction: column; gap: 6px; min-width: 110px; }
.field label { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--silver-dim); }
.field select, .field input { background: rgba(12,3,3,0.8); border: 1px solid var(--border); border-radius: 8px; color: var(--white); font-family: 'Crimson Pro', serif; font-size: 15px; padding: 9px 12px; outline: none; transition: border-color 0.2s; width: 100%; }
.field select:focus, .field input:focus { border-color: var(--accent); }
.field select option { background: #1a0505; }

.btn { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 3px; text-transform: uppercase; border: none; border-radius: 8px; padding: 11px 24px; cursor: pointer; transition: all 0.2s; align-self: flex-end; }
.btn-add  { background: linear-gradient(135deg, var(--bright), var(--accent)); color: var(--white); box-shadow: 0 4px 16px rgba(139,26,26,0.4); }
.btn-add:hover  { transform: translateY(-1px); }
.btn-gold { background: linear-gradient(135deg, var(--gold-dim), var(--gold)); color: var(--void); }
.btn-gold:hover { transform: translateY(-1px); }
.btn-del { font-family: 'Cinzel', serif; font-size: 10px; background: rgba(192,57,43,0.2); color: #e07070; border: 1px solid rgba(192,57,43,0.3); border-radius: 6px; padding: 7px 14px; cursor: pointer; transition: background 0.2s; }
.btn-del:hover { background: rgba(192,57,43,0.4); }

.coll-panel { background: linear-gradient(135deg, rgba(35,5,5,0.85), rgba(8,4,4,0.9)); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; box-shadow: var(--glow); }
.panel-hdr { display: flex; justify-content: space-between; align-items: center; padding: 20px 28px; border-bottom: 1px solid var(--border); background: rgba(15,3,3,0.5); flex-wrap: wrap; gap: 12px; }
.panel-ttl { font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 3px; color: var(--gold); text-transform: uppercase; }
.stats-row { display: flex; gap: 24px; }
.stat { text-align: center; }
.stat-n { font-family: 'Cinzel Decorative', serif; font-size: 18px; color: var(--gold-pale); display: block; }
.stat-l { font-family: 'Cinzel', serif; font-size: 8px; letter-spacing: 2px; color: var(--silver-dim); text-transform: uppercase; }
.tbl-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 14px; }
thead th { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--silver-dim); padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; background: rgba(10,2,2,0.4); }
tbody tr { border-bottom: 1px solid rgba(180,40,40,0.1); transition: background 0.15s; }
tbody tr:hover { background: rgba(160,30,30,0.08); }
tbody tr:last-child { border-bottom: none; }
td { padding: 11px 16px; vertical-align: middle; color: var(--silver); }
.td-nm { font-size: 15px; font-weight: 600; color: var(--white); min-width: 160px; }
.dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
.dm         { background: #f4a261; }  /* generic monster - orange */
.d-effect   { background: #f97316; }  /* effect monster - deep orange */
.d-normal   { background: #fbbf24; }  /* normal monster - gold */
.d-fusion   { background: #a855f7; }  /* fusion - purple */
.d-synchro  { background: #e2e8f0; }  /* synchro - white */
.d-xyz      { background: #1e1e1e; box-shadow: 0 0 4px #666; }  /* xyz - black */
.d-link     { background: #3b82f6; }  /* link - blue */
.d-ritual   { background: #818cf8; }  /* ritual - indigo */
.d-pendulum { background: #10b981; }  /* pendulum - teal-green */
.ds         { background: #4ecdc4; }  /* spell - teal */
.dt         { background: #f48fb1; }  /* trap - pink */
.td-pr { font-family: 'Cinzel', serif; font-size: 12px; color: var(--gold); white-space: nowrap; }
.td-qt { font-family: 'Cinzel Decorative', serif; font-size: 15px; color: var(--gold-pale); text-align: center; }
.td-sm { font-size: 12px; color: var(--silver-dim); }
.td-atk { font-family: 'Cinzel', serif; font-size: 11px; white-space: nowrap; }
.cb { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 1px; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; white-space: nowrap; }
.c0 { background: rgba(26,122,58,0.25);  color: #4ade80; border: 1px solid rgba(26,122,58,0.4); }
.c1 { background: rgba(30,107,184,0.25); color: #60a5fa; border: 1px solid rgba(30,107,184,0.4); }
.c2 { background: rgba(240,192,64,0.2);  color: #fcd34d; border: 1px solid rgba(240,192,64,0.3); }
.c3 { background: rgba(224,123,57,0.2);  color: #fb923c; border: 1px solid rgba(224,123,57,0.3); }
.c4 { background: rgba(192,57,43,0.2);   color: #f87171; border: 1px solid rgba(192,57,43,0.3); }
.c5 { background: rgba(100,20,20,0.3);   color: #ef4444; border: 1px solid rgba(192,57,43,0.5); }
.rs { color: #e879f9; }
.ru { color: #fcd34d; }
.rr2 { color: #c4b5fd; }
.rr1 { color: #93c5fd; }
.rc { color: var(--silver-dim); }
.rtxt { font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 1px; }
.empty-st { text-align: center; padding: 60px 24px; color: var(--silver-dim); }
.empty-ic { font-size: 48px; margin-bottom: 16px; opacity: 0.4; }
.empty-tx { font-family: 'Cinzel', serif; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; }
.exp-bar { padding: 16px 28px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; background: rgba(10,2,2,0.3); }
.spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(160,30,30,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; }
@keyframes spin { to { transform: rotate(360deg); } }
.sortable { cursor: pointer; user-select: none; white-space: nowrap; }
.sortable:hover { color: var(--gold-pale); }
.sort-icon { font-size: 8px; margin-left: 4px; opacity: 0.5; }
.sort-icon.asc::after  { content: ' ▲'; opacity: 1; color: var(--gold); }
.sort-icon.desc::after { content: ' ▼'; opacity: 1; color: var(--gold); }
.toast { position: fixed; bottom: 32px; right: 32px; background: rgba(20,5,5,0.98); border: 1px solid var(--accent); border-radius: 10px; padding: 14px 20px; font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 1px; color: var(--gold-pale); box-shadow: var(--glow); transform: translateY(80px); opacity: 0; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1); z-index: 999; }
.toast.show { transform: translateY(0); opacity: 1; }
</style>
</head>
<body>
<div class="stars"></div>
<div class="wrap">

  <header>
    <div class="eyebrow">Live API &middot; Cloud Sync &middot; YGOPRODeck</div>
    <h1>Scott's Yu-Gi-Oh!<br>Collection Tracker</h1>
    <p class="subtitle">Search. Add. Sort. Enjoy.</p>
  </header>

  <div class="sync-bar">
    <div class="sync-row">
      <div class="sync-dot" id="syncDot"></div>
      <span id="syncLabel">Connecting&hellip;</span>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <span style="color:var(--silver-dim);font-size:9px;letter-spacing:1px">Changes sync automatically across all devices</span>
      <button class="btn-test" id="lockBtn" onclick="toggleAuth()" style="padding:5px 12px;font-size:9px">&#x1F512; Locked</button>
    </div>
  </div>

  <!-- Password modal -->
  <div id="pwModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#1a0505;border:1px solid var(--border);border-radius:16px;padding:36px;min-width:320px;box-shadow:var(--glow);text-align:center">
      <div style="font-family:'Cinzel',serif;font-size:13px;letter-spacing:3px;color:var(--gold);text-transform:uppercase;margin-bottom:20px">Enter Password</div>
      <input type="password" id="pwInput" placeholder="Password" style="width:100%;margin-bottom:12px" onkeydown="if(event.key==='Enter')submitPw()">
      <div id="pwError" style="color:#f87171;font-size:13px;font-style:italic;margin-bottom:12px;min-height:18px"></div>
      <div style="display:flex;gap:10px;justify-content:center">
        <button class="btn btn-add" onclick="submitPw()" style="padding:9px 20px;font-size:10px">Unlock</button>
        <button class="btn-test" onclick="closePwModal()" style="align-self:center">Cancel</button>
      </div>
    </div>
  </div>

  <div class="search-panel">
    <div class="sec-label">Search Card Database</div>
    <div class="test-bar">
      <button class="btn-test" onclick="testAPI()">Test API Connection</button>
      <span id="testResult"></span>
    </div>
    <div class="search-row">
      <div class="search-wrap">
        <input type="text" id="cardSearch" placeholder="Type a card name &mdash; e.g. Dark Magician, Ash Blossom&hellip;" autocomplete="off">
        <div class="ac-list" id="acList"></div>
      </div>
      <span class="status-msg" id="statusMsg"></span>
    </div>

    <div class="card-preview" id="cardPreview">
      <div class="preview-grid">
        <div class="img-wrap" id="cardImgWrap"><div class="img-ph">&#x1F0A3;</div></div>
        <div class="card-info">
          <div class="card-name" id="previewName"></div>
          <div class="card-meta" id="previewMeta"></div>
          <div class="atk-def" id="previewAtkDef"></div>
          <div class="card-eff" id="previewEffect"></div>
          <div class="card-set" id="previewSet"></div>
        </div>
      </div>
      <div class="entry-form" id="entryForm">
        <div class="field"><label>Quantity</label><input type="number" id="fQty" value="1" min="1" max="99" style="width:80px"></div>
        <div class="field"><label>Rarity</label>
          <select id="fRarity">
            <option>Common</option><option>Rare</option><option>Super Rare</option>
            <option>Ultra Rare</option><option>Secret Rare</option><option>Prismatic Secret Rare</option>
            <option>Ghost Rare</option><option>Starlight Rare</option><option>Quarter Century Secret Rare</option>
          </select>
        </div>
        <div class="field"><label>Condition</label>
          <select id="fCondition">
            <option>Mint</option><option selected>Near Mint</option><option>Lightly Played</option>
            <option>Moderately Played</option><option>Heavily Played</option><option>Damaged</option>
          </select>
        </div>
        <div class="field"><label>Edition</label>
          <select id="fEdition"><option>Unlimited</option><option>1st Edition</option><option>Limited Edition</option></select>
        </div>
        <div class="field"><label>Market Price ($)</label><input type="number" id="fPrice" min="0" step="0.01" placeholder="0.00" style="width:120px"></div>
        <div class="field"><label>Notes / Deck</label><input type="text" id="fNotes" placeholder="e.g. Main deck" style="min-width:160px"></div>
        <button class="btn btn-add" onclick="addToCollection()">+ Add Card</button>
      </div>
    </div>
  </div>

  <div class="coll-panel">
    <div class="panel-hdr">
      <div class="panel-ttl">My Collection</div>
      <div class="stats-row">
        <div class="stat"><span class="stat-n" id="statUnique">0</span><span class="stat-l">Unique</span></div>
        <div class="stat"><span class="stat-n" id="statTotal">0</span><span class="stat-l">Total Cards</span></div>
      </div>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr id="tableHeaders">
          <th onclick="sortBy('name')"      class="sortable">Card Name <span class="sort-icon" id="si-name"></span></th>
          <th onclick="sortBy('type')"      class="sortable">Type <span class="sort-icon" id="si-type"></span></th>
          <th onclick="sortBy('attribute')" class="sortable">Attribute <span class="sort-icon" id="si-attribute"></span></th>
          <th onclick="sortBy('archetype')" class="sortable">Archetype <span class="sort-icon" id="si-archetype"></span></th>
          <th onclick="sortBy('atk')"       class="sortable">ATK/DEF <span class="sort-icon" id="si-atk"></span></th>
          <th onclick="sortBy('setName')"   class="sortable">Set <span class="sort-icon" id="si-setName"></span></th>
          <th onclick="sortBy('cardNumber')" class="sortable">Card No. <span class="sort-icon" id="si-cardNumber"></span></th>
          <th onclick="sortBy('rarity')"    class="sortable">Rarity <span class="sort-icon" id="si-rarity"></span></th>
          <th onclick="sortBy('condition')" class="sortable">Condition <span class="sort-icon" id="si-condition"></span></th>
          <th onclick="sortBy('edition')"   class="sortable">Edition <span class="sort-icon" id="si-edition"></span></th>
          <th onclick="sortBy('qty')"       class="sortable">Qty <span class="sort-icon" id="si-qty"></span></th>
          <th></th>
        </tr></thead>
        <tbody id="collBody">
          <tr><td colspan="12"><div class="empty-st"><div class="empty-ic">&#9876;</div><p class="empty-tx">Loading&hellip;</p></div></td></tr>
        </tbody>
      </table>
    </div>
    <div class="exp-bar">
      <button class="btn btn-gold" onclick="exportCSV()">&#8595; Export CSV for Excel</button>
    </div>
  </div>

</div>
<div class="toast" id="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {

  // Firebase init
  firebase.initializeApp({
    apiKey: "AIzaSyCbb51QGCVq7N_cmTifYYJb8Eb_YiqkVg4",
    authDomain: "ygo-collection-4c76d.firebaseapp.com",
    projectId: "ygo-collection-4c76d",
    storageBucket: "ygo-collection-4c76d.firebasestorage.app",
    messagingSenderId: "725120094141",
    appId: "1:725120094141:web:ba9d638ce4c1a20d04ccd4"
  });
  var db = firebase.firestore();
  var col = db.collection('cards');

  var selCard = null;
  var cards = [];
  var timer = null;
  var acIdx = -1;

  var inp = document.getElementById('cardSearch');
  var acList = document.getElementById('acList');
  var statusEl = document.getElementById('statusMsg');

  // Sync state
  function sync(state, msg) {
    var dot = document.getElementById('syncDot');
    var lbl = document.getElementById('syncLabel');
    dot.className = 'sync-dot ' + state;
    lbl.className = state;
    lbl.textContent = msg;
  }

  // Firestore listener
  sync('syncing', 'Connecting...');
  col.orderBy('addedAt','asc').onSnapshot(function(snap) {
    cards = snap.docs.map(function(d) { var o = d.data(); o.fid = d.id; return o; });
    renderTable();
    sync('synced', 'Synced ' + new Date().toLocaleTimeString());
  }, function(err) {
    sync('error', 'Error: ' + err.code);
    renderTable();
  });

  // Search input
  inp.addEventListener('input', function() {
    clearTimeout(timer);
    var q = inp.value.trim();
    if (q.length === 0) { closeAc(); clearPreview(); return; }
    if (q.length < 4) { closeAc(); return; }
    timer = setTimeout(function() { doSearch(q); }, 700);
  });

  function clearPreview() {
    selCard = null;
    document.getElementById('cardPreview').classList.remove('open');
    document.getElementById('entryForm').classList.remove('open');
    document.getElementById('previewName').textContent = '';
    document.getElementById('previewMeta').innerHTML = '';
    document.getElementById('previewAtkDef').innerHTML = '';
    document.getElementById('previewEffect').textContent = '';
    document.getElementById('previewSet').textContent = '';
    document.getElementById('cardImgWrap').innerHTML = '<div class="img-ph">&#x1F0A3;</div>';
    statusEl.textContent = '';
  }

  inp.addEventListener('keydown', function(e) {
    var items = acList.querySelectorAll('.ac-item');
    if (e.key === 'ArrowDown') { acIdx = Math.min(acIdx+1, items.length-1); hiAc(items); e.preventDefault(); }
    else if (e.key === 'ArrowUp') { acIdx = Math.max(acIdx-1, 0); hiAc(items); e.preventDefault(); }
    else if (e.key === 'Enter' && acIdx >= 0 && items[acIdx]) { items[acIdx].click(); e.preventDefault(); }
    else if (e.key === 'Escape') closeAc();
  });

  document.addEventListener('click', function(e) { if (!e.target.closest('.search-wrap')) closeAc(); });

  function normalize(q) {
    return q
      .trim()
      // Remove characters the API doesn't accept
      .replace(/[^a-zA-Z0-9 '\-]/g, '')
      // Collapse multiple spaces
      .replace(/  +/g, ' ')
      // Title-case each word so "blue eyes" -> "Blue Eyes"
      .replace(/\b\w/g, function(c) { return c.toUpperCase(); });
  }

  function doSearch(q) {
    var base = 'https://db.ygoprodeck.com/api/v7/cardinfo.php';

    // Build a set of query variants to try in order:
    // 1. Input as-is (normalized + title-cased)
    // 2. Spaces replaced with hyphens  "Blue Eyes" -> "Blue-Eyes"
    // 3. Hyphens replaced with spaces  "Blue-Eyes" -> "Blue Eyes"
    // 4. First word only               "Blue-Eyes White Dragon" -> "Blue-Eyes"
    var norm      = normalize(q);
    if (norm.length < 4) return;

    var hyphenated = norm.replace(/ /g, '-');
    var spaced     = norm.replace(/-/g, ' ');
    var firstWord  = norm.split(/[ -]/)[0];

    // Deduplicate variants while preserving order
    var seen = {};
    var variants = [norm, hyphenated, spaced, firstWord].filter(function(v) {
      if (v.length < 4 || seen[v]) return false;
      seen[v] = true; return true;
    });

    statusEl.innerHTML = '<span class="spinner"></span>';

    function handleData(data) {
      statusEl.textContent = '';
      if (!data || data.error || !data.data || !data.data.length) {
        closeAc(); statusEl.textContent = 'No cards found'; return;
      }
      openAc(data.data.slice(0, 10));
    }

    // Try each variant in sequence, stopping at the first success
    // Also try archetype search — handles "Blue-Eyes", "Dark Magician" etc.
    // which are archetypes with hundreds of variants that break fname
    var archetypeGuess = norm.replace(/-/g, ' ');

    function tryFetch(url) {
      return fetch(url).then(function(r) { return r.ok ? r.json() : null; }).catch(function() { return null; });
    }

    function hasResults(d) { return d && d.data && d.data.length > 0; }

    function tryVariant(idx) {
      if (idx >= variants.length) {
        // All fname variants exhausted — try archetype as last resort
        tryFetch(base + '?archetype=' + encodeURIComponent(archetypeGuess) + '&num=10&offset=0')
          .then(function(d) {
            if (hasResults(d)) { handleData(d); return; }
            // Final fallback: first word as archetype
            var fw = archetypeGuess.split(' ')[0];
            if (fw.length >= 3) {
              return tryFetch(base + '?archetype=' + encodeURIComponent(fw) + '&num=10&offset=0')
                .then(function(d2) {
                  if (hasResults(d2)) { handleData(d2); return; }
                  statusEl.textContent = 'No cards found'; closeAc();
                });
            }
            statusEl.textContent = 'No cards found'; closeAc();
          });
        return;
      }
      var v = variants[idx];
      tryFetch(base + '?fname=' + encodeURIComponent(v) + '&num=10&offset=0')
        .then(function(d) {
          if (hasResults(d)) { handleData(d); return; }
          tryVariant(idx + 1);
        });
    }

    tryVariant(0);
  }

  function openAc(results) {
    acIdx = -1; acList.innerHTML = '';
    results.forEach(function(card) {
      var item = document.createElement('div');
      item.className = 'ac-item';
      var tl = tLabel(card.type);
      item.innerHTML = '<span>' + esc(card.name) + '</span><span class="tbadge ' + tl.c + '">' + tl.t + '</span>';
      item.addEventListener('click', function() { pickCard(card); });
      acList.appendChild(item);
    });
    acList.classList.add('open');
  }

  function hiAc(items) {
    items.forEach(function(it,i) { it.classList.toggle('hi', i===acIdx); });
    if (items[acIdx]) items[acIdx].scrollIntoView({block:'nearest'});
  }

  function closeAc() { acList.classList.remove('open'); acList.innerHTML = ''; acIdx = -1; }

  function pickCard(card) {
    selCard = card;
    inp.value = card.name;
    closeAc();
    statusEl.textContent = '';
    showPreview(card);
  }

  function showPreview(card) {
    document.getElementById('cardPreview').classList.add('open');
    document.getElementById('entryForm').classList.add('open');
    document.getElementById('previewName').textContent = card.name;

    var tl = tLabel(card.type);
    var pc = tl.c === 'bs' ? 'ps' : tl.c === 'bt' ? 'pt' : 'pm';
    var mh = '<span class="mpill ' + pc + '">' + esc(card.type) + '</span>';
    if (card.archetype) mh += '<span class="mpill pa">' + esc(card.archetype) + '</span>';
    document.getElementById('previewMeta').innerHTML = mh;

    var ad = document.getElementById('previewAtkDef');
    if (card.atk !== undefined) {
      ad.innerHTML = 'ATK <b>' + (card.atk===-1?'?':card.atk) + '</b> / DEF <b>' + (card.def===undefined?'?':card.def===-1?'?':card.def) + '</b>';
    } else { ad.innerHTML = ''; }

    document.getElementById('previewEffect').textContent = card.desc || '';

    var se = document.getElementById('previewSet');
    if (card.card_sets && card.card_sets.length) {
      var s = card.card_sets[0];
      se.innerHTML = '<strong>' + esc(s.set_name) + '</strong> &middot; ' + esc(s.set_code) + ' &middot; ' + esc(s.set_rarity);
      var opts = document.getElementById('fRarity').options;
      for (var i=0; i<opts.length; i++) { if (opts[i].value===s.set_rarity) { document.getElementById('fRarity').selectedIndex=i; break; } }
    } else { se.textContent = 'No set info'; }



    var wrap = document.getElementById('cardImgWrap');
    if (card.card_images && card.card_images.length) {
      var img = document.createElement('img');
      img.src = 'https://images.ygoprodeck.com/images/cards_small/' + card.card_images[0].id + '.jpg';
      img.alt = card.name;
      img.onerror = function() { wrap.innerHTML = '<div class="img-ph">&#x1F0A3;</div>'; };
      wrap.innerHTML = '';
      wrap.appendChild(img);
    } else { wrap.innerHTML = '<div class="img-ph">&#x1F0A3;</div>'; }
  }

  // Auth state
  var PW_HASH = '663dc2bedc7eb3349bc80bff0c508111936a2a0d18269353a7ef7020ae24cc18';
  var authed = false;
  var sortCol = null;
  var sortDir = 1; // 1 = asc, -1 = desc

  function sha256(str) {
    // Use SubtleCrypto to hash the password
    var buf = new TextEncoder().encode(str);
    return crypto.subtle.digest('SHA-256', buf).then(function(hash) {
      return Array.from(new Uint8Array(hash)).map(function(b) { return b.toString(16).padStart(2,'0'); }).join('');
    });
  }

  window.toggleAuth = function() {
    if (authed) {
      authed = false;
      updateLockBtn();
      toast('Locked');
    } else {
      document.getElementById('pwModal').style.display = 'flex';
      setTimeout(function() { document.getElementById('pwInput').focus(); }, 50);
    }
  };

  window.closePwModal = function() {
    document.getElementById('pwModal').style.display = 'none';
    document.getElementById('pwInput').value = '';
    document.getElementById('pwError').textContent = '';
  };

  window.submitPw = function() {
    var val = document.getElementById('pwInput').value;
    sha256(val).then(function(hash) {
      if (hash === PW_HASH) {
        authed = true;
        closePwModal();
        updateLockBtn();
        toast('Unlocked — you can now edit your collection');
      } else {
        document.getElementById('pwError').textContent = 'Incorrect password';
        document.getElementById('pwInput').value = '';
      }
    });
  };

  function updateLockBtn() {
    var btn = document.getElementById('lockBtn');
    if (authed) {
      btn.innerHTML = '&#x1F513; Unlocked';
      btn.style.color = '#4ade80';
      btn.style.borderColor = 'rgba(74,222,128,0.4)';
    } else {
      btn.innerHTML = '&#x1F512; Locked';
      btn.style.color = 'var(--gold-pale)';
      btn.style.borderColor = 'rgba(160,30,30,0.5)';
    }
  }

  function requireAuth(action) {
    if (authed) { action(); return; }
    document.getElementById('pwModal').style.display = 'flex';
    setTimeout(function() { document.getElementById('pwInput').focus(); }, 50);
  }

  // Add card
  window.addToCollection = function() {
    requireAuth(function() { doAdd(); });
  };
  function doAdd() {
    if (!selCard) return;
    var c = selCard;
    var fs = (c.card_sets && c.card_sets.length) ? c.card_sets[0] : {};
    sync('syncing','Saving...');
    col.add({
      name: c.name, type: c.type, race: c.race||'—',
      attribute: c.attribute||'—',
      archetype: c.archetype||'—',
      atk: c.atk!==undefined ? (c.atk===-1?'?':String(c.atk)) : '—',
      def: c.def!==undefined ? (c.def===-1?'?':String(c.def)) : '—',
      setName: fs.set_name||'—', setCode: fs.set_code||'—',
      cardNumber: fs.set_code||'—',
      rarity: document.getElementById('fRarity').value,
      condition: document.getElementById('fCondition').value,
      edition: document.getElementById('fEdition').value,
      qty: parseInt(document.getElementById('fQty').value)||1,
      price: parseFloat(document.getElementById('fPrice').value)||0,
      notes: document.getElementById('fNotes').value,
      addedAt: Date.now()
    }).then(function() {
      toast(c.name + ' added!');
      document.getElementById('fQty').value = 1;
      document.getElementById('fPrice').value = '';
      document.getElementById('fNotes').value = '';
    }).catch(function(e) { sync('error','Save failed'); toast('Save failed: ' + e.message); });
  }

  // Remove card
  window.removeEntry = function(id) {
    requireAuth(function() {
      sync('syncing','Removing...');
      db.collection('cards').doc(id).delete().catch(function(e) { sync('error','Delete failed'); });
    });
  };

  // Sort
  window.sortBy = function(col) {
    if (sortCol === col) {
      sortDir *= -1;
    } else {
      sortCol = col;
      sortDir = 1;
    }
    // Update sort icons
    document.querySelectorAll('.sort-icon').forEach(function(el) { el.className = 'sort-icon'; });
    var icon = document.getElementById('si-' + col);
    if (icon) icon.className = 'sort-icon ' + (sortDir === 1 ? 'asc' : 'desc');
    renderTable();
  };

  function getSortValue(e, col) {
    if (col === 'total') return (e.qty || 0) * (e.price || 0);
    if (col === 'qty')   return e.qty || 0;
    if (col === 'price') return e.price || 0;
    if (col === 'atk')   return isNaN(Number(e.atk)) ? -1 : Number(e.atk);
    return String(e[col] || '').toLowerCase();
  }

  function sortedCards() {
    if (!sortCol) return cards;
    return cards.slice().sort(function(a, b) {
      var av = getSortValue(a, sortCol);
      var bv = getSortValue(b, sortCol);
      if (av < bv) return -1 * sortDir;
      if (av > bv) return  1 * sortDir;
      return 0;
    });
  }

  // Render table
  function renderTable() {
    var tbody = document.getElementById('collBody');
    if (!cards.length) {
      tbody.innerHTML = '<tr><td colspan="12"><div class="empty-st"><div class="empty-ic">&#9876;</div><p class="empty-tx">Your collection awaits</p></div></td></tr>';
      updateStats(); return;
    }
    var h = '';
    sortedCards().forEach(function(e) {
      var tl = tLabel(e.type);
      var dc = dotClass(e.type);
      var tot = (e.qty||0)*(e.price||0);
      h += '<tr>';
      var lvlStr = '';
      if (e.level) {
        var prefix = (e.type && e.type.toLowerCase().indexOf('xyz') !== -1) ? 'R' : 'L';
        lvlStr = ' <span style="font-size:11px;color:var(--silver-dim);font-family:Cinzel,serif">(' + prefix + '-' + e.level + ')</span>';
      }
      h += '<td class="td-nm"><span class="dot ' + dc + '"></span>' + esc(e.name) + lvlStr + '</td>';
      h += '<td class="td-sm">' + esc(e.race||'—') + '</td>';
      h += '<td class="td-sm">' + attrBadge(e.attribute) + '</td>';
      h += '<td class="td-sm">' + esc(e.archetype) + '</td>';
      h += '<td class="td-atk">' + (e.atk!=='—' ? e.atk+' / '+e.def : '—') + '</td>';
      h += '<td class="td-sm">' + esc(e.setName) + '</td>';
      h += '<td class="td-sm">' + esc(e.cardNumber||e.setCode||'—') + '</td>';
      h += '<td class="rtxt ' + rClass(e.rarity) + '">' + esc(e.rarity) + '</td>';
      h += '<td><span class="cb ' + cClass(e.condition) + '">' + esc(e.condition) + '</span></td>';
      h += '<td class="td-sm">' + esc(e.edition) + '</td>';
      h += '<td class="td-qt">' + (e.qty||0) + '</td>';
      h += '<td><button class="btn-del" onclick="removeEntry(\'' + e.fid + '\')">X</button></td>';
      h += '</tr>';
    });
    tbody.innerHTML = h;
    updateStats();
  }

  function updateStats() {
    document.getElementById('statUnique').textContent = cards.length;
    document.getElementById('statTotal').textContent = cards.reduce(function(s,e){return s+(e.qty||0);},0);
  }

  // Export
  window.exportCSV = function() {
    if (!cards.length) { toast('Nothing to export!'); return; }
    var h = ['Card Name','Type','Attribute','Archetype','ATK','DEF','Set Name','Card Number','Rarity','Edition','Condition','Qty','Total','Notes'].join(',');
    var rows = cards.map(function(e) {
      return [e.name,e.type,e.attribute||'—',e.archetype,e.atk,e.def,e.setName,e.cardNumber||e.setCode||'—',e.rarity,e.edition,e.condition,e.qty,((e.qty||0)*(e.price||0)).toFixed(2),e.notes]
        .map(function(v){return '"'+String(v||'').replace(/"/g,'""')+'"';}).join(',');
    });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([[h].concat(rows).join('\r\n')],{type:'text/csv'}));
    a.download = 'yugioh_collection.csv'; a.click();
    toast('CSV exported!');
  };

  // Test API
  window.testAPI = function() {
    var el = document.getElementById('testResult');
    el.textContent = 'Testing...';
    el.style.color = 'var(--gold)';
    fetch('https://db.ygoprodeck.com/api/v7/cardinfo.php?fname=Dark+Magician')
      .then(function(r){return r.json();})
      .then(function(d){
        if (d.data && d.data.length) { el.textContent = 'Connected! Got '+d.data.length+' results.'; el.style.color='#4ade80'; }
        else { el.textContent = 'No data returned.'; el.style.color='#fcd34d'; }
      })
      .catch(function(e){ el.textContent = 'Error: '+e.message; el.style.color='#f87171'; });
  };

  // Helpers
  function dotClass(type) {
    if (!type) return 'dm';
    var t = type.toLowerCase();
    if (t.indexOf('spell') !== -1) return 'ds';
    if (t.indexOf('trap')  !== -1) return 'dt';
    if (t.indexOf('fusion')  !== -1) return 'd-fusion';
    if (t.indexOf('synchro') !== -1) return 'd-synchro';
    if (t.indexOf('xyz')     !== -1) return 'd-xyz';
    if (t.indexOf('link')    !== -1) return 'd-link';
    if (t.indexOf('ritual')  !== -1) return 'd-ritual';
    if (t.indexOf('pendulum') !== -1) return 'd-pendulum';
    if (t.indexOf('effect')  !== -1) return 'd-effect';
    if (t.indexOf('normal')  !== -1) return 'd-normal';
    return 'dm';
  }

  function attrBadge(attr) {
    if (!attr || attr === '—') return '<span style="color:var(--silver-dim)">—</span>';
    var colors = {
      'DARK':  '#c084fc', 'LIGHT': '#fde68a', 'EARTH': '#a8955a',
      'FIRE':  '#f87171', 'WATER': '#60a5fa', 'WIND':  '#4ade80', 'DIVINE': '#fcd34d'
    };
    var c = colors[attr.toUpperCase()] || 'var(--silver)';
    return '<span style="font-family:Cinzel,serif;font-size:9px;letter-spacing:1px;color:' + c + ';border:1px solid ' + c + '33;background:' + c + '11;padding:2px 7px;border-radius:4px;text-transform:uppercase">' + esc(attr) + '</span>';
  }

  function tLabel(type) {
    if (!type) return {t:'Unknown',c:'bm'};
    var t = type.toLowerCase();
    if (t.indexOf('spell')!==-1) return {t:'Spell',c:'bs'};
    if (t.indexOf('trap')!==-1)  return {t:'Trap',c:'bt'};
    return {t:'Monster',c:'bm'};
  }

  function cClass(c) {
    return {'Mint':'c0','Near Mint':'c1','Lightly Played':'c2','Moderately Played':'c3','Heavily Played':'c4','Damaged':'c5'}[c]||'c1';
  }

  function rClass(r) {
    if (!r) return 'rc';
    var rl = r.toLowerCase();
    if (rl.indexOf('secret')!==-1||rl.indexOf('starlight')!==-1||rl.indexOf('ghost')!==-1||rl.indexOf('quarter')!==-1) return 'rs';
    if (rl.indexOf('ultra')!==-1) return 'ru';
    if (rl.indexOf('super')!==-1) return 'rr2';
    if (rl==='rare') return 'rr1';
    return 'rc';
  }

  function toast(msg) {
    var t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(function(){t.classList.remove('show');}, 2800);
  }

  function esc(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

});
</script>
</body>
</html>
