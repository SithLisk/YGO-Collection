<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yu-Gi-Oh! Collection Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --void: #080404;
  --deep: #1a0505;
  --mid: #3d0a0a;
  --bright: #8b1a1a;
  --accent: #c0392b;
  --gold: #f0c040;
  --gold-dim: #b8901a;
  --gold-pale: #fde68a;
  --silver: #c8c0d8;
  --silver-dim: #6b5f7a;
  --white: #f5f0ff;
  --border: rgba(180,40,40,0.35);
  --glow: 0 0 20px rgba(160,30,30,0.4);
}
/* ── Theme: Dusk (Midnight Blue) ───────────────────────────────
   Background: #03060f  Contrast ratios (WCAG AA):
   --gold #7ec8f0 on #03060f  = 8.3:1 ✓
   --white #eef3ff on #03060f = 14.2:1 ✓
   --silver #b8cce0 on #03060f= 7.1:1 ✓
─────────────────────────────────────────────────────────────── */
[data-theme="dusk"] {
  --void: #03060f;
  --deep: #060e20;
  --mid: #0d1e40;
  --bright: #1a3a7a;
  --accent: #2d6be0;
  --gold: #7ec8f0;
  --gold-dim: #3a8ab8;
  --gold-pale: #c0e4f8;
  --silver: #b8cce0;
  --silver-dim: #5a7898;
  --white: #eef3ff;
  --border: rgba(50,100,200,0.4);
  --glow: 0 0 20px rgba(30,70,180,0.5);
}
/* Dusk: bg image stays, content boxes shift to navy */

/* ── Theme: Obsidian (Deep Teal/Green) ─────────────────────────
   Background: #020c0a  Contrast ratios (WCAG AA):
   --gold #5de8a8 on #020c0a  = 9.1:1 ✓
   --white #edfff6 on #020c0a = 15.1:1 ✓
   --silver #a8d4b8 on #020c0a= 7.4:1 ✓
─────────────────────────────────────────────────────────────── */
[data-theme="void"] {
  --void: #020c0a;
  --deep: #051a12;
  --mid: #0a3828;
  --bright: #186040;
  --accent: #1a9e60;
  --gold: #5de8a8;
  --gold-dim: #1a9058;
  --gold-pale: #aaf4d0;
  --silver: #a8d4b8;
  --silver-dim: #4a7860;
  --white: #edfff6;
  --border: rgba(40,160,90,0.38);
  --glow: 0 0 20px rgba(25,130,70,0.5);
}
/* Obsidian: bg image stays, content boxes shift to teal */

/* ── Theme: Radiance (White & Gold) ────────────────────────
   Background: #f8f6f0  Contrast ratios (WCAG AA):
   --gold #b8860b on #f8f6f0  = 5.2:1 ✓
   --deep #2a2416 on #f8f6f0 = 13.5:1 ✓
   --mid #4a3d28 on #f8f6f0 = 8.8:1 ✓
─────────────────────────────────────────────────────────────── */
[data-theme="radiance"] {
  --void: #f8f6f0;
  --deep: #2a2416;
  --mid: #4a3d28;
  --bright: #7a6940;
  --accent: #b8860b;
  --gold: #d4af37;
  --gold-dim: #b8860b;
  --gold-pale: #f4e4b8;
  --silver: #6a5d48;
  --silver-dim: #8a7d68;
  --white: #2a2416;
  --border: rgba(212,175,55,0.4);
  --glow: 0 0 20px rgba(212,175,55,0.3);
}
/* Radiance: bg image stays, light content boxes with gold accents */

/* ── Theme: Dark (Pure Black & White Glow) ─────────────────────
   Background: #000000  Contrast ratios (WCAG AA):
   --gold #e0e0e0 on #000000  = 13.5:1 ✓
   --white #f5f5f5 on #000000 = 18.5:1 ✓
   --silver #b0b0b0 on #000000= 10.2:1 ✓
─────────────────────────────────────────────────────────────── */
[data-theme="dark"] {
  --void: #000000;
  --deep: #0a0a0a;
  --mid: #151515;
  --bright: #202020;
  --accent: #d0d0d0;
  --gold: #e0e0e0;
  --gold-dim: #b0b0b0;
  --gold-pale: #f0f0f0;
  --silver: #b0b0b0;
  --silver-dim: #707070;
  --white: #f5f5f5;
  --border: rgba(224,224,224,0.25);
  --glow: 0 0 16px rgba(240,240,240,0.25);
}
/* Dark: pure black background with subtle white glow */

.theme-select { font-family:'Cinzel',serif; font-size:9px; letter-spacing:1px; background:rgba(0,0,0,0.5); border:1px solid var(--border); border-radius:6px; color:var(--gold); padding:4px 8px; cursor:pointer; outline:none; transition:border-color 0.2s; }
.theme-select option { background:#060606; color:#f0c040; text-align:left; }

/* ── Dusk theme: content boxes → navy ───────────────────── */
[data-theme="dusk"] .coll-panel,
[data-theme="dusk"] .deck-section,
[data-theme="dusk"] #pwModal > div,
[data-theme="dusk"] #newProfileModal > div,
[data-theme="dusk"] #cardModal > div,
[data-theme="dusk"] .saved-deck-card { background: rgba(6,14,32,0.92); }
[data-theme="dusk"] .panel-hdr,
[data-theme="dusk"] .deck-hdr { background: rgba(3,8,20,0.95); border-bottom-color: rgba(50,100,200,0.3); }
[data-theme="dusk"] .deck-zone { background: rgba(6,14,32,0.6); border-color: rgba(50,100,200,0.2); }
[data-theme="dusk"] #profileScreen > div:first-child { background: rgba(3,6,15,0.97); }
[data-theme="dusk"] .ps-card { background: linear-gradient(160deg,rgba(6,14,32,0.9),rgba(3,8,20,0.95)); }
[data-theme="dusk"] .tab-nav { background: rgba(3,8,20,0.95); border-bottom-color: rgba(50,100,200,0.25); }

/* ── Obsidian theme: content boxes → deep teal ──────────── */
[data-theme="void"] .coll-panel,
[data-theme="void"] .deck-section,
[data-theme="void"] #pwModal > div,
[data-theme="void"] #newProfileModal > div,
[data-theme="void"] #cardModal > div,
[data-theme="void"] .saved-deck-card { background: rgba(5,20,14,0.92); }
[data-theme="void"] .panel-hdr,
[data-theme="void"] .deck-hdr { background: rgba(2,12,8,0.95); border-bottom-color: rgba(40,160,90,0.3); }
[data-theme="void"] .deck-zone { background: rgba(5,20,14,0.6); border-color: rgba(40,160,90,0.2); }
[data-theme="void"] #profileScreen > div:first-child { background: rgba(2,8,5,0.97); }
[data-theme="void"] .ps-card { background: linear-gradient(160deg,rgba(5,20,14,0.9),rgba(2,12,8,0.95)); }
[data-theme="void"] .tab-nav { background: rgba(2,12,8,0.95); border-bottom-color: rgba(40,160,90,0.25); }

/* ── Radiance theme: content boxes → light with gold ──────────── */
[data-theme="radiance"] .coll-panel,
[data-theme="radiance"] .deck-section,
[data-theme="radiance"] #pwModal > div,
[data-theme="radiance"] #newProfileModal > div,
[data-theme="radiance"] #cardModal > div,
[data-theme="radiance"] .saved-deck-card { background: rgb(248,246,240); }
[data-theme="radiance"] .panel-hdr,
[data-theme="radiance"] .deck-hdr { background: rgb(255,253,245); border-bottom-color: rgba(212,175,55,0.3); }
[data-theme="radiance"] .deck-zone { background: rgb(252,250,242); border-color: rgba(212,175,55,0.2); }
[data-theme="radiance"] #profileScreen > div:first-child { background: rgb(252,250,242); }
[data-theme="radiance"] .ps-card { background: linear-gradient(160deg,rgb(248,246,240),rgb(255,253,245)); }
[data-theme="radiance"] .ps-label { color: #2a2416; }
[data-theme="radiance"] .ps-meta { color: #6a5d48; }
[data-theme="radiance"] .tab-nav { background: rgb(255,253,245); border-bottom-color: rgba(212,175,55,0.25); }
[data-theme="radiance"] #cardModal > div { background: rgb(248,246,240); border-color: rgba(212,175,55,0.4); }
[data-theme="radiance"] #cardModal #modalName { color: #2a2416; }
[data-theme="radiance"] #cardModal #modalEffect { color: #4a3d28; border-left-color: rgba(212,175,55,0.4); }
[data-theme="radiance"] #cardModal #modalAtkDef { color: #6a5d48; }
[data-theme="radiance"] #cardModal #modalSet { color: #8a7d68; }

/* ── Dark theme: content boxes → pure black with white glow ──────────── */
[data-theme="dark"] .coll-panel,
[data-theme="dark"] .deck-section,
[data-theme="dark"] #pwModal > div,
[data-theme="dark"] #newProfileModal > div,
[data-theme="dark"] #cardModal > div,
[data-theme="dark"] .saved-deck-card { background: rgba(10,10,10,0.95); }
[data-theme="dark"] .panel-hdr,
[data-theme="dark"] .deck-hdr { background: rgba(0,0,0,0.98); border-bottom-color: rgba(224,224,224,0.25); }
[data-theme="dark"] .deck-zone { background: rgba(10,10,10,0.7); border-color: rgba(224,224,224,0.25); }
[data-theme="dark"] #profileScreen > div:first-child { background: rgba(0,0,0,0.98); }
[data-theme="dark"] .ps-card { background: linear-gradient(160deg,rgba(10,10,10,0.9),rgba(0,0,0,0.95)); }
[data-theme="dark"] .tab-nav { background: rgba(0,0,0,0.98); border-bottom-color: rgba(224,224,224,0.25); }
[data-theme="dark"] #cardModal #modalName { color: #f5f5f5; }
[data-theme="dark"] #cardModal #modalEffect { color: #e0e0e0; border-left-color: rgba(224,224,224,0.25); }
[data-theme="dark"] #cardModal #modalAtkDef { color: #e0e0e0; }
[data-theme="dark"] #cardModal #modalSet { color: #b0b0b0; }

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--void);
  color: var(--white);
  font-family: 'Crimson Pro', Georgia, serif;
  min-height: 100vh;
  overflow-x: hidden;
  width: 100%;
}
.page-bg {
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background-image: url('https://raw.githubusercontent.com/SithLisk/YGO-Collection/main/YGO.webp');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  opacity: 0.18;
}
body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 1;
  background: radial-gradient(ellipse 80% 50% at 50% -10%, rgba(160,30,30,0.25) 0%, transparent 60%),
              radial-gradient(ellipse 40% 30% at 80% 80%, rgba(120,15,15,0.15) 0%, transparent 50%);
}
.stars {
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background-image:
    radial-gradient(1px 1px at 15% 20%, rgba(255,255,255,0.6) 0%, transparent 100%),
    radial-gradient(1px 1px at 35% 8%, rgba(255,255,255,0.4) 0%, transparent 100%),
    radial-gradient(1px 1px at 60% 35%, rgba(255,255,255,0.5) 0%, transparent 100%),
    radial-gradient(1px 1px at 80% 15%, rgba(255,255,255,0.3) 0%, transparent 100%),
    radial-gradient(1.5px 1.5px at 50% 80%, rgba(240,192,64,0.5) 0%, transparent 100%);
}
.wrap { position: relative; z-index: 1; width: 75%; margin: 0 auto; padding: 0 24px 60px; }

header { text-align: center; padding: 48px 0 32px; border-bottom: 1px solid var(--border); margin-bottom: 32px; position: relative; background: var(--void); }
header::after { content: ''; position: absolute; bottom: -1px; left: 50%; transform: translateX(-50%); width: 200px; height: 2px; background: linear-gradient(90deg, transparent, var(--gold), transparent); }
.eyebrow { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 6px; color: var(--gold-dim); text-transform: uppercase; margin-bottom: 12px; }
h1 { font-family: 'Cinzel Decorative', serif; font-size: clamp(22px,4vw,38px); font-weight: 700; background: linear-gradient(135deg, var(--gold-pale), var(--gold) 40%, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1.2; margin-bottom: 8px; }
.subtitle { font-size: 15px; color: var(--silver-dim); font-style: italic; }

.sync-bar { display: flex; align-items: center; justify-content: space-between; background: var(--deep); border: 1px solid var(--border); border-radius: 10px; padding: 10px 20px; margin-bottom: 20px; font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; flex-wrap: wrap; gap: 10px; }
.sync-row { display: flex; align-items: center; gap: 8px; }
.sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--silver-dim); transition: all 0.3s; }
.sync-dot.syncing { background: var(--gold); box-shadow: 0 0 8px var(--gold); animation: pulse 1s infinite; }
.sync-dot.synced  { background: #4ade80; box-shadow: 0 0 8px #4ade80; }
.sync-dot.error   { background: #f87171; box-shadow: 0 0 8px #f87171; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
#syncLabel { color: var(--silver-dim); }
#syncLabel.synced  { color: #4ade80; }
#syncLabel.syncing { color: var(--gold); }
#syncLabel.error   { color: #f87171; }

.search-panel { background: linear-gradient(135deg, var(--deep), var(--void)); border: 1px solid var(--border); border-radius: 16px; padding: 28px 32px; margin-bottom: 28px; box-shadow: var(--glow); position: relative; }
.search-panel::before { content: '\2B21'; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); font-size: 20px; color: var(--gold); background: var(--void); padding: 0 8px; }
.sec-label { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 4px; color: var(--accent); text-transform: uppercase; margin-bottom: 14px; }

.test-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
.btn-test { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; background: rgba(0,0,0,0.3); color: var(--gold-pale); border: 1px solid var(--border); border-radius: 6px; padding: 6px 14px; cursor: pointer; transition: background 0.2s; }
.btn-test:hover { background: rgba(0,0,0,0.5); }
#testResult { font-size: 13px; font-style: italic; color: var(--silver-dim); }

.search-row { display: flex; gap: 12px; align-items: center; }
.search-wrap { flex: 1; position: relative; }
input[type="text"] { width: 100%; background: rgba(0,0,0,0.45); border: 1px solid var(--border); border-radius: 10px; color: var(--white); font-family: 'Crimson Pro', serif; font-size: 17px; padding: 13px 18px; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
input[type="text"]:focus { border-color: var(--gold-dim); box-shadow: 0 0 0 3px rgba(0,0,0,0.2); outline: 2px solid var(--gold-dim); outline-offset: -2px; }
input[type="text"]::placeholder { color: var(--silver-dim); }
.status-msg { font-size: 13px; font-style: italic; color: var(--silver-dim); min-width: 100px; }

.ac-list { position: absolute; top: calc(100% + 6px); left: 0; right: 0; background: rgba(20,5,5,0.98); border: 1px solid var(--border); border-radius: 10px; max-height: 280px; overflow-y: auto; z-index: 100; box-shadow: 0 8px 32px rgba(0,0,0,0.6); display: none; }
.ac-list.open { display: block; }
.ac-item { padding: 10px 16px; cursor: pointer; font-size: 15px; border-bottom: 1px solid rgba(180,40,40,0.12); display: flex; justify-content: space-between; align-items: center; transition: background 0.15s; }
.ac-item:last-child { border-bottom: none; }
.ac-item:hover, .ac-item.hi { background: rgba(160,30,30,0.25); }
.tbadge { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 1px; padding: 2px 7px; border-radius: 4px; text-transform: uppercase; flex-shrink: 0; }
.bm { background: rgba(200,100,30,0.3); color: #f4a261; border: 1px solid rgba(200,100,30,0.4); }
.bs { background: rgba(20,138,138,0.3); color: #4ecdc4; border: 1px solid rgba(20,138,138,0.4); }
.bt { background: rgba(155,32,96,0.3); color: #f48fb1; border: 1px solid rgba(155,32,96,0.4); }

.card-preview { display: none; margin-top: 28px; border-top: 1px solid var(--border); padding-top: 24px; animation: fadeUp 0.3s ease; }
.card-preview.open { display: block; }
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.preview-grid { display: grid; grid-template-columns: 180px 1fr; gap: 24px; align-items: start; }
@media(max-width:640px){ .preview-grid { grid-template-columns: 1fr; } }
.img-wrap { border-radius: 10px; overflow: hidden; box-shadow: 0 4px 24px rgba(0,0,0,0.6), 0 0 20px rgba(240,192,64,0.4); border: 1px solid rgba(240,192,64,0.3); background: var(--deep); aspect-ratio: 59/86; display: flex; align-items: center; justify-content: center; }
.img-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }
.img-ph { font-size: 48px; opacity: 0.3; }
.card-info { display: flex; flex-direction: column; gap: 12px; }
.card-name { font-family: 'Cinzel', serif; font-size: 20px; font-weight: 700; color: var(--gold-pale); line-height: 1.2; }
.card-meta { display: flex; flex-wrap: wrap; gap: 8px; }
.mpill { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 1.5px; padding: 3px 10px; border-radius: 20px; text-transform: uppercase; border: 1px solid; }
.pm { color: #f4a261; border-color: rgba(244,162,97,0.4); background: rgba(244,162,97,0.08); }
.ps { color: #4ecdc4; border-color: rgba(78,205,196,0.4); background: rgba(78,205,196,0.08); }
.pt { color: #f48fb1; border-color: rgba(244,143,177,0.4); background: rgba(244,143,177,0.08); }
.pa { color: var(--accent); border-color: rgba(192,57,43,0.4); background: rgba(192,57,43,0.08); }
.atk-def { font-family: 'Cinzel', serif; font-size: 13px; color: var(--silver); letter-spacing: 2px; }
.atk-def b { color: var(--gold); }
.card-eff { font-size: 13.5px; color: var(--silver); line-height: 1.7; font-style: italic; border-left: 2px solid rgba(192,57,43,0.4); padding-left: 12px; max-height: 120px; overflow-y: auto; }
.card-set { font-size: 13px; color: var(--silver-dim); }
.card-set strong { color: var(--silver); }

.entry-form { display: none; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px; gap: 16px; flex-wrap: wrap; }
.entry-form.open { display: flex; }
.field { display: flex; flex-direction: column; gap: 6px; }
.field label { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--silver-dim); }
.field select, .field input { background: rgba(0,0,0,0.35); border: 1px solid var(--border); border-radius: 8px; color: var(--white); font-family: 'Crimson Pro', serif; font-size: 15px; padding: 9px 12px; outline: none; transition: border-color 0.2s; width: 100%; }
.field select:focus, .field input:focus { border-color: var(--accent); }
.field select option { background: #1a0505; }

.btn { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 3px; text-transform: uppercase; border: none; border-radius: 8px; padding: 11px 24px; cursor: pointer; transition: all 0.2s; align-self: flex-end; }
.btn-add  { background: linear-gradient(135deg, var(--bright), var(--accent)); color: var(--white); box-shadow: 0 4px 16px rgba(139,26,26,0.4); }
.btn-add:hover  { transform: translateY(-1px); }
.btn-gold { background: linear-gradient(135deg, var(--gold-dim), var(--gold)); color: var(--void); }
.btn-gold:hover { transform: translateY(-1px); }
.btn-del { font-family: 'Cinzel', serif; font-size: 10px; background: rgba(192,57,43,0.2); color: #e07070; border: 1px solid rgba(192,57,43,0.3); border-radius: 6px; padding: 7px 14px; cursor: pointer; transition: background 0.2s; }
.btn-del:hover { background: rgba(192,57,43,0.4); }

.coll-panel { background: linear-gradient(135deg, var(--deep), var(--void)); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; box-shadow: var(--glow); width: 100%; box-sizing: border-box; }
.panel-hdr { display: flex; justify-content: space-between; align-items: center; padding: 20px 28px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.25); flex-wrap: wrap; gap: 12px; }
.panel-ttl { font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 3px; color: var(--gold); text-transform: uppercase; }
.stats-row { display: flex; gap: 24px; }
.stat { text-align: center; }
.stat-n { font-family: 'Cinzel Decorative', serif; font-size: 18px; color: var(--gold-pale); display: block; }
.stat-l { font-family: 'Cinzel', serif; font-size: 8px; letter-spacing: 2px; color: var(--silver-dim); text-transform: uppercase; }
.tbl-wrap { overflow-x: auto; width: 100%; }
table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: auto; }
thead th { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 0; text-transform: uppercase; color: var(--silver-dim); padding: 8px 8px; text-align: left; border-bottom: 1px solid var(--border); overflow: hidden; text-overflow: ellipsis; background: rgba(10,2,2,0.4); }
tbody tr { border-bottom: 1px solid rgba(180,40,40,0.1); transition: background 0.15s; }
tbody tr:hover { background: rgba(160,30,30,0.08); }
tbody tr:last-child { border-bottom: none; }
td { padding: 7px 8px; vertical-align: middle; color: var(--silver); white-space: nowrap; }
.td-nm { font-size: 15px; font-weight: 600; color: var(--white); }
.dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
.dm         { background: #f4a261; }  /* generic monster - orange */
.d-effect   { background: #f97316; }  /* effect monster - deep orange */
.d-normal   { background: #fbbf24; }  /* normal monster - gold */
.d-fusion   { background: #a855f7; }  /* fusion - purple */
.d-synchro  { background: #e2e8f0; }  /* synchro - white */
.d-xyz      { background: #1e1e1e; box-shadow: 0 0 4px #666; }  /* xyz - black */
.d-link     { background: #3b82f6; }  /* link - blue */
.d-ritual   { background: #818cf8; }  /* ritual - indigo */
.d-pendulum { background: #10b981; }  /* pendulum - teal-green */
.ds         { background: #4ecdc4; }  /* spell - teal */
.dt         { background: #f48fb1; }  /* trap - pink */
.td-pr { font-family: 'Cinzel', serif; font-size: 12px; color: var(--gold); }
.td-qt { font-family: 'Cinzel Decorative', serif; font-size: 15px; color: var(--gold-pale); text-align: center; }
.td-sm { font-size: 12px; color: var(--silver-dim); }
.td-atk { font-family: 'Cinzel', serif; font-size: 11px; }
.cb { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 1px; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; }
.c0 { background: rgba(26,122,58,0.25);  color: #4ade80; border: 1px solid rgba(26,122,58,0.4); }
.c1 { background: rgba(30,107,184,0.25); color: #60a5fa; border: 1px solid rgba(30,107,184,0.4); }
.c2 { background: rgba(240,192,64,0.2);  color: #fcd34d; border: 1px solid rgba(240,192,64,0.3); }
.c3 { background: rgba(224,123,57,0.2);  color: #fb923c; border: 1px solid rgba(224,123,57,0.3); }
.c4 { background: rgba(192,57,43,0.2);   color: #f87171; border: 1px solid rgba(192,57,43,0.3); }
.c5 { background: rgba(100,20,20,0.3);   color: #ef4444; border: 1px solid rgba(192,57,43,0.5); }
.rs { color: #e879f9; }
.ru { color: #fcd34d; }
.rr2 { color: #c4b5fd; }
.rr1 { color: #93c5fd; }
.rc { color: var(--silver-dim); }
.rtxt { font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 1px; }
.empty-st { text-align: center; padding: 60px 24px; color: var(--silver-dim); }
.empty-ic { font-size: 48px; margin-bottom: 16px; opacity: 0.4; }
.empty-tx { font-family: 'Cinzel', serif; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; }
.exp-bar { padding: 16px 28px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; background: rgba(0,0,0,0.2); }
.spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(160,30,30,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; }
@keyframes spin { to { transform: rotate(360deg); } }
.sortable { cursor: pointer; user-select: none; white-space: nowrap; }
.sortable:hover { color: var(--gold-pale); }
.sort-icon { font-size: 8px; margin-left: 4px; opacity: 0.5; }
.sort-icon.asc::after  { content: ' ▲'; opacity: 1; color: var(--gold); }
.sort-icon.desc::after { content: ' ▼'; opacity: 1; color: var(--gold); }
.ps-card { position:relative; width:160px; background:linear-gradient(160deg,rgba(0,0,0,0.55),rgba(0,0,0,0.75)); border:1px solid rgba(240,192,64,0.15); border-radius:16px; padding:24px 16px 20px; text-align:center; cursor:pointer; transition:transform 0.2s, border-color 0.2s, box-shadow 0.2s; flex-shrink:0; }
.ps-card:hover { transform:translateY(-4px); border-color:rgba(240,192,64,0.45); box-shadow:0 12px 32px rgba(0,0,0,0.5),0 0 20px rgba(160,30,30,0.25); }
.ps-card.ps-new { border-style:dashed; border-color:rgba(180,40,40,0.25); }
.ps-card.ps-new:hover { border-color:rgba(240,192,64,0.35); }
.ps-avatar { width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg,rgba(160,30,30,0.5),rgba(60,8,8,0.8)); border:2px solid rgba(240,192,64,0.25); display:flex; align-items:center; justify-content:center; font-family:'Cinzel Decorative',serif; font-size:24px; color:var(--gold-pale); margin:0 auto 14px; transition:border-color 0.2s; }
.ps-card:hover .ps-avatar { border-color:rgba(240,192,64,0.5); }
.ps-label { font-family:'Cinzel',serif; font-size:12px; letter-spacing:2px; color:var(--gold-pale); text-transform:uppercase; margin-bottom:6px; }
.ps-meta { font-size:11px; color:var(--silver-dim); }
.ps-del { position:absolute; top:8px; right:8px; background:none; border:none; color:rgba(248,113,113,0.3); cursor:pointer; font-size:13px; padding:3px 5px; border-radius:4px; transition:color 0.15s,background 0.15s; opacity:0; }
.ps-card:hover .ps-del { opacity:1; }
.ps-del:hover { color:#f87171; background:rgba(248,113,113,0.1); }
.tab-nav { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
.tab-btn { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 2px; text-transform: uppercase; padding: 12px 28px; background: none; border: none; color: var(--silver-dim); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: color 0.2s, border-color 0.2s; }
.tab-btn:hover { color: var(--gold-pale); }
.tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); }
.tab-pane { display: none; }
.tab-pane.active { display: block; }
.saved-decks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; padding: 20px 0; }
.saved-deck-card { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 18px 20px; cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s; position: relative; }
.saved-deck-card:hover { border-color: rgba(240,192,64,0.4); box-shadow: 0 0 16px rgba(160,30,30,0.3); }
.saved-deck-name { font-family: 'Cinzel', serif; font-size: 14px; color: var(--gold-pale); margin-bottom: 8px; letter-spacing: 1px; }
.saved-deck-meta { font-size: 12px; color: var(--silver-dim); display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 10px; }
.saved-deck-meta span { display: flex; align-items: center; gap: 4px; }
.saved-deck-date { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 1px; color: var(--silver-dim); margin-top: 4px; }
.saved-deck-actions { display: flex; gap: 6px; margin-top: 12px; flex-wrap: wrap; }
.deck-action-btn { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; border-radius: 6px; padding: 7px 0; cursor: pointer; transition: all 0.2s; flex: 1; min-width: 80px; text-align: center; border: 1px solid var(--border); }
.deck-action-btn.load { background: linear-gradient(135deg, var(--gold-dim), var(--gold)); color: var(--void); border-color: transparent; }
.deck-action-btn.load:hover { opacity: 0.85; }
.deck-action-btn.export { background: rgba(0,0,0,0.2); color: var(--silver); }
.deck-action-btn.export:hover { background: rgba(0,0,0,0.35); }
.deck-action-btn.del { background: rgba(0,0,0,0.15); color: #f87171; border-color: rgba(248,113,113,0.3); }
.deck-action-btn.del:hover { background: rgba(248,113,113,0.12); }
.deck-card-list-section { margin-top: 14px; border-top: 1px solid var(--border); padding-top: 12px; }
.deck-card-list-section-label { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 2px; color: var(--gold-dim); text-transform: uppercase; margin-bottom: 6px; }
.deck-card-list-item { font-size: 12px; color: var(--silver); padding: 2px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.03); }
.deck-card-list-item:last-child { border-bottom: none; }
.deck-card-list-item .qty-tag { font-family: 'Cinzel', serif; font-size: 10px; color: var(--gold-dim); flex-shrink: 0; margin-left: 8px; }
.deck-empty { text-align: center; padding: 60px 20px; font-family: 'Cinzel', serif; font-size: 12px; letter-spacing: 2px; color: var(--silver-dim); text-transform: uppercase; }

/* ── Wishlist ──────────────────────────────────────────────── */
.wishlist-card { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 16px; transition: border-color 0.2s, box-shadow 0.2s; }
.wishlist-card:hover { border-color: rgba(240,192,64,0.4); box-shadow: 0 0 16px rgba(160,30,30,0.3); }

/* ── Statistics ─────────────────────────────────────────────── */
.stat-card { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 20px; text-align: center; }
.stat-card-value { font-family: 'Cinzel', serif; font-size: 36px; font-weight: 700; color: var(--gold); margin-bottom: 8px; }
.stat-card-label { font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 2px; color: var(--silver-dim); text-transform: uppercase; }
.chart-container { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
.chart-title { font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 2px; color: var(--gold-pale); text-transform: uppercase; margin-bottom: 16px; text-align: center; }
.stat-table-container { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
.stat-table-title { font-family: 'Cinzel', serif; font-size: 12px; letter-spacing: 2px; color: var(--gold-pale); text-transform: uppercase; margin-bottom: 12px; }
.stat-table { font-size: 13px; line-height: 1.8; }
.stat-table-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(180,40,40,0.15); }
.stat-table-row:last-child { border-bottom: none; }
.stat-table-label { color: var(--silver); }
.stat-table-value { color: var(--gold); font-family: 'Cinzel', serif; font-weight: 600; }

/* ── Deck Suggestions ──────────────────────────────────────── */
.suggestions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 18px; padding: 20px 0; }
.suggestion-card { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: border-color 0.2s, box-shadow 0.2s; }
.suggestion-card:hover { border-color: rgba(240,192,64,0.4); box-shadow: 0 0 16px rgba(160,30,30,0.3); }
.suggestion-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
.suggestion-name { font-family: 'Cinzel', serif; font-size: 15px; color: var(--gold-pale); letter-spacing: 1px; flex: 1; }
.suggestion-match { font-family: 'Cinzel', serif; font-size: 20px; font-weight: 700; color: var(--gold); }
.suggestion-match-label { font-size: 9px; color: var(--silver-dim); letter-spacing: 1px; text-transform: uppercase; }
.suggestion-info { font-size: 11px; color: var(--silver-dim); margin-bottom: 14px; }
.suggestion-meta { display: flex; gap: 16px; margin-bottom: 14px; font-size: 11px; }
.suggestion-meta-item { display: flex; flex-direction: column; gap: 2px; }
.suggestion-meta-label { color: var(--silver-dim); font-size: 9px; letter-spacing: 1px; text-transform: uppercase; }
.suggestion-meta-value { color: var(--gold-pale); font-family: 'Cinzel', serif; font-weight: 600; }
.suggestion-missing { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
.suggestion-missing-label { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 2px; color: var(--accent); text-transform: uppercase; margin-bottom: 6px; }
.suggestion-missing-list { font-size: 11px; color: var(--silver); max-height: 80px; overflow-y: auto; }
.suggestion-missing-item { padding: 2px 0; }
.suggestion-actions { display: flex; gap: 8px; margin-top: 14px; }
.suggestion-btn { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; border-radius: 6px; padding: 8px 0; cursor: pointer; transition: all 0.2s; flex: 1; text-align: center; border: 1px solid var(--border); }
.suggestion-btn.view { background: linear-gradient(135deg, var(--gold-dim), var(--gold)); color: var(--void); border-color: transparent; }
.suggestion-btn.view:hover { opacity: 0.85; }

/* ── Deck Detail Modal ────────────────────────────────────── */
.deck-detail-zone { margin-bottom: 28px; }
.deck-detail-zone:last-child { margin-bottom: 0; }
.deck-detail-zone-header { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--gold); margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
.deck-detail-breakdown { display: flex; gap: 20px; font-size: 12px; color: var(--silver); margin-bottom: 14px; flex-wrap: wrap; }
.deck-detail-breakdown .breakdown-item { display: flex; align-items: center; gap: 6px; }
.deck-detail-breakdown .breakdown-label { color: var(--silver-dim); }
.deck-detail-breakdown b { color: var(--gold-pale); font-family: 'Cinzel', serif; }
.deck-detail-type-header { font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--silver); margin-top: 20px; margin-bottom: 10px; padding-left: 4px; border-left: 3px solid var(--gold-dim); }
.deck-detail-subtype-header { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--silver-dim); margin-top: 16px; margin-bottom: 8px; padding-left: 8px; font-style: italic; }
.deck-detail-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 12px; }
@media(max-width:768px) { .deck-detail-cards { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; } }
.deck-detail-card { position: relative; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border-radius: 8px; overflow: hidden; }
.deck-detail-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(240,192,64,0.4); }
.deck-detail-card-img { width: 100%; aspect-ratio: 59/86; object-fit: cover; display: block; border-radius: 8px; border: 1px solid var(--border); background: var(--deep); }
.deck-detail-card-qty { position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.85); color: var(--gold-pale); font-family: 'Cinzel', serif; font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 6px; border: 1px solid var(--border); }
.deck-detail-card-name { font-size: 11px; color: var(--silver); text-align: center; margin-top: 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.coll-filter-opt { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 2px; text-transform: uppercase; padding: 10px 16px; cursor: pointer; color: var(--silver); transition: background 0.15s, color 0.15s; border-bottom: 1px solid rgba(180,40,40,0.12); }
.coll-filter-opt:last-child { border-bottom: none; }
.coll-filter-opt:hover { background: rgba(160,30,30,0.25); color: var(--gold-pale); }
.coll-filter-opt.active { color: var(--gold); background: rgba(160,30,30,0.15); }
.card-link { cursor: pointer; border-bottom: 1px dotted rgba(240,192,64,0.4); transition: color 0.15s, border-color 0.15s; }
.card-link:hover { color: var(--gold-pale); border-bottom-color: var(--gold); }
.td-thumb { width: 32px; padding: 4px 6px; }
.td-thumb img { width: 28px; height: 40px; object-fit: cover; border-radius: 3px; display: block; border: 1px solid rgba(240,192,64,0.2); cursor: pointer; transition: transform 0.15s; }
.thumb-img { width: 28px; height: 40px; object-fit: cover; border-radius: 3px; border: 1px solid rgba(240,192,64,0.2); cursor: pointer; transition: transform 0.15s; }
.thumb-img:hover { transform: scale(1.08); }
.td-thumb img:hover { transform: scale(1.08); }
.qty-ctrl { display: flex; align-items: center; gap: 4px; justify-content: center; }
.qty-btn { font-family: 'Cinzel',serif; font-size: 13px; width: 22px; height: 22px; border-radius: 4px; border: 1px solid var(--border); background: rgba(160,30,30,0.2); color: var(--gold-pale); cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; transition: background 0.15s; padding: 0; }
.qty-btn:hover { background: rgba(160,30,30,0.5); }
.qty-val { font-family: 'Cinzel Decorative',serif; font-size: 14px; color: var(--gold-pale); min-width: 18px; text-align: center; }
.rarity-breakdown { display: flex; gap: 14px; flex-wrap: wrap; padding: 12px 28px; border-top: 1px solid var(--border); background: rgba(0,2,2,0.3); align-items: center; }
.rar-stat { display: flex; align-items: center; gap: 6px; font-family: 'Cinzel',serif; font-size: 10px; letter-spacing: 1px; }
.rar-stat-n { font-size: 14px; font-weight: 700; }
.deck-section { background: linear-gradient(135deg, var(--deep), var(--void)); border: 1px solid var(--border); border-radius: 16px; margin-top: 28px; box-shadow: var(--glow); overflow: hidden; }
.deck-hdr { display: flex; justify-content: space-between; align-items: center; padding: 18px 28px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.25); flex-wrap: wrap; gap: 12px; }
.deck-ttl { font-family: 'Cinzel',serif; font-size: 13px; letter-spacing: 3px; color: var(--gold); text-transform: uppercase; }
.deck-zones { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0; }
@media(max-width:700px){ .deck-zones { grid-template-columns: 1fr; } }
.deck-zone { border-right: 1px solid var(--border); min-height: 160px; }
.deck-zone:last-child { border-right: none; }
.deck-zone-hdr { font-family: 'Cinzel',serif; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; padding: 10px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(10,2,2,0.3); }
.deck-zone-count { font-size: 14px; color: var(--gold-pale); }
.deck-zone-count.warn { color: #f87171; }
.deck-zone-count.ok   { color: #4ade80; }
.deck-card-list { padding: 8px; display: flex; flex-direction: column; gap: 4px; min-height: 120px; }
.deck-card-item { display: flex; align-items: center; justify-content: space-between; padding: 5px 8px; background: rgba(160,30,30,0.1); border: 1px solid rgba(180,40,40,0.2); border-radius: 6px; font-size: 13px; gap: 8px; }
.deck-card-item:hover { background: rgba(160,30,30,0.2); }
.deck-card-name { flex: 1; color: var(--silver); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
.deck-card-name:hover { color: var(--gold-pale); }
.deck-card-qty { font-family: 'Cinzel',serif; font-size: 11px; color: var(--gold-dim); white-space: nowrap; }
.deck-card-rm  { background: none; border: none; color: var(--silver-dim); cursor: pointer; font-size: 14px; padding: 0 2px; line-height: 1; }
.deck-card-rm:hover { color: #f87171; }
.deck-drop-target { border: 2px dashed rgba(180,40,40,0.3); border-radius: 6px; padding: 16px; text-align: center; color: var(--silver-dim); font-family: 'Cinzel',serif; font-size: 10px; letter-spacing: 2px; margin: 8px; }
.deck-search-row { padding: 12px 28px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.toast { position: fixed; bottom: 32px; right: 32px; background: rgba(20,5,5,0.98); border: 1px solid var(--accent); border-radius: 10px; padding: 14px 20px; font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 1px; color: var(--gold-pale); box-shadow: var(--glow); transform: translateY(80px); opacity: 0; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1); z-index: 999; }
.toast.show { transform: translateY(0); opacity: 1; }
</style>
</head>
<body>
<div class="page-bg"></div>
<div class="stars"></div>
<div class="wrap">

  <header style="position:relative">
    <div class="bg-overlay" style="position:absolute;inset:0;background:linear-gradient(to bottom, rgba(8,4,4,0.82) 0%, rgba(8,4,4,0.72) 60%, rgba(8,4,4,0.55) 100%);border-radius:0;pointer-events:none;z-index:0"></div>
    <div style="position:relative;z-index:1">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:8px">
    <div class="eyebrow" style="margin-bottom:0">Live API &middot; Cloud Sync &middot; YGOPRODeck</div>
    <div class="active-profile-bar">
      <span>Viewing:</span>
      <span class="active-profile-name" id="activeProfileLabel">—</span>
      <button class="btn-test" onclick="showProfileScreen()" style="padding:4px 12px;font-size:9px">Switch Profile</button>
    </div>
  </div>
  <div class="eyebrow" style="display:none">placeholder</div>
    <h1><span id="headerProfileName">Yu-Gi-Oh!</span><br>Collection Tracker</h1>
    <p class="subtitle">Search. Add. Sort. Enjoy.</p>
    </div>
  </header>

  <div class="sync-bar">
    <div class="sync-row">
      <div class="sync-dot" id="syncDot"></div>
      <span id="syncLabel">Connecting&hellip;</span>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <span style="color:var(--silver-dim);font-size:9px;letter-spacing:1px">Changes sync automatically across all devices</span>
      <select class="theme-select" id="themeSelect" onchange="applyTheme(this.value)" title="Color theme">
        <option value="">Carnation</option>
        <option value="dusk">Dusk</option>
        <option value="void">Void</option>
        <option value="radiance">Radiance</option>
        <option value="dark">Dark</option>

      </select>
      <button class="btn-test" id="lockBtn" onclick="toggleAuth()" style="padding:5px 12px;font-size:9px">&#x1F512; Locked</button>
    </div>
  </div>

  <!-- Profile Selector Screen -->
  <div id="profileScreen" style="display:flex;position:fixed;inset:0;z-index:2000;align-items:center;justify-content:center;overflow-y:auto;padding:40px 20px">
    <!-- Background layers matching page theme -->
    <div style="position:absolute;inset:0;background:rgba(4,1,1,0.96)"></div>
    <div style="position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 10px,rgba(160,30,30,0.03) 10px,rgba(160,30,30,0.03) 20px);pointer-events:none"></div>
    <div style="position:absolute;inset:0;background:radial-gradient(ellipse 80% 50% at 50% 0%,rgba(160,30,30,0.3) 0%,transparent 60%);pointer-events:none"></div>

    <div style="position:relative;z-index:1;text-align:center;width:100%;max-width:780px">
      <!-- Logo / Title -->
      <div style="font-family:'Cinzel',serif;font-size:10px;letter-spacing:6px;color:var(--gold-dim);text-transform:uppercase;margin-bottom:14px">Yu-Gi-Oh! Collection Tracker</div>
      <h1 style="font-family:'Cinzel Decorative',serif;font-size:clamp(20px,4vw,34px);color:var(--gold-pale);letter-spacing:3px;margin-bottom:8px;text-shadow:0 0 30px rgba(240,192,64,0.3)"><span id="profileScreenName">Collection</span></h1>
      <div style="width:120px;height:1px;background:linear-gradient(to right,transparent,var(--gold-dim),transparent);margin:12px auto 20px"></div>
      <p style="font-family:'Cinzel',serif;font-size:10px;letter-spacing:3px;color:var(--silver-dim);text-transform:uppercase;margin-bottom:36px">Select a Profile</p>

      <!-- Profile grid -->
      <div id="profileGrid" style="display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin-bottom:32px"></div>

      <p style="font-size:12px;color:rgba(180,160,160,0.4);font-style:italic">Browse any collection freely &middot; Password required to add or edit cards</p>
    </div>
  </div>

  <!-- New Profile Modal -->
  <div id="newProfileModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:3000;align-items:center;justify-content:center">
    <div style="background:linear-gradient(135deg,rgba(28,5,5,0.98),rgba(10,2,2,0.99));border:1px solid rgba(240,192,64,0.25);border-radius:18px;padding:36px 32px;width:340px;text-align:center;box-shadow:0 0 60px rgba(160,30,30,0.35),0 0 0 1px rgba(240,192,64,0.08)">
      <div style="font-size:28px;margin-bottom:12px">&#x2694;</div>
      <div style="font-family:'Cinzel',serif;font-size:12px;letter-spacing:4px;color:var(--gold);text-transform:uppercase;margin-bottom:6px">New Profile</div>
      <div style="width:60px;height:1px;background:linear-gradient(to right,transparent,var(--gold-dim),transparent);margin:0 auto 20px"></div>
      <input id="newProfileName" type="text" placeholder="Enter your name" maxlength="24" autocomplete="off"
        style="background:rgba(6,1,1,0.8);border:1px solid rgba(240,192,64,0.2);border-radius:10px;color:var(--white);font-family:'Cinzel',serif;font-size:15px;letter-spacing:2px;padding:12px 16px;outline:none;width:100%;margin-bottom:12px;text-align:center;transition:border-color 0.2s"
        onfocus="this.style.borderColor='rgba(240,192,64,0.5)'" onblur="this.style.borderColor='rgba(240,192,64,0.2)'"
        onkeydown="if(event.key==='Enter')document.getElementById('newProfilePw').focus()">
      <input id="newProfilePw" type="password" placeholder="Password" autocomplete="off"
        style="background:rgba(6,1,1,0.8);border:1px solid rgba(240,192,64,0.2);border-radius:10px;color:var(--white);font-family:'Cinzel',serif;font-size:15px;letter-spacing:2px;padding:12px 16px;outline:none;width:100%;margin-bottom:10px;text-align:center;transition:border-color 0.2s"
        onfocus="this.style.borderColor='rgba(240,192,64,0.5)'" onblur="this.style.borderColor='rgba(240,192,64,0.2)'"
        onkeydown="if(event.key==='Enter')createProfile()">
      <div id="newProfileError" style="color:#f87171;font-family:'Cinzel',serif;font-size:10px;letter-spacing:1px;margin-bottom:14px;min-height:14px"></div>
      <div style="display:flex;gap:10px;justify-content:center">
        <button onclick="createProfile()"
          style="font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;text-transform:uppercase;background:linear-gradient(135deg,rgba(160,30,30,0.8),rgba(100,10,10,0.9));border:1px solid rgba(240,192,64,0.3);border-radius:8px;color:var(--gold-pale);padding:10px 28px;cursor:pointer;transition:all 0.2s"
          onmouseover="this.style.background='linear-gradient(135deg,rgba(200,40,40,0.9),rgba(140,15,15,0.95))'"
          onmouseout="this.style.background='linear-gradient(135deg,rgba(160,30,30,0.8),rgba(100,10,10,0.9))'">
          Create
        </button>
        <button onclick="closeNewProfileModal()"
          style="font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;text-transform:uppercase;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:var(--silver-dim);padding:10px 20px;cursor:pointer;transition:all 0.2s"
          onmouseover="this.style.color='var(--silver)'" onmouseout="this.style.color='var(--silver-dim)'">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <div id="pwModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#1a0505;border:1px solid var(--border);border-radius:16px;padding:36px;min-width:320px;box-shadow:var(--glow);text-align:center">
      <div style="font-family:'Cinzel',serif;font-size:13px;letter-spacing:3px;color:var(--gold);text-transform:uppercase;margin-bottom:20px">Enter Password</div>
      <input type="password" id="pwInput" placeholder="Password" style="width:100%;margin-bottom:12px" onkeydown="if(event.key==='Enter')submitPw()">
      <div id="pwError" style="color:#f87171;font-size:13px;font-style:italic;margin-bottom:12px;min-height:18px"></div>
      <div style="display:flex;gap:10px;justify-content:center">
        <button class="btn btn-add" onclick="submitPw()" style="padding:9px 20px;font-size:10px">Unlock</button>
        <button class="btn-test" onclick="closePwModal()" style="align-self:center">Cancel</button>
      </div>
    </div>
  </div>

  <div class="search-panel">
    <div class="sec-label">Search Card Database</div>
    <div class="test-bar">
      <button class="btn-test" onclick="testAPI()">Test API Connection</button>
      <span id="testResult"></span>
    </div>
    <div class="search-row">
      <div class="search-wrap">
        <input type="text" id="cardSearch" placeholder="Type a card name &mdash; e.g. Dark Magician, Ash Blossom&hellip;" autocomplete="off">
        <div class="ac-list" id="acList"></div>
      </div>
      <span class="status-msg" id="statusMsg"></span>
    </div>

    <div class="card-preview" id="cardPreview">
      <div class="preview-grid">
        <div class="img-wrap" id="cardImgWrap"><div class="img-ph">&#x1F0A3;</div></div>
        <div class="card-info">
          <div class="card-name" id="previewName"></div>
          <div class="card-meta" id="previewMeta"></div>
          <div class="atk-def" id="previewAtkDef"></div>
          <div class="card-eff" id="previewEffect"></div>
          <div class="card-set" id="previewSet"></div>
        </div>
      </div>
      <div class="entry-form" id="entryForm">
        <div class="field"><label>Quantity</label><input type="number" id="fQty" value="1" min="1" max="99" style="width:80px"></div>
        <div class="field"><label>Rarity</label>
          <select id="fRarity">
            <option>Common</option><option>Rare</option><option>Super Rare</option>
            <option>Ultra Rare</option><option>Secret Rare</option><option>Prismatic Secret Rare</option>
            <option>Ghost Rare</option><option>Starlight Rare</option><option>Quarter Century Secret Rare</option>
          </select>
        </div>
        <div class="field"><label>Condition</label>
          <select id="fCondition">
            <option>Mint</option><option selected>Near Mint</option><option>Lightly Played</option>
            <option>Moderately Played</option><option>Heavily Played</option><option>Damaged</option>
          </select>
        </div>
        <div class="field"><label>Edition</label>
          <select id="fEdition"><option>Unlimited</option><option>1st Edition</option><option>Limited Edition</option></select>
        </div>

        <div class="field" id="cardNumField" style="display:none"><label>Card Number</label>
          <select id="fCardNum"></select>
        </div>
        <button class="btn" style="background:linear-gradient(135deg,var(--gold-dim),var(--gold));color:var(--void);padding:11px 24px" onclick="addSearchedCardToWishlist()">&#9733; Add to Wishlist</button>
        <button class="btn btn-add" onclick="addToCollection()">+ Add Card</button>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('collection')" id="tab-collection">&#9876; Collection</button>
    <button class="tab-btn" onclick="switchTab('stats')" id="tab-stats">&#128202; Statistics</button>
    <button class="tab-btn" onclick="switchTab('decks')" id="tab-decks">&#x2261; Saved Decks</button>
    <button class="tab-btn" onclick="switchTab('wishlist')" id="tab-wishlist">&#9733; Wishlist</button>
    <button class="tab-btn" onclick="switchTab('suggestions')" id="tab-suggestions">&#x1F4A1; Deck Suggestions</button>
  </div>

  <!-- Collection Tab -->
  <div class="tab-pane active" id="pane-collection">
  <div class="coll-panel">
    <div class="panel-hdr">
      <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
        <div style="position:relative;display:inline-block">
          <button id="collFilterBtn" onclick="toggleCollDropdown()" style="font-family:'Cinzel',serif;font-size:13px;letter-spacing:3px;color:var(--gold);text-transform:uppercase;background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:8px;padding:0">
            My Collection
            <span id="collFilterLabel" style="font-size:9px;color:var(--accent);letter-spacing:1px"></span>
            <span style="font-size:10px;color:var(--silver-dim)">&#9660;</span>
          </button>
          <div id="collDropdown" style="display:none;position:absolute;top:calc(100% + 8px);left:0;background:#1a0505;border:1px solid var(--border);border-radius:10px;min-width:160px;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,0.5);overflow:hidden">
            <div class="coll-filter-opt" onclick="setCollTypeFilter('')">All Cards</div>
            <div class="coll-filter-opt" onclick="setCollTypeFilter('monster')">&#x25CF; Monsters</div>
            <div class="coll-filter-opt" onclick="setCollTypeFilter('spell')">&#x25CF; Spells</div>
            <div class="coll-filter-opt" onclick="setCollTypeFilter('trap')">&#x25CF; Traps</div>
          </div>
        </div>
        <label class="btn" style="padding:7px 14px;font-size:9px;background:rgba(40,80,160,0.3);color:var(--silver);cursor:pointer" title="Import from CSV">
          &#x1F4E5; Import CSV
          <input type="file" id="csvImportInput" accept=".csv" style="display:none" onchange="importCSV(this)">
        </label>
        <button class="btn" style="padding:7px 14px;font-size:9px;background:rgba(100,60,160,0.25);color:var(--silver);border:1px solid rgba(150,100,200,0.3)" onclick="quickFilter('notInDecks')" title="Show cards not used in any deck">
          Not in Decks
        </button>
        <button class="btn" style="padding:7px 14px;font-size:9px;background:rgba(76,175,80,0.25);color:var(--silver);border:1px solid rgba(76,175,80,0.3)" onclick="quickFilter('recent')" title="Show cards added in last 7 days">
          Recently Added
        </button>
      </div>
      <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
        <div style="position:relative">
          <input type="text" id="collSearch" placeholder="&#x1F50D; Filter collection..." autocomplete="off"
            style="background:rgba(12,3,3,0.8);border:1px solid var(--border);border-radius:8px;color:var(--white);font-family:'Crimson Pro',serif;font-size:14px;padding:7px 32px 7px 12px;outline:none;width:220px;transition:border-color 0.2s"
            oninput="filterCollection()">
          <span id="collClear" onclick="clearCollSearch()" style="display:none;position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--silver-dim);font-size:14px">&#x2715;</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-family:'Cinzel',serif;font-size:9px;color:var(--silver-dim);letter-spacing:1px">Per Page:</span>
          <select id="pageSize" onchange="changePageSize()" style="font-family:'Cinzel',serif;font-size:9px;background:rgba(0,0,0,0.5);border:1px solid var(--border);border-radius:6px;color:var(--gold);padding:4px 8px;cursor:pointer">
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <div class="stats-row">
          <div class="stat"><span class="stat-n" id="statUnique">0</span><span class="stat-l">Unique</span></div>
          <div class="stat"><span class="stat-n" id="statTotal">0</span><span class="stat-l">Total Cards</span></div>
        </div>
      </div>
    </div>
    <div id="paginationTop" style="padding:12px 28px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.2)">
      <div style="font-family:'Cinzel',serif;font-size:10px;color:var(--silver-dim);letter-spacing:1px">
        Page <span id="currentPageDisplay">1</span> of <span id="totalPagesDisplay">1</span>
      </div>
      <div style="display:flex;gap:8px">
        <button id="prevPageBtn" onclick="prevPage()" style="font-family:'Cinzel',serif;font-size:9px;padding:6px 12px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:6px;color:var(--silver);cursor:pointer">&#9664; Prev</button>
        <button id="nextPageBtn" onclick="nextPage()" style="font-family:'Cinzel',serif;font-size:9px;padding:6px 12px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:6px;color:var(--silver);cursor:pointer">Next &#9654;</button>
      </div>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr id="tableHeaders">
          <th style="width:36px"></th>
          <th onclick="sortBy('name')"      class="sortable" style="min-width:160px">Card Name <span class="sort-icon" id="si-name"></span></th>
          <th onclick="sortBy('type')"      class="sortable">Type <span class="sort-icon" id="si-type"></span></th>
          <th onclick="sortBy('attribute')" class="sortable">Attribute <span class="sort-icon" id="si-attribute"></span></th>
          <th onclick="sortBy('archetype')" class="sortable">Archetype <span class="sort-icon" id="si-archetype"></span></th>
          <th onclick="sortBy('atk')"       class="sortable">ATK/DEF <span class="sort-icon" id="si-atk"></span></th>
          <th onclick="sortBy('cardNumber')" class="sortable">Card No. <span class="sort-icon" id="si-cardNumber"></span></th>
          <th onclick="sortBy('level')" class="sortable">Level <span class="sort-icon" id="si-level"></span></th>
          <th onclick="sortBy('rarity')"    class="sortable" style="min-width:120px">Rarity <span class="sort-icon" id="si-rarity"></span></th>
          <th onclick="sortBy('condition')" class="sortable">Condition <span class="sort-icon" id="si-condition"></span></th>
          <th onclick="sortBy('edition')"   class="sortable">Edition <span class="sort-icon" id="si-edition"></span></th>
          <th onclick="sortBy('qty')"       class="sortable">Qty <span class="sort-icon" id="si-qty"></span></th>
          <th onclick="sortBy('inDecks')"   class="sortable">In Decks <span class="sort-icon" id="si-inDecks"></span></th>
          <th onclick="sortBy('addedAt')"   class="sortable">Date Added <span class="sort-icon" id="si-addedAt"></span></th>
          <th></th>
        </tr></thead>
        <tbody id="collBody">
          <tr><td colspan="13"><div class="empty-st"><div class="empty-ic">&#9876;</div><p class="empty-tx">Loading&hellip;</p></div></td></tr>
        </tbody>
      </table>
    </div>
    <div class="rarity-breakdown" id="rarityBreakdown"></div>
    <div class="exp-bar">
      <button class="btn btn-gold" onclick="exportCSV()">&#8595; Export CSV for Excel</button>
      <button class="btn btn-gold" onclick="downloadBackup()" style="margin-left:12px">&#128190; Download Backup</button>
      <label class="btn btn-gold" style="margin-left:12px;cursor:pointer">&#128193; Restore Backup<input type="file" id="backupImportInput" accept=".json" style="display:none" onchange="restoreBackup(this)"></label>
      <button class="btn btn-gold" onclick="confirmRemoveAllCards()" style="background:linear-gradient(135deg,#b82020,#d62828);margin-left:12px">&#x1F5D1; Remove All Cards</button>
    </div>
  </div>

  <!-- Statistics Tab -->
  <div class="tab-pane" id="pane-stats">
    <div class="coll-panel">
      <div class="panel-hdr">
        <div class="panel-ttl">&#128202; Collection Statistics</div>
        <button class="btn" style="padding:7px 14px;font-size:9px" onclick="refreshStats()">&#x21BB; Refresh</button>
      </div>

      <!-- Summary Stats -->
      <div style="padding:24px 28px">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:32px">
          <div class="stat-card">
            <div class="stat-card-value" id="stat-unique-cards">0</div>
            <div class="stat-card-label">Unique Cards</div>
          </div>
          <div class="stat-card">
            <div class="stat-card-value" id="stat-total-cards">0</div>
            <div class="stat-card-label">Total Cards</div>
          </div>
          <div class="stat-card">
            <div class="stat-card-value" id="stat-total-decks">0</div>
            <div class="stat-card-label">Saved Decks</div>
          </div>
          <div class="stat-card">
            <div class="stat-card-value" id="stat-avg-qty">0</div>
            <div class="stat-card-label">Avg. Copies/Card</div>
          </div>
        </div>

        <!-- Charts Grid -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:24px">
          
          <!-- Card Type Distribution -->
          <div class="chart-container">
            <div class="chart-title">Card Type Distribution</div>
            <div style="position:relative;height:300px">
              <canvas id="typeChart"></canvas>
            </div>
          </div>

          <!-- Rarity Distribution -->
          <div class="chart-container">
            <div class="chart-title">Rarity Distribution</div>
            <div style="position:relative;height:300px">
              <canvas id="rarityChart"></canvas>
            </div>
          </div>

          <!-- Condition Distribution -->
          <div class="chart-container">
            <div class="chart-title">Card Condition</div>
            <div style="position:relative;height:300px">
              <canvas id="conditionChart"></canvas>
            </div>
          </div>

          <!-- Top Archetypes -->
          <div class="chart-container">
            <div class="chart-title">Top 10 Archetypes</div>
            <div style="position:relative;height:300px">
              <canvas id="archetypeChart"></canvas>
            </div>
          </div>

          <!-- Collection Growth -->
          <div class="chart-container" style="grid-column: span 2">
            <div class="chart-title">Collection Growth Over Time</div>
            <div style="position:relative;height:300px">
              <canvas id="growthChart"></canvas>
            </div>
          </div>

        </div>

        <!-- Additional Stats Tables -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:32px">
          
          <!-- Most Common Cards -->
          <div class="stat-table-container">
            <div class="stat-table-title">Most Collected Cards</div>
            <div id="topCardsTable" class="stat-table"></div>
          </div>

          <!-- Deck Usage Stats -->
          <div class="stat-table-container">
            <div class="stat-table-title">Deck Usage Summary</div>
            <div id="deckStatsTable" class="stat-table"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Deck Builder -->
  <div class="deck-section">
    <div class="deck-hdr">
      <div class="deck-ttl">&#9876; Deck Builder</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <span id="deckTotalCount" style="font-family:'Cinzel',serif;font-size:11px;color:var(--silver-dim);letter-spacing:1px">0 / 40+ cards</span>
        <input type="text" id="deckName" placeholder="Deck name..." style="background:rgba(12,3,3,0.8);border:1px solid var(--border);border-radius:8px;color:var(--white);font-family:'Crimson Pro',serif;font-size:14px;padding:6px 12px;outline:none;width:180px">
        <button class="btn btn-gold" id="saveDeckBtn" style="padding:8px 16px;font-size:9px" onclick="saveDeck()">&#x2713; Save Deck</button>
        <button class="btn btn-gold" id="saveAsNewBtn" style="padding:8px 16px;font-size:9px;display:none" onclick="saveAsNewDeck()">&#x2795; Save as New</button>
        <button class="btn btn-gold" style="padding:8px 16px;font-size:9px" onclick="exportDeck()">&#8595; Export .ydk</button>
        <label class="btn" style="padding:8px 16px;font-size:9px;background:rgba(40,80,160,0.3);color:var(--silver);cursor:pointer" title="Import a .ydk file">&#8593; Import .ydk<input type="file" id="ydkImportInput" accept=".ydk,.txt" style="display:none" onchange="importYdk(this)"></label>
        <button class="btn" style="padding:8px 16px;font-size:9px;background:rgba(160,30,30,0.3);color:var(--silver)" onclick="clearDeck()">Clear</button>
      </div>
    </div>
    <div class="deck-search-row" style="position:relative">
      <span style="font-family:'Cinzel',serif;font-size:9px;letter-spacing:2px;color:var(--silver-dim);text-transform:uppercase">Add from collection:</span>
      <input type="text" id="deckSearch" placeholder="Search your collection..." autocomplete="off"
        style="background:rgba(12,3,3,0.8);border:1px solid var(--border);border-radius:8px;color:var(--white);font-family:'Crimson Pro',serif;font-size:14px;padding:7px 12px;outline:none;width:240px"
        oninput="filterDeckSearch()">
      <div id="deckSearchResults" style="display:none;position:absolute;margin-top:36px;background:#1a0505;border:1px solid var(--border);border-radius:10px;max-height:200px;overflow-y:auto;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,0.5);min-width:280px"></div>
    </div>
    <div class="deck-zones">
      <div class="deck-zone">
        <div class="deck-zone-hdr">
          <span>Main Deck</span>
          <span class="deck-zone-count" id="mainCount">0</span>
        </div>
        <div class="deck-card-list" id="mainDeck"></div>
      </div>
      <div class="deck-zone">
        <div class="deck-zone-hdr">
          <span>Extra Deck</span>
          <span class="deck-zone-count" id="extraCount">0</span>
        </div>
        <div class="deck-card-list" id="extraDeck"></div>
      </div>
      <div class="deck-zone">
        <div class="deck-zone-hdr">
          <span>Side Deck</span>
          <span class="deck-zone-count" id="sideCount">0</span>
        </div>
        <div class="deck-card-list" id="sideDeck"></div>
      </div>
    </div>
  </div>

</div>

  <!-- Saved Decks Tab -->
  <div class="tab-pane" id="pane-decks">
    <div class="coll-panel">
      <div class="panel-hdr" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
        <div style="font-family:'Cinzel',serif;font-size:13px;letter-spacing:3px;color:var(--gold);text-transform:uppercase">
          &#x2261; Saved Decks
          <span id="savedDeckCount" style="font-size:10px;color:var(--silver-dim);margin-left:10px"></span>
        </div>
      </div>
      <div class="saved-decks-grid" id="savedDecksGrid"></div>
    </div>
  </div>

  <!-- Wishlist Tab -->
  <div class="tab-pane" id="pane-wishlist">
    <div class="coll-panel">
      <div class="panel-hdr">
        <div class="panel-ttl">&#9733; Wishlist</div>
        <div style="display:flex;align-items:center;gap:16px">
          <span id="wishlistCount" style="font-family:'Cinzel',serif;font-size:10px;color:var(--silver-dim);letter-spacing:1px"></span>
        </div>
      </div>
      <div id="wishlistGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;padding:20px 0"></div>
    </div>
  </div>

  <!-- Deck Suggestions Tab -->
  <div class="tab-pane" id="pane-suggestions">
    <div class="coll-panel">
      <div class="panel-hdr" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
        <div style="font-family:'Cinzel',serif;font-size:13px;letter-spacing:3px;color:var(--gold);text-transform:uppercase">
          &#x1F4A1; Deck Suggestions
          <span id="suggestionsCount" style="font-size:10px;color:var(--silver-dim);margin-left:10px"></span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <button id="refreshSuggestionsBtn" onclick="loadDeckSuggestions()" style="font-family:'Cinzel',serif;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:7px 14px;background:rgba(40,80,160,0.3);border:1px solid var(--border);border-radius:6px;color:var(--silver);cursor:pointer">
            &#x21bb; Refresh
          </button>
          <select id="matchFilter" onchange="filterSuggestions()" style="font-family:'Cinzel',serif;font-size:9px;background:rgba(0,0,0,0.5);border:1px solid var(--border);border-radius:6px;color:var(--gold);padding:6px 10px;cursor:pointer">
            <option value="0">All Suggestions</option>
            <option value="25">25%+ Progress</option>
            <option value="50">50%+ Progress</option>
            <option value="75">75%+ Progress</option>
          </select>
        </div>
      </div>
      <div id="suggestionsLoading" style="text-align:center;padding:60px 20px;font-family:'Cinzel',serif;font-size:12px;letter-spacing:2px;color:var(--silver-dim);text-transform:uppercase;display:none">
        Loading deck suggestions...
      </div>
      <div class="suggestions-grid" id="suggestionsGrid"></div>
    </div>
  </div>

<div id="cardModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center;padding:24px" onclick="if(event.target===this)closeCardModal()">
  <div style="background:#1a0505;border:1px solid var(--border);border-radius:20px;max-width:720px;width:100%;box-shadow:0 0 60px rgba(160,30,30,0.5);position:relative;overflow:hidden">
    <button onclick="closeCardModal()" style="position:absolute;top:14px;right:18px;background:none;border:none;color:var(--silver-dim);font-size:26px;cursor:pointer;z-index:1;line-height:1">&#x2715;</button>
    <div style="display:grid;grid-template-columns:240px 1fr;gap:0">
      <div style="background:#0e0303">
        <img id="modalImg" src="" alt="" style="width:100%;display:block" onerror="this.style.display=&quot;none&quot;">
      </div>
      <div style="padding:28px 28px 28px 22px;display:flex;flex-direction:column;gap:14px">
        <div id="modalName" style="font-family:'Cinzel',serif;font-size:22px;font-weight:700;color:var(--gold-pale);line-height:1.3"></div>
        <div id="modalMeta" style="display:flex;flex-wrap:wrap;gap:8px"></div>
        <div id="modalAtkDef" style="font-family:'Cinzel',serif;font-size:16px;color:var(--silver);letter-spacing:1px"></div>
        <div id="modalSet" style="font-size:15px;color:var(--silver-dim)"></div>
        <div id="modalEffect" style="font-size:15px;color:var(--silver);line-height:1.8;font-style:italic;border-left:2px solid rgba(192,57,43,0.4);padding-left:14px;max-height:260px;overflow-y:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- Deck Detail Modal -->
<div id="deckDetailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center;padding:24px;overflow-y:auto" onclick="if(event.target===this)closeDeckDetailModal()">
  <div style="background:#1a0505;border:1px solid var(--border);border-radius:20px;max-width:1100px;width:100%;box-shadow:0 0 60px rgba(160,30,30,0.5);position:relative;max-height:90vh;display:flex;flex-direction:column">
    <button onclick="closeDeckDetailModal()" style="position:absolute;top:14px;right:18px;background:none;border:none;color:var(--silver-dim);font-size:26px;cursor:pointer;z-index:1;line-height:1">&#x2715;</button>
    
    <div style="padding:28px 32px 20px;border-bottom:1px solid var(--border)">
      <div id="deckDetailName" style="font-family:'Cinzel',serif;font-size:24px;font-weight:700;color:var(--gold-pale);line-height:1.3;margin-bottom:12px"></div>
      <div id="deckDetailMeta" style="display:flex;gap:24px;font-size:14px;color:var(--silver)">
        <span>Main: <b id="deckDetailMainCount" style="color:var(--gold-pale)">0</b></span>
        <span>Extra: <b id="deckDetailExtraCount" style="color:var(--gold-pale)">0</b></span>
        <span>Side: <b id="deckDetailSideCount" style="color:var(--gold-pale)">0</b></span>
      </div>
    </div>
    
    <div id="deckDetailContent" style="padding:24px 32px;overflow-y:auto;flex:1">
      <!-- Zones will be populated here -->
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// Global shims so inline onclick attrs work before window.onload fires
function showProfileScreen() { if (window._showProfileScreen) window._showProfileScreen(); }
function toggleAuth()        { if (window._toggleAuth)        window._toggleAuth();        }

window.onload = function() {

  // Firebase init
  firebase.initializeApp({
    apiKey: "AIzaSyCbb51QGCVq7N_cmTifYYJb8Eb_YiqkVg4",
    authDomain: "ygo-collection-4c76d.firebaseapp.com",
    projectId: "ygo-collection-4c76d",
    storageBucket: "ygo-collection-4c76d.firebasestorage.app",
    messagingSenderId: "725120094141",
    appId: "1:725120094141:web:ba9d638ce4c1a20d04ccd4"
  });
  var db = firebase.firestore();

  // Active profile state
  var activeProfileId = localStorage.getItem('activeProfileId') || null;
  var activeProfileName = localStorage.getItem('activeProfileName') || null;
  var col = null;
  var cardsUnsub = null;
  var decksUnsub = null;

  var selCard = null;
  var cards = [];
  var timer = null;
  var acIdx = -1;

  var inp = document.getElementById('cardSearch');
  var acList = document.getElementById('acList');
  var statusEl = document.getElementById('statusMsg');

  // Sync state
  function sync(state, msg) {
    var dot = document.getElementById('syncDot');
    var lbl = document.getElementById('syncLabel');
    dot.className = 'sync-dot ' + state;
    lbl.className = state;
    lbl.textContent = msg;
  }

  // Profile-scoped Firestore listener
  function startProfileListener(profileId) {
    if (cardsUnsub) { cardsUnsub(); cardsUnsub = null; }
    col = db.collection('profiles').doc(profileId).collection('cards');
    sync('syncing', 'Connecting...');
    cardsUnsub = col.orderBy('addedAt','asc').onSnapshot(function(snap) {
      cards = snap.docs.map(function(d) { var o = d.data(); o.fid = d.id; return o; });
      renderTable();
    sync('synced', 'Synced ' + new Date().toLocaleTimeString());
  }, function(err) {
    sync('error', 'Error: ' + err.code);
    renderTable();
  });
  } // end startProfileListener

  // Search input
  inp.addEventListener('input', function() {
    clearTimeout(timer);
    var q = inp.value.trim();
    if (q.length === 0) { closeAc(); clearPreview(); return; }
    if (q.length < 4) { closeAc(); return; }
    timer = setTimeout(function() { doSearch(q); }, 700);
  });

  function clearPreview() {
    selCard = null;
    document.getElementById('cardPreview').classList.remove('open');
    document.getElementById('entryForm').classList.remove('open');
    document.getElementById('previewName').textContent = '';
    document.getElementById('previewMeta').innerHTML = '';
    document.getElementById('previewAtkDef').innerHTML = '';
    document.getElementById('previewEffect').textContent = '';
    document.getElementById('previewSet').textContent = '';
    document.getElementById('cardImgWrap').innerHTML = '<div class="img-ph">&#x1F0A3;</div>';
    document.getElementById('cardNumField').style.display = 'none';
    document.getElementById('fCardNum').innerHTML = '';
    statusEl.textContent = '';
  }

  inp.addEventListener('keydown', function(e) {
    var items = acList.querySelectorAll('.ac-item');
    if (e.key === 'ArrowDown') { acIdx = Math.min(acIdx+1, items.length-1); hiAc(items); e.preventDefault(); }
    else if (e.key === 'ArrowUp') { acIdx = Math.max(acIdx-1, 0); hiAc(items); e.preventDefault(); }
    else if (e.key === 'Enter' && acIdx >= 0 && items[acIdx]) { items[acIdx].click(); e.preventDefault(); }
    else if (e.key === 'Escape') closeAc();
  });

  document.addEventListener('click', function(e) { if (!e.target.closest('.search-wrap')) closeAc(); });

  function normalize(q) {
    return q
      .trim()
      // Remove characters the API doesn't accept
      .replace(/[^a-zA-Z0-9 '\-]/g, '')
      // Collapse multiple spaces
      .replace(/  +/g, ' ')
      // Title-case each word so "blue eyes" -> "Blue Eyes"
      .replace(/\b\w/g, function(c) { return c.toUpperCase(); });
  }

  function doSearch(q) {
    var base = 'https://db.ygoprodeck.com/api/v7/cardinfo.php';

    // Build a set of query variants to try in order:
    // 1. Input as-is (normalized + title-cased)
    // 2. Spaces replaced with hyphens  "Blue Eyes" -> "Blue-Eyes"
    // 3. Hyphens replaced with spaces  "Blue-Eyes" -> "Blue Eyes"
    // 4. First word only               "Blue-Eyes White Dragon" -> "Blue-Eyes"
    var norm      = normalize(q);
    if (norm.length < 4) return;

    var hyphenated = norm.replace(/ /g, '-');
    var spaced     = norm.replace(/-/g, ' ');
    var firstWord  = norm.split(/[ -]/)[0];

    // Deduplicate variants while preserving order
    var seen = {};
    var variants = [norm, hyphenated, spaced, firstWord].filter(function(v) {
      if (v.length < 4 || seen[v]) return false;
      seen[v] = true; return true;
    });

    statusEl.innerHTML = '<span class="spinner"></span>';

    function handleData(data) {
      statusEl.textContent = '';
      if (!data || data.error || !data.data || !data.data.length) {
        closeAc(); statusEl.textContent = 'No cards found'; return;
      }
      openAc(data.data.slice(0, 10));
    }

    // Try each variant in sequence, stopping at the first success
    // Also try archetype search — handles "Blue-Eyes", "Dark Magician" etc.
    // which are archetypes with hundreds of variants that break fname
    var archetypeGuess = norm.replace(/-/g, ' ');

    function tryFetch(url) {
      return fetch(url).then(function(r) { return r.ok ? r.json() : null; }).catch(function() { return null; });
    }

    function hasResults(d) { return d && d.data && d.data.length > 0; }

    function tryVariant(idx) {
      if (idx >= variants.length) {
        // All fname variants exhausted — try archetype as last resort
        tryFetch(base + '?archetype=' + encodeURIComponent(archetypeGuess) + '&num=10&offset=0')
          .then(function(d) {
            if (hasResults(d)) { handleData(d); return; }
            // Final fallback: first word as archetype
            var fw = archetypeGuess.split(' ')[0];
            if (fw.length >= 3) {
              return tryFetch(base + '?archetype=' + encodeURIComponent(fw) + '&num=10&offset=0')
                .then(function(d2) {
                  if (hasResults(d2)) { handleData(d2); return; }
                  statusEl.textContent = 'No cards found'; closeAc();
                });
            }
            statusEl.textContent = 'No cards found'; closeAc();
          });
        return;
      }
      var v = variants[idx];
      tryFetch(base + '?fname=' + encodeURIComponent(v) + '&num=10&offset=0')
        .then(function(d) {
          if (hasResults(d)) { handleData(d); return; }
          tryVariant(idx + 1);
        });
    }

    tryVariant(0);
  }

  function openAc(results) {
    acIdx = -1; acList.innerHTML = '';
    results.forEach(function(card) {
      var item = document.createElement('div');
      item.className = 'ac-item';
      var tl = tLabel(card.type);
      item.innerHTML = '<span>' + esc(card.name) + '</span><span class="tbadge ' + tl.c + '">' + tl.t + '</span>';
      item.addEventListener('click', function() { pickCard(card); });
      acList.appendChild(item);
    });
    acList.classList.add('open');
  }

  function hiAc(items) {
    items.forEach(function(it,i) { it.classList.toggle('hi', i===acIdx); });
    if (items[acIdx]) items[acIdx].scrollIntoView({block:'nearest'});
  }

  function closeAc() { acList.classList.remove('open'); acList.innerHTML = ''; acIdx = -1; }

  function pickCard(card) {
    selCard = card;
    inp.value = card.name;
    closeAc();
    statusEl.textContent = '';
    showPreview(card);
  }

  function showPreview(card) {
    document.getElementById('cardPreview').classList.add('open');
    document.getElementById('entryForm').classList.add('open');
    document.getElementById('previewName').textContent = card.name;

    var tl = tLabel(card.type);
    var pc = tl.c === 'bs' ? 'ps' : tl.c === 'bt' ? 'pt' : 'pm';
    var mh = '<span class="mpill ' + pc + '">' + esc(card.type) + '</span>';
    if (card.archetype) mh += '<span class="mpill pa">' + esc(card.archetype) + '</span>';
    
    // Fix #9: Show owned status indicator
    var ownedCards = cards.filter(function(c) { return c.name === card.name; });
    if (ownedCards.length > 0) {
      var totalQty = ownedCards.reduce(function(sum, c) { return sum + (c.qty || 0); }, 0);
      mh += '<span class="mpill" style="background:rgba(76,175,80,0.15);border-color:rgba(76,175,80,0.4);color:#81c784">✓ In Collection (' + totalQty + ' owned)</span>';
    } else {
      mh += '<span class="mpill" style="background:rgba(100,100,100,0.1);border-color:rgba(150,150,150,0.3);color:var(--silver-dim)">Not in collection</span>';
    }
    
    document.getElementById('previewMeta').innerHTML = mh;

    var ad = document.getElementById('previewAtkDef');
    if (card.atk !== undefined) {
      ad.innerHTML = 'ATK <b>' + (card.atk===-1?'?':card.atk) + '</b> / DEF <b>' + (card.def===undefined?'?':card.def===-1?'?':card.def) + '</b>';
    } else { ad.innerHTML = ''; }

    document.getElementById('previewEffect').textContent = card.desc || '';

    var se = document.getElementById('previewSet');
    if (card.card_sets && card.card_sets.length) {
      var s = card.card_sets[0];
      se.innerHTML = '<strong>' + esc(s.set_name) + '</strong> &middot; ' + esc(s.set_code) + ' &middot; ' + esc(s.set_rarity);

      // Populate card number dropdown with all printings
      var cnField = document.getElementById('cardNumField');
      var cnSelect = document.getElementById('fCardNum');
      cnSelect.innerHTML = '';
      card.card_sets.forEach(function(cs) {
        var opt = document.createElement('option');
        opt.value = cs.set_code;
        opt.textContent = cs.set_code + ' — ' + cs.set_name + ' (' + cs.set_rarity + ')';
        opt.dataset.rarity  = cs.set_rarity;
        opt.dataset.setName = cs.set_name;
        opt.dataset.setCode = cs.set_code;
        cnSelect.appendChild(opt);
      });
      cnField.style.display = '';

      // Auto-update Rarity and Set preview when card number changes
      cnSelect.onchange = function() {
        var sel = cnSelect.options[cnSelect.selectedIndex];
        se.innerHTML = '<strong>' + esc(sel.dataset.setName) + '</strong> &middot; ' + esc(sel.dataset.setCode) + ' &middot; ' + esc(sel.dataset.rarity);
        var opts = document.getElementById('fRarity').options;
        for (var i=0; i<opts.length; i++) { if (opts[i].value===sel.dataset.rarity) { document.getElementById('fRarity').selectedIndex=i; break; } }
      };

      // Set initial rarity from first printing
      var opts = document.getElementById('fRarity').options;
      for (var i=0; i<opts.length; i++) { if (opts[i].value===s.set_rarity) { document.getElementById('fRarity').selectedIndex=i; break; } }
    } else {
      se.textContent = 'No set info';
      document.getElementById('cardNumField').style.display = 'none';
    }



    var wrap = document.getElementById('cardImgWrap');
    if (card.card_images && card.card_images.length) {
      var img = document.createElement('img');
      img.src = 'https://images.ygoprodeck.com/images/cards_small/' + card.card_images[0].id + '.jpg';
      img.alt = card.name;
      img.onerror = function() { wrap.innerHTML = '<div class="img-ph">&#x1F0A3;</div>'; };
      wrap.innerHTML = '';
      wrap.appendChild(img);
    } else { wrap.innerHTML = '<div class="img-ph">&#x1F0A3;</div>'; }
  }

  // Auth state
  var PW_HASH = '663dc2bedc7eb3349bc80bff0c508111936a2a0d18269353a7ef7020ae24cc18';
  var authed = sessionStorage.getItem('authed_' + (localStorage.getItem('activeProfileId') || 'default')) === 'true';
  var sortCol = null;
  var sortDir = 1;
  var collFilter = '';
  var collTypeFilter = '';
  var currentPage = 1;
  var pageSize = 50;

  function sha256(str) {
    // Use SubtleCrypto to hash the password
    var buf = new TextEncoder().encode(str);
    return crypto.subtle.digest('SHA-256', buf).then(function(hash) {
      return Array.from(new Uint8Array(hash)).map(function(b) { return b.toString(16).padStart(2,'0'); }).join('');
    });
  }

  window._toggleAuth = window.toggleAuth = function() {
    if (authed) {
      authed = false;
      sessionStorage.setItem('authed_' + (activeProfileId || 'default'), 'false');
      updateLockBtn();
      toast('Locked');
    } else {
      document.getElementById('pwModal').style.display = 'flex';
      setTimeout(function() { document.getElementById('pwInput').focus(); }, 50);
    }
  };

  window.closePwModal = function() {
    document.getElementById('pwModal').style.display = 'none';
    document.getElementById('pwInput').value = '';
    document.getElementById('pwError').textContent = '';
  };

  window.submitPw = function() {
    var val = document.getElementById('pwInput').value;
    sha256(val).then(function(hash) {
      if (hash === PW_HASH) {
        authed = true;
        sessionStorage.setItem('authed_' + (activeProfileId || 'default'), 'true');
        closePwModal();
        updateLockBtn();
        toast('Unlocked — you can now edit your collection');
      } else {
        document.getElementById('pwError').textContent = 'Incorrect password';
        document.getElementById('pwInput').value = '';
      }
    });
  };

  function updateLockBtn() {
    var btn = document.getElementById('lockBtn');
    if (authed) {
      btn.innerHTML = '&#x1F513; Unlocked';
      btn.style.color = '#4ade80';
      btn.style.borderColor = 'rgba(74,222,128,0.4)';
    } else {
      btn.innerHTML = '&#x1F512; Locked';
      btn.style.color = 'var(--gold-pale)';
      btn.style.borderColor = 'rgba(160,30,30,0.5)';
    }
  }

  function requireAuth(action) {
    if (authed) { action(); return; }
    document.getElementById('pwModal').style.display = 'flex';
    setTimeout(function() { document.getElementById('pwInput').focus(); }, 50);
  }

  // Add card
  window.addToCollection = function() {
    requireAuth(function() { doAdd(); });
  };
  function doAdd() {
    if (!selCard) return;
    var c = selCard;
    var fs = (c.card_sets && c.card_sets.length) ? c.card_sets[0] : {};
    
    // Fix #6: Check for duplicate card
    var selectedCardNum = (function(){ var s=document.getElementById('fCardNum'); return s && s.selectedIndex>=0 ? s.value : (fs.set_code||'—'); })();
    var selectedRarity = document.getElementById('fRarity').value;
    var selectedCondition = document.getElementById('fCondition').value;
    
    var duplicate = cards.find(function(card) {
      return card.name === c.name && 
             card.cardNumber === selectedCardNum && 
             card.rarity === selectedRarity && 
             card.condition === selectedCondition;
    });
    
    if (duplicate) {
      var increaseQty = confirm(
        'This card already exists in your collection:\n\n' +
        c.name + '\n' +
        selectedCardNum + ' - ' + selectedRarity + ' - ' + selectedCondition + '\n' +
        'Current quantity: ' + (duplicate.qty || 1) + '\n\n' +
        'Would you like to increase the quantity instead of creating a duplicate entry?'
      );
      
      if (increaseQty) {
        var qtyToAdd = parseInt(document.getElementById('fQty').value) || 1;
        col.doc(duplicate.fid).update({
          qty: (duplicate.qty || 1) + qtyToAdd
        }).then(function() {
          toast(c.name + ' quantity increased by ' + qtyToAdd + '!');
          document.getElementById('fQty').value = 1;
        }).catch(function(e) { toast('Update failed: ' + e.message); });
        return;
      }
      // If user clicked Cancel, continue to add as new entry
    }
    
    sync('syncing','Saving...');
    col.add({
      name: c.name, type: c.type, race: c.race||'—', level: c.level||c.linkval||null,
      cardImageId: (c.card_images && c.card_images.length ? c.card_images[0].id : null),
      attribute: c.attribute||'—',
      archetype: c.archetype||'—',
      atk: c.atk!==undefined ? (c.atk===-1?'?':String(c.atk)) : '—',
      def: c.def!==undefined ? (c.def===-1?'?':String(c.def)) : '—',
      setName: (function(){ var s=document.getElementById('fCardNum'); return s && s.selectedIndex>=0 ? s.options[s.selectedIndex].dataset.setName : (fs.set_name||'—'); })(),
      setCode: (function(){ var s=document.getElementById('fCardNum'); return s && s.selectedIndex>=0 ? s.options[s.selectedIndex].dataset.setCode : (fs.set_code||'—'); })(),
      cardNumber: selectedCardNum,
      rarity: selectedRarity,
      condition: selectedCondition,
      edition: document.getElementById('fEdition').value,
      qty: parseInt(document.getElementById('fQty').value)||1,
      price: 0,
      notes: '',
      addedAt: Date.now()
    }).then(function() {
      toast(c.name + ' added!');
      document.getElementById('fQty').value = 1;
    }).catch(function(e) { sync('error','Save failed'); toast('Save failed: ' + e.message); });
  }

  // Remove card
  window.removeEntry = function(id) {
    requireAuth(function() {
      // Find card data before deleting for undo
      var card = cards.find(function(c){ return c.fid === id; });
      sync('syncing','Removing...');
      col.doc(id).delete().then(function() {
        if (!card) return;
        // Show undo toast
        var t = document.getElementById('toast');
        t.innerHTML = '';
        var msg = document.createTextNode(card.name + ' removed  ');
        var undoBtn = document.createElement('button');
        undoBtn.textContent = 'UNDO';
        undoBtn.style.cssText = 'font-family:Cinzel,serif;font-size:10px;letter-spacing:1px;background:rgba(240,192,64,0.2);color:#f0c040;border:1px solid rgba(240,192,64,0.4);border-radius:4px;padding:3px 10px;cursor:pointer;margin-left:4px';
        undoBtn.onclick = function(){ undoDelete(); };
        t.appendChild(msg);
        t.appendChild(undoBtn);
        t.classList.add('show');
        clearTimeout(window._toastTimer);
        window._undoCard = card;
        window._toastTimer = setTimeout(function(){
          t.classList.remove('show');
          window._undoCard = null;
        }, 5000);
      }).catch(function(e) { sync('error','Delete failed'); });
    });
  };

  window.undoDelete = function() {
    if (!window._undoCard) return;
    var card = window._undoCard;
    window._undoCard = null;
    clearTimeout(window._toastTimer);
    document.getElementById('toast').classList.remove('show');
    delete card.fid;
    col.add(card).catch(function(e){ toast('Undo failed: ' + e.message); });
  };

  // CSV Import
  window.importCSV = function(input) {
    var file = input.files[0];
    if (!file) return;
    requireAuth(function() {
      var reader = new FileReader();
      reader.onload = function(e) {
        var text = e.target.result;
        var lines = text.split(/\r?\n/).filter(function(line) { return line.trim(); });
        
        if (lines.length < 2) {
          toast('CSV file appears to be empty');
          input.value = '';
          return;
        }
        
        // Parse header
        var header = lines[0].split(',').map(function(h) { return h.trim().toLowerCase(); });
        var nameIdx = header.indexOf('name');
        
        if (nameIdx === -1) {
          toast('CSV must have a "name" column');
          input.value = '';
          return;
        }
        
        // Optional columns
        var rarityIdx = header.indexOf('rarity');
        var conditionIdx = header.indexOf('condition');
        var editionIdx = header.indexOf('edition');
        var qtyIdx = header.indexOf('qty') !== -1 ? header.indexOf('qty') : header.indexOf('quantity');
        
        var cardsToAdd = [];
        var successCount = 0;
        var failCount = 0;
        
        toast('Processing ' + (lines.length - 1) + ' cards from CSV...');
        
        // Parse CSV line properly handling quotes
        function parseCSVLine(line) {
          var result = [];
          var current = '';
          var inQuotes = false;
          for (var j = 0; j < line.length; j++) {
            var char = line[j];
            if (char === '"') {
              if (inQuotes && line[j + 1] === '"') {
                current += '"';
                j++;
              } else {
                inQuotes = !inQuotes;
              }
            } else if (char === ',' && !inQuotes) {
              result.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          result.push(current.trim());
          return result;
        }
        
        // Process each line
        for (var i = 1; i < lines.length; i++) {
          var values = parseCSVLine(lines[i]);
          var cardName = values[nameIdx];
          
          if (!cardName) continue;
          
          // Remove quotes from card name if present
          cardName = cardName.replace(/^"(.*)"$/, '$1');
          
          cardsToAdd.push({
            name: cardName,
            rarity: rarityIdx !== -1 ? (values[rarityIdx] || '').replace(/^"(.*)"$/, '$1') : 'Common',
            condition: conditionIdx !== -1 ? (values[conditionIdx] || '').replace(/^"(.*)"$/, '$1') : 'Near Mint',
            edition: editionIdx !== -1 ? (values[editionIdx] || '').replace(/^"(.*)"$/, '$1') : 'Unlimited',
            qty: qtyIdx !== -1 ? parseInt(values[qtyIdx]) || 1 : 1
          });
        }
        
        // Add cards one by one
        var processNext = function(idx) {
          if (idx >= cardsToAdd.length) {
            toast('Import complete: ' + successCount + ' added, ' + failCount + ' failed');
            input.value = '';
            return;
          }
          
          var cardData = cardsToAdd[idx];
          
          // Fetch card data from API
          fetch('https://db.ygoprodeck.com/api/v7/cardinfo.php?name=' + encodeURIComponent(cardData.name))
            .then(function(r) { return r.ok ? r.json() : null; })
            .then(function(data) {
              if (!data || !data.data || !data.data[0]) {
                failCount++;
                processNext(idx + 1);
                return;
              }
              
              var apiCard = data.data[0];
              var setInfo = apiCard.card_sets && apiCard.card_sets[0];
              
              var entry = {
                name: apiCard.name,
                type: apiCard.type || '—',
                race: apiCard.race || '—',
                attribute: apiCard.attribute || '—',
                archetype: apiCard.archetype || '—',
                atk: apiCard.atk !== undefined ? String(apiCard.atk) : '—',
                def: apiCard.def !== undefined ? String(apiCard.def) : '—',
                level: apiCard.level || 0,
                desc: apiCard.desc || '',
                setName: setInfo ? setInfo.set_name : '—',
                cardNumber: setInfo ? setInfo.set_code : '—',
                rarity: cardData.rarity || (setInfo ? setInfo.set_rarity : 'Common'),
                condition: cardData.condition || 'Near Mint',
                edition: cardData.edition || 'Unlimited',
                qty: cardData.qty || 1,
                cardImageId: apiCard.id
              };
              
              col.add(entry).then(function() {
                successCount++;
                processNext(idx + 1);
              }).catch(function(e) {
                failCount++;
                processNext(idx + 1);
              });
            })
            .catch(function() {
              failCount++;
              processNext(idx + 1);
            });
        };
        
        processNext(0);
      };
      reader.readAsText(file);
    });
  };

  // Collection type dropdown
  window.toggleCollDropdown = function() {
    var dd = document.getElementById('collDropdown');
    dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
  };

  window.setCollTypeFilter = function(type) {
    collTypeFilter = type;
    // Update active state on options
    document.querySelectorAll('.coll-filter-opt').forEach(function(el) {
      el.classList.remove('active');
      var txt = el.textContent.trim().toLowerCase();
      if ((type === '' && txt === 'all cards') ||
          (type === 'monster' && txt.indexOf('monster') !== -1) ||
          (type === 'spell'   && txt.indexOf('spell')   !== -1) ||
          (type === 'trap'    && txt.indexOf('trap')    !== -1)) {
        el.classList.add('active');
      }
    });
    // Update label next to title
    var labels = { '': '', 'monster': '— Monsters', 'spell': '— Spells', 'trap': '— Traps' };
    document.getElementById('collFilterLabel').textContent = labels[type] || '';
    document.getElementById('collDropdown').style.display = 'none';
    currentPage = 1; // Reset to first page
    renderTable();
  };

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('#collFilterBtn') && !e.target.closest('#collDropdown')) {
      var dd = document.getElementById('collDropdown');
      if (dd) dd.style.display = 'none';
    }
  });

  // Collection filter
  window.filterCollection = function() {
    var inp = document.getElementById('collSearch');
    collFilter = inp.value.trim().toLowerCase();
    document.getElementById('collClear').style.display = collFilter ? 'inline' : 'none';
    currentPage = 1; // Reset to first page
    renderTable();
  };

  window.clearCollSearch = function() {
    document.getElementById('collSearch').value = '';
    collFilter = '';
    document.getElementById('collClear').style.display = 'none';
    currentPage = 1; // Reset to first page
    renderTable();
  };

  // Fix #11: Quick filters
  var quickFilterActive = null;
  window.quickFilter = function(type) {
    quickFilterActive = quickFilterActive === type ? null : type;
    currentPage = 1;
    renderTable();
    
    if (quickFilterActive) {
      var label = type === 'notInDecks' ? '— Not in Decks' : '— Recently Added';
      toast('Filter: ' + label);
    } else {
      toast('Filter cleared');
    }
  };

  // Sort
  window.sortBy = function(col) {
    if (sortCol === col) {
      sortDir *= -1;
    } else {
      sortCol = col;
      sortDir = 1;
    }
    // Update sort icons
    document.querySelectorAll('.sort-icon').forEach(function(el) { el.className = 'sort-icon'; });
    var icon = document.getElementById('si-' + col);
    if (icon) icon.className = 'sort-icon ' + (sortDir === 1 ? 'asc' : 'desc');
    renderTable();
  };

  function getTypeDisplay(e) {
    var t = (e.type||'').toLowerCase();
    if (t.indexOf('spell') !== -1) return 'Spell';
    if (t.indexOf('trap')  !== -1) return 'Trap';
    return e.race || '—';
  }

  function getSortValue(e, col) {
    if (col === 'total') return (e.qty || 0) * (e.price || 0);
    if (col === 'qty')   return e.qty || 0;
    if (col === 'price') return e.price || 0;
    if (col === 'atk')   return isNaN(Number(e.atk)) ? -1 : Number(e.atk);
    if (col === 'level') return Number(e.level) || 0;
    if (col === 'type')  return getTypeDisplay(e).toLowerCase();
    if (col === 'inDecks') return countCardInDecks(e.name);
    return String(e[col] || '').toLowerCase();
  }

  function countCardInDecks(cardName) {
    var count = 0;
    savedDecks.forEach(function(deck) {
      ['main', 'extra', 'side'].forEach(function(zone) {
        if (deck[zone]) {
          deck[zone].forEach(function(card) {
            if (card.name === cardName) {
              count += card.qty || 1;
            }
          });
        }
      });
    });
    return count;
  }

  function filteredCards() {
    var base = cards;
    
    // Fix #11: Quick filters
    if (quickFilterActive === 'notInDecks') {
      base = base.filter(function(e) {
        return countCardInDecks(e.name) === 0;
      });
    } else if (quickFilterActive === 'recent') {
      var sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
      base = base.filter(function(e) {
        return e.addedAt && e.addedAt >= sevenDaysAgo;
      });
    }
    
    // Type filter (Monsters / Spells / Traps)
    if (collTypeFilter) {
      base = base.filter(function(e) {
        var t = (e.type||'').toLowerCase();
        if (collTypeFilter === 'monster') return t.indexOf('spell') === -1 && t.indexOf('trap') === -1;
        return t.indexOf(collTypeFilter) !== -1;
      });
    }
    // Text search filter
    if (!collFilter) return base;
    return base.filter(function(e) {
      return [e.name, e.type, e.race, e.attribute, e.archetype, e.setName, e.cardNumber, e.rarity, e.condition, e.edition]
        .some(function(v) { return String(v||'').toLowerCase().indexOf(collFilter) !== -1; });
    });
  }

  function sortedCards() {
    var base = filteredCards();
    if (!sortCol) return base;
    return base.slice().sort(function(a, b) {
      var av = getSortValue(a, sortCol);
      var bv = getSortValue(b, sortCol);
      if (av < bv) return -1 * sortDir;
      if (av > bv) return  1 * sortDir;
      return 0;
    });
  }

  // Render table
  function renderTable() {
    var tbody = document.getElementById('collBody');
    if (!cards.length) {
      tbody.innerHTML = '<tr><td colspan="13"><div class="empty-st"><div class="empty-ic">&#9876;</div><p class="empty-tx">Your collection awaits</p></div></td></tr>';
      updateStats(); 
      updatePagination();
      return;
    }
    var allCards = sortedCards();
    var totalPages = Math.ceil(allCards.length / pageSize);
    
    // Ensure current page is valid
    if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;
    
    // Get cards for current page
    var startIdx = (currentPage - 1) * pageSize;
    var endIdx = startIdx + pageSize;
    var pageCards = allCards.slice(startIdx, endIdx);
    
    var h = '';
    pageCards.forEach(function(e) {
      var tl = tLabel(e.type);
      var dc = dotClass(e.type);
      var tot = (e.qty||0)*(e.price||0);
      h += '<tr>';
      var nameClick = 'openCardModal(' + JSON.stringify(e.name) + ')';
      var imgId = e.cardImageId || '';
      var thumbSrc = imgId ? 'https://images.ygoprodeck.com/images/cards_small/' + imgId + '.jpg' : '';
      h += '<td class="td-thumb">' + (thumbSrc ? '<img src="' + thumbSrc + '" alt="" class="thumb-img" onclick="' + esc(nameClick) + '">' : '') + '</td>';
      h += '<td class="td-nm"><span class="dot ' + dc + '"></span><span class="card-link" onclick="' + esc(nameClick) + '">' + esc(e.name) + '</span></td>';
      h += '<td class="td-sm">' + esc(getTypeDisplay(e)) + '</td>';
      h += '<td class="td-sm">' + attrBadge(e.attribute) + '</td>';
      h += '<td class="td-sm">' + esc(e.archetype) + '</td>';
      h += '<td class="td-atk">' + (e.atk!=='—' ? e.atk+' / '+e.def : '—') + '</td>';
      h += '<td class="td-sm">' + esc(e.cardNumber||e.setCode||'—') + '</td>';
      var t2 = (e.type||'').toLowerCase();
      var isMonster = t2.indexOf('spell') === -1 && t2.indexOf('trap') === -1;
      var lvlDisplay = '';
      if (isMonster && e.level) {
        var pfx = t2.indexOf('xyz') !== -1 ? 'R' : t2.indexOf('link') !== -1 ? 'Link' : 'L';
        lvlDisplay = pfx + '-' + e.level;
      }
      h += '<td class="td-sm" style="text-align:center;font-family:Cinzel,serif;font-size:11px;color:var(--gold-pale)">' + lvlDisplay + '</td>';
      h += '<td class="rtxt ' + rClass(e.rarity) + '">' + esc(e.rarity) + '</td>';
      h += '<td><span class="cb ' + cClass(e.condition) + '">' + esc(e.condition) + '</span></td>';
      h += '<td class="td-sm">' + esc(e.edition) + '</td>';
      h += '<td style="padding:4px 8px"><div class="qty-ctrl"><button class="qty-btn" data-fid="'+e.fid+'" data-delta="-1">&#8722;</button><span class="qty-val">'+(e.qty||0)+'</span><button class="qty-btn" data-fid="'+e.fid+'" data-delta="1">+</button></div></td>';
      
      // Count how many copies are in decks
      var inDecksCount = countCardInDecks(e.name);
      var inDecksStyle = inDecksCount > 0 ? 'color:var(--gold);font-weight:600' : 'color:var(--silver-dim)';
      h += '<td class="td-sm" style="text-align:center;' + inDecksStyle + '">' + inDecksCount + '</td>';
      
      // Date Added
      var dateAdded = e.addedAt ? new Date(e.addedAt).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) : '—';
      h += '<td class="td-sm" style="font-size:11px;color:var(--silver-dim)">' + dateAdded + '</td>';
      
      h += '<td><button class="btn-del" onclick="removeEntry(\'' + e.fid + '\')">X</button></td>';
      h += '</tr>';
    });
    tbody.innerHTML = h;
    updateStats();
    updatePagination();
  }

  // Pagination functions
  function updatePagination() {
    var allCards = sortedCards();
    var totalPages = Math.max(1, Math.ceil(allCards.length / pageSize));
    
    document.getElementById('currentPageDisplay').textContent = currentPage;
    document.getElementById('totalPagesDisplay').textContent = totalPages;
    
    var prevBtn = document.getElementById('prevPageBtn');
    var nextBtn = document.getElementById('nextPageBtn');
    
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= totalPages;
    
    prevBtn.style.opacity = currentPage <= 1 ? '0.5' : '1';
    nextBtn.style.opacity = currentPage >= totalPages ? '0.5' : '1';
    prevBtn.style.cursor = currentPage <= 1 ? 'not-allowed' : 'pointer';
    nextBtn.style.cursor = currentPage >= totalPages ? 'not-allowed' : 'pointer';
  }
  
  window.prevPage = function() {
    if (currentPage > 1) {
      currentPage--;
      renderTable();
      document.querySelector('.tbl-wrap').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };
  
  window.nextPage = function() {
    var totalPages = Math.ceil(sortedCards().length / pageSize);
    if (currentPage < totalPages) {
      currentPage++;
      renderTable();
      document.querySelector('.tbl-wrap').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };
  
  window.changePageSize = function() {
    pageSize = parseInt(document.getElementById('pageSize').value);
    currentPage = 1; // Reset to first page
    renderTable();
  };

  // Qty button delegation on collection table
  document.addEventListener('click', function(e) {
    var btn = e.target.closest('.qty-btn');
    if (!btn) return;
    var fid = btn.dataset.fid;
    var delta = parseInt(btn.dataset.delta);
    if (fid && delta) adjustQty(fid, delta);
  });

  function updateStats() {
    var visible = filteredCards();
    document.getElementById('statUnique').textContent = collFilter
      ? visible.length + ' / ' + cards.length
      : cards.length;
    document.getElementById('statTotal').textContent = visible.reduce(function(s,e){return s+(e.qty||0);},0);
    // Rarity breakdown
    var rarOrder = ['Secret Rare','Prismatic Secret Rare','Starlight Rare','Quarter Century Secret Rare','Ghost Rare','Ultra Rare','Super Rare','Rare','Common'];
    var rarColors = {'Secret Rare':'#e879f9','Prismatic Secret Rare':'#f0abfc','Starlight Rare':'#fde68a','Quarter Century Secret Rare':'#fcd34d','Ghost Rare':'#e2e8f0','Ultra Rare':'#fcd34d','Super Rare':'#c4b5fd','Rare':'#93c5fd','Common':'#6b5f7a'};
    var counts = {};
    cards.forEach(function(e){
      var r = e.rarity || 'Common';
      counts[r] = (counts[r]||0) + (e.qty||1);
    });
    var html = '<span style="font-family:Cinzel,serif;font-size:9px;letter-spacing:2px;color:var(--silver-dim);text-transform:uppercase;margin-right:4px">Rarities:</span>';
    rarOrder.forEach(function(r){
      if (!counts[r]) return;
      var c = rarColors[r] || 'var(--silver)';
      html += '<span class="rar-stat"><span class="rar-stat-n" style="color:'+c+'">'+counts[r]+'</span><span style="color:var(--silver-dim);font-size:9px">'+r+'</span></span>';
    });
    // Any unlisted rarities
    Object.keys(counts).forEach(function(r){
      if (rarOrder.indexOf(r) === -1) html += '<span class="rar-stat"><span class="rar-stat-n" style="color:var(--silver)">'+counts[r]+'</span><span style="color:var(--silver-dim);font-size:9px">'+r+'</span></span>';
    });
    document.getElementById('rarityBreakdown').innerHTML = html;
  }

  // Export
  window.exportCSV = function() {
    if (!cards.length) { toast('Nothing to export!'); return; }
    var h = ['Card Name','Type','Attribute','Archetype','ATK','DEF','Set Name','Card Number','Rarity','Edition','Condition','Qty','Total','Notes'].join(',');
    var rows = cards.map(function(e) {
      return [e.name,e.type,e.attribute||'—',e.archetype,e.atk,e.def,e.setName,e.cardNumber||e.setCode||'—',e.rarity,e.edition,e.condition,e.qty,((e.qty||0)*(e.price||0)).toFixed(2),e.notes]
        .map(function(v){return '"'+String(v||'').replace(/"/g,'""')+'"';}).join(',');
    });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([[h].concat(rows).join('\r\n')],{type:'text/csv'}));
    a.download = 'yugioh_collection.csv'; a.click();
    toast('CSV exported!');
  };

  // Fix #7: Backup/Restore functionality
  window.downloadBackup = function() {
    if (!activeProfileId) {
      toast('No active profile to backup');
      return;
    }
    
    var backup = {
      version: '1.0',
      exportDate: new Date().toISOString(),
      profileName: activeProfileName,
      profileId: activeProfileId,
      cards: cards.map(function(c) {
        return {
          name: c.name, type: c.type, race: c.race, level: c.level,
          cardImageId: c.cardImageId, attribute: c.attribute, archetype: c.archetype,
          atk: c.atk, def: c.def, setName: c.setName, setCode: c.setCode,
          cardNumber: c.cardNumber, rarity: c.rarity, condition: c.condition,
          edition: c.edition, qty: c.qty, price: c.price, notes: c.notes,
          addedAt: c.addedAt
        };
      }),
      decks: savedDecks.map(function(d) {
        return {
          name: d.name, main: d.main, extra: d.extra, side: d.side,
          mainCount: d.mainCount, extraCount: d.extraCount, sideCount: d.sideCount,
          savedAt: d.savedAt
        };
      }),
      wishlist: wishlist.map(function(w) {
        return {
          name: w.name, notes: w.notes, priority: w.priority, addedAt: w.addedAt
        };
      }),
      theme: document.documentElement.getAttribute('data-theme') || ''
    };
    
    var json = JSON.stringify(backup, null, 2);
    var blob = new Blob([json], { type: 'application/json' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'yugioh_backup_' + activeProfileName.replace(/[^a-z0-9]/gi, '_') + '_' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    toast('Backup downloaded! (' + cards.length + ' cards, ' + savedDecks.length + ' decks)');
  };

  window.restoreBackup = function(input) {
    var file = input.files[0];
    if (!file) return;
    
    var confirmed = confirm(
      'RESTORE BACKUP\n\n' +
      'This will ADD the backup data to your current profile.\n' +
      'Your existing data will NOT be deleted.\n\n' +
      'Continue?'
    );
    
    if (!confirmed) {
      input.value = '';
      return;
    }
    
    requireAuth(function() {
      if (!activeProfileId) {
        toast('No active profile');
        input.value = '';
        return;
      }
      
      var reader = new FileReader();
      reader.onload = function(e) {
        try {
          var backup = JSON.parse(e.target.result);
          
          if (!backup.version || !backup.cards) {
            toast('Invalid backup file format');
            input.value = '';
            return;
          }
          
          toast('Restoring backup...');
          
          var promises = [];
          var cardsAdded = 0;
          var decksAdded = 0;
          var wishlistAdded = 0;
          
          // Restore cards
          backup.cards.forEach(function(card) {
            delete card.fid; // Remove old ID
            promises.push(
              col.add(card).then(function() { cardsAdded++; })
            );
          });
          
          // Restore decks
          backup.decks.forEach(function(deck) {
            delete deck.did; // Remove old ID
            promises.push(
              db.collection('profiles').doc(activeProfileId).collection('decks').add(deck)
                .then(function() { decksAdded++; })
            );
          });
          
          // Restore wishlist
          if (backup.wishlist) {
            backup.wishlist.forEach(function(item) {
              delete item.wid; // Remove old ID
              promises.push(
                db.collection('profiles').doc(activeProfileId).collection('wishlist').add(item)
                  .then(function() { wishlistAdded++; })
              );
            });
          }
          
          Promise.all(promises).then(function() {
            toast('Backup restored! ' + cardsAdded + ' cards, ' + decksAdded + ' decks, ' + wishlistAdded + ' wishlist items');
            input.value = '';
            
            // Apply theme if present
            if (backup.theme) {
              applyTheme(backup.theme);
            }
          }).catch(function(err) {
            toast('Restore error: ' + err.message);
            input.value = '';
          });
          
        } catch (err) {
          toast('Failed to parse backup file: ' + err.message);
          input.value = '';
        }
      };
      reader.readAsText(file);
    });
  };

  window.confirmRemoveAllCards = function() {
    if (!cards.length) {
      toast('Collection is already empty');
      return;
    }
    
    var cardCount = cards.length;
    var totalCards = cards.reduce(function(sum, c) { return sum + (c.qty || 0); }, 0);
    
    var confirmed = confirm(
      'WARNING: This will permanently delete ALL cards from your collection!\n\n' +
      'You have ' + cardCount + ' unique cards (' + totalCards + ' total cards).\n\n' +
      'This action CANNOT be undone!\n\n' +
      'Are you sure you want to remove all cards?'
    );
    
    if (confirmed) {
      removeAllCards();
    }
  };

  window.removeAllCards = function() {
    requireAuth(function() {
      if (!activeProfileId) return;
      
      toast('Removing all cards...');
      
      var batch = db.batch();
      var collectionRef = db.collection('profiles').doc(activeProfileId).collection('cards');
      
      // Get all cards and delete them in a batch
      collectionRef.get().then(function(snapshot) {
        if (snapshot.empty) {
          toast('Collection already empty');
          return;
        }
        
        snapshot.forEach(function(doc) {
          batch.delete(doc.ref);
        });
        
        return batch.commit();
      }).then(function() {
        toast('All cards removed from collection');
      }).catch(function(error) {
        toast('Error removing cards: ' + error.message);
        console.error('Error removing all cards:', error);
      });
    });
  };

  // Test API
  window.testAPI = function() {
    var el = document.getElementById('testResult');
    el.textContent = 'Testing...';
    el.style.color = 'var(--gold)';
    fetch('https://db.ygoprodeck.com/api/v7/cardinfo.php?fname=Dark+Magician')
      .then(function(r){return r.json();})
      .then(function(d){
        if (d.data && d.data.length) { el.textContent = 'Connected! Got '+d.data.length+' results.'; el.style.color='#4ade80'; }
        else { el.textContent = 'No data returned.'; el.style.color='#fcd34d'; }
      })
      .catch(function(e){ el.textContent = 'Error: '+e.message; el.style.color='#f87171'; });
  };

  // Helpers
  function dotClass(type) {
    if (!type) return 'dm';
    var t = type.toLowerCase();
    if (t.indexOf('spell') !== -1) return 'ds';
    if (t.indexOf('trap')  !== -1) return 'dt';
    if (t.indexOf('fusion')  !== -1) return 'd-fusion';
    if (t.indexOf('synchro') !== -1) return 'd-synchro';
    if (t.indexOf('xyz')     !== -1) return 'd-xyz';
    if (t.indexOf('link')    !== -1) return 'd-link';
    if (t.indexOf('ritual')  !== -1) return 'd-ritual';
    if (t.indexOf('pendulum') !== -1) return 'd-pendulum';
    if (t.indexOf('effect')  !== -1) return 'd-effect';
    if (t.indexOf('normal')  !== -1) return 'd-normal';
    return 'dm';
  }

  function attrBadge(attr) {
    if (!attr || attr === '—') return '<span style="color:var(--silver-dim)">—</span>';
    var colors = {
      'DARK':  '#c084fc', 'LIGHT': '#fde68a', 'EARTH': '#a8955a',
      'FIRE':  '#f87171', 'WATER': '#60a5fa', 'WIND':  '#4ade80', 'DIVINE': '#fcd34d'
    };
    var c = colors[attr.toUpperCase()] || 'var(--silver)';
    return '<span style="font-family:Cinzel,serif;font-size:9px;letter-spacing:1px;color:' + c + ';border:1px solid ' + c + '33;background:' + c + '11;padding:2px 7px;border-radius:4px;text-transform:uppercase">' + esc(attr) + '</span>';
  }

  function tLabel(type) {
    if (!type) return {t:'Unknown',c:'bm'};
    var t = type.toLowerCase();
    if (t.indexOf('spell')!==-1) return {t:'Spell',c:'bs'};
    if (t.indexOf('trap')!==-1)  return {t:'Trap',c:'bt'};
    return {t:'Monster',c:'bm'};
  }

  function cClass(c) {
    return {'Mint':'c0','Near Mint':'c1','Lightly Played':'c2','Moderately Played':'c3','Heavily Played':'c4','Damaged':'c5'}[c]||'c1';
  }

  function rClass(r) {
    if (!r) return 'rc';
    var rl = r.toLowerCase();
    if (rl.indexOf('secret')!==-1||rl.indexOf('starlight')!==-1||rl.indexOf('ghost')!==-1||rl.indexOf('quarter')!==-1) return 'rs';
    if (rl.indexOf('ultra')!==-1) return 'ru';
    if (rl.indexOf('super')!==-1) return 'rr2';
    if (rl==='rare') return 'rr1';
    return 'rc';
  }

  function toast(msg) {
    var t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(function(){t.classList.remove('show');}, 2800);
  }

  window.openCardModal = function(cardName) {
    // Look up the card from Firestore data first
    var entry = cards.find(function(c) { return c.name === cardName; });
    var modal = document.getElementById('cardModal');

    // Populate from local data immediately
    document.getElementById('modalName').textContent = cardName;
    document.getElementById('modalEffect').textContent = entry ? (entry.desc || entry.notes || '—') : 'Loading...';

    var meta = '';
    if (entry) {
      var tl = tLabel(entry.type);
      var pc = tl.c === 'bs' ? 'ps' : tl.c === 'bt' ? 'pt' : 'pm';
      meta += '<span class="mpill ' + pc + '">' + esc(entry.type) + '</span>';
      if (entry.archetype && entry.archetype !== '—') meta += '<span class="mpill pa">' + esc(entry.archetype) + '</span>';
      if (entry.attribute && entry.attribute !== '—') meta += '<span class="mpill" style="color:var(--silver);border-color:rgba(200,192,216,0.3);background:rgba(200,192,216,0.06)">' + esc(entry.attribute) + '</span>';
    }
    document.getElementById('modalMeta').innerHTML = meta;

    var ad = '';
    if (entry && entry.atk !== '—' && entry.atk !== undefined) {
      ad = 'ATK <b style="color:var(--gold)">' + entry.atk + '</b> / DEF <b style="color:var(--gold)">' + (entry.def||'?') + '</b>';
    }
    document.getElementById('modalAtkDef').innerHTML = ad;

    var setInfo = '';
    if (entry) setInfo = (entry.setName||'') + (entry.cardNumber ? ' &middot; ' + entry.cardNumber : '');
    document.getElementById('modalSet').innerHTML = setInfo;

    modal.style.display = 'flex';

    // Fetch full card data from API to get image and description
    fetch('https://db.ygoprodeck.com/api/v7/cardinfo.php?name=' + encodeURIComponent(cardName))
      .then(function(r) { return r.ok ? r.json() : null; })
      .then(function(data) {
        if (!data || !data.data || !data.data.length) return;
        var c = data.data[0];
        if (c.card_images && c.card_images.length) {
          var img = document.getElementById('modalImg');
          img.src = 'https://images.ygoprodeck.com/images/cards/' + c.card_images[0].id + '.jpg';
          img.style.display = 'block';
        }
        if (c.desc) document.getElementById('modalEffect').textContent = c.desc;
      })
      .catch(function() {});
  };

  window.addSearchedCardToWishlist = function() {
    if (!selCard) {
      toast('No card selected');
      return;
    }
    // Check if already in wishlist
    var alreadyExists = wishlist.find(function(w) { return w.name === selCard.name; });
    if (alreadyExists) {
      toast('Card already in wishlist');
      return;
    }
    addToWishlist(selCard.name, '', 'Medium');
  };

  window.closeCardModal = function() {
    document.getElementById('cardModal').style.display = 'none';
    document.getElementById('modalImg').src = '';
  };

  // ── Deck Detail Modal ────────────────────────────────────────
  window.openDeckDetailModal = function(deck) {
    var modal = document.getElementById('deckDetailModal');
    document.getElementById('deckDetailName').textContent = deck.name || 'Unnamed Deck';
    document.getElementById('deckDetailMainCount').textContent = deck.mainCount || 0;
    document.getElementById('deckDetailExtraCount').textContent = deck.extraCount || 0;
    document.getElementById('deckDetailSideCount').textContent = deck.sideCount || 0;
    
    var content = document.getElementById('deckDetailContent');
    content.innerHTML = '';
    
    // Render each zone
    ['main', 'extra', 'side'].forEach(function(zone) {
      var zoneCards = deck[zone] || [];
      if (!zoneCards.length) return;
      
      var zoneDiv = document.createElement('div');
      zoneDiv.className = 'deck-detail-zone';
      
      // Separate cards by type and monster subtype
      var monstersBySubtype = {
        fusion: [],
        synchro: [],
        xyz: [],
        link: [],
        ritual: [],
        effect: [],
        normal: [],
        other: []
      };
      var spells = [];
      var traps = [];
      
      zoneCards.forEach(function(card) {
        var type = (card.type || '').toLowerCase();
        if (type.includes('monster')) {
          // Categorize by monster subtype
          if (type.includes('fusion')) {
            monstersBySubtype.fusion.push(card);
          } else if (type.includes('synchro')) {
            monstersBySubtype.synchro.push(card);
          } else if (type.includes('xyz')) {
            monstersBySubtype.xyz.push(card);
          } else if (type.includes('link')) {
            monstersBySubtype.link.push(card);
          } else if (type.includes('ritual')) {
            monstersBySubtype.ritual.push(card);
          } else if (type.includes('effect')) {
            monstersBySubtype.effect.push(card);
          } else if (type.includes('normal')) {
            monstersBySubtype.normal.push(card);
          } else {
            monstersBySubtype.other.push(card);
          }
        } else if (type.includes('spell')) {
          spells.push(card);
        } else if (type.includes('trap')) {
          traps.push(card);
        }
      });
      
      // Calculate total monster count
      var monsterCount = 0;
      Object.keys(monstersBySubtype).forEach(function(subtype) {
        monsterCount += monstersBySubtype[subtype].reduce(function(sum, c) { return sum + c.qty; }, 0);
      });
      var spellCount = spells.reduce(function(sum, c) { return sum + c.qty; }, 0);
      var trapCount = traps.reduce(function(sum, c) { return sum + c.qty; }, 0);
      
      var header = document.createElement('div');
      header.className = 'deck-detail-zone-header';
      var zoneName = zone === 'main' ? 'Main Deck' : zone === 'extra' ? 'Extra Deck' : 'Side Deck';
      var totalCards = zoneCards.reduce(function(sum, c) { return sum + c.qty; }, 0);
      header.innerHTML = zoneName + ' (' + totalCards + ')';
      
      // Add type breakdown
      var breakdown = document.createElement('div');
      breakdown.className = 'deck-detail-breakdown';
      breakdown.innerHTML = 
        '<span class="breakdown-item"><span class="breakdown-label">Monsters:</span> <b>' + monsterCount + '</b></span>' +
        '<span class="breakdown-item"><span class="breakdown-label">Spells:</span> <b>' + spellCount + '</b></span>' +
        '<span class="breakdown-item"><span class="breakdown-label">Traps:</span> <b>' + trapCount + '</b></span>';
      
      zoneDiv.appendChild(header);
      zoneDiv.appendChild(breakdown);
      
      // Function to render a card grid
      function renderCardGrid(cards) {
        var cardsGrid = document.createElement('div');
        cardsGrid.className = 'deck-detail-cards';
        
        cards.forEach(function(card) {
          var cardDiv = document.createElement('div');
          cardDiv.className = 'deck-detail-card';
          cardDiv.onclick = function() { openCardModal(card.name); };
          
          var img = document.createElement('img');
          img.className = 'deck-detail-card-img';
          img.alt = card.name;
          
          // Fetch card image from API
          fetch('https://db.ygoprodeck.com/api/v7/cardinfo.php?name=' + encodeURIComponent(card.name))
            .then(function(r) { return r.ok ? r.json() : null; })
            .then(function(data) {
              if (data && data.data && data.data[0] && data.data[0].card_images && data.data[0].card_images[0]) {
                img.src = data.data[0].card_images[0].image_url_small;
              }
            })
            .catch(function() {
              // Image load failed, leave placeholder
            });
          
          cardDiv.appendChild(img);
          
          if (card.qty > 1) {
            var qtyBadge = document.createElement('div');
            qtyBadge.className = 'deck-detail-card-qty';
            qtyBadge.textContent = 'x' + card.qty;
            cardDiv.appendChild(qtyBadge);
          }
          
          cardsGrid.appendChild(cardDiv);
        });
        
        return cardsGrid;
      }
      
      // Function to render a type section with optional subsections
      function renderTypeSection(sectionData, sectionTitle) {
        if (!sectionData) return;
        
        // Check if we have any cards
        var hasCards = false;
        if (Array.isArray(sectionData)) {
          hasCards = sectionData.length > 0;
        } else {
          // It's an object with subsections
          Object.keys(sectionData).forEach(function(key) {
            if (sectionData[key].length > 0) hasCards = true;
          });
        }
        
        if (!hasCards) return;
        
        var typeHeader = document.createElement('div');
        typeHeader.className = 'deck-detail-type-header';
        typeHeader.textContent = sectionTitle;
        zoneDiv.appendChild(typeHeader);
        
        if (Array.isArray(sectionData)) {
          // Simple array of cards
          zoneDiv.appendChild(renderCardGrid(sectionData));
        } else {
          // Object with subsections (for monsters)
          var subtypeOrder = ['fusion', 'synchro', 'xyz', 'link', 'ritual', 'effect', 'normal', 'other'];
          var subtypeLabels = {
            fusion: 'Fusion',
            synchro: 'Synchro',
            xyz: 'Xyz',
            link: 'Link',
            ritual: 'Ritual',
            effect: 'Effect',
            normal: 'Normal',
            other: 'Other'
          };
          
          subtypeOrder.forEach(function(subtype) {
            var cards = sectionData[subtype];
            if (cards && cards.length > 0) {
              var subtypeHeader = document.createElement('div');
              subtypeHeader.className = 'deck-detail-subtype-header';
              subtypeHeader.textContent = subtypeLabels[subtype];
              zoneDiv.appendChild(subtypeHeader);
              zoneDiv.appendChild(renderCardGrid(cards));
            }
          });
        }
      }
      
      // Render sections in order: Monsters (with subtypes), Spells, Traps
      renderTypeSection(monstersBySubtype, 'Monsters');
      renderTypeSection(spells, 'Spells');
      renderTypeSection(traps, 'Traps');
      
      content.appendChild(zoneDiv);
    });
    
    modal.style.display = 'flex';
  };

  window.closeDeckDetailModal = function() {
    document.getElementById('deckDetailModal').style.display = 'none';
  };

  // Qty adjust
  window.adjustQty = function(id, delta) {
    requireAuth(function() {
      var card = cards.find(function(c){ return c.fid === id; });
      if (!card) return;
      var newQty = Math.max(1, (card.qty||1) + delta);
      col.doc(id).update({ qty: newQty }).catch(function(e){ toast('Update failed'); });
    });
  };

  // ── Deck Builder ───────────────────────────────────────────
  var deck = { main: [], extra: [], side: [] };
  var loadedDeckId = null; // Track which saved deck is currently loaded

  var extraTypes = ['fusion','synchro','xyz','link'];
  function getDeckZone(type) {
    var t = (type||'').toLowerCase();
    for (var i=0; i<extraTypes.length; i++) { if (t.indexOf(extraTypes[i]) !== -1) return 'extra'; }
    return 'main';
  }

  window.filterDeckSearch = function() {
    var q = document.getElementById('deckSearch').value.trim().toLowerCase();
    var res = document.getElementById('deckSearchResults');
    if (q.length < 2) { res.style.display = 'none'; return; }
    var matches = cards.filter(function(c){ return c.name.toLowerCase().indexOf(q) !== -1; }).slice(0, 12);
    if (!matches.length) { res.style.display = 'none'; return; }
    var btnStyle = 'font-family:Cinzel,serif;font-size:8px;padding:2px 7px;border-radius:4px;border:1px solid rgba(180,40,40,0.4);background:rgba(160,30,30,0.2);color:#f0c040;cursor:pointer';
    res.innerHTML = '';
    matches.forEach(function(c) {
      var row = document.createElement('div');
      row.style.cssText = 'padding:8px 14px;cursor:pointer;font-size:14px;border-bottom:1px solid rgba(180,40,40,0.12);color:#c8b8c8;display:flex;justify-content:space-between;align-items:center';
      row.onmouseover = function(){ this.style.background='rgba(160,30,30,0.25)'; };
      row.onmouseout  = function(){ this.style.background=''; };
      var nameSpan = document.createElement('span');
      nameSpan.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
      nameSpan.textContent = c.name;
      row.appendChild(nameSpan);
      var btnWrap = document.createElement('span');
      btnWrap.style.cssText = 'display:flex;gap:6px;margin-left:8px';
      ['main','extra','side'].forEach(function(zone) {
        var btn = document.createElement('button');
        btn.setAttribute('style', btnStyle);
        btn.textContent = zone.charAt(0).toUpperCase() + zone.slice(1);
        btn.onclick = function(e){ e.stopPropagation(); addToDeck(c.fid, zone); };
        btnWrap.appendChild(btn);
      });
      row.appendChild(btnWrap);
      row.onclick = function(){ addToDeck(c.fid, 'main'); };
      res.appendChild(row);
    });
    res.style.display = 'block';
    res.style.position = 'absolute';
  };

  document.addEventListener('click', function(e) {
    if (!e.target.closest('.deck-search-row')) {
      document.getElementById('deckSearchResults').style.display = 'none';
    }
  });

  window.addToDeck = function(fid, zone) {
    var card = cards.find(function(c){ return c.fid === fid; });
    if (!card) return;
    // Max 3 copies per card across all zones (1 for limited)
    var totalCopies = ['main','extra','side'].reduce(function(s,z){
      return s + deck[z].filter(function(d){ return d.fid === fid; }).reduce(function(s2,d){ return s2+d.qty; }, 0);
    }, 0);
    if (totalCopies >= 3) { toast('Max 3 copies of ' + card.name); return; }
    var existing = deck[zone].find(function(d){ return d.fid === fid; });
    if (existing) { existing.qty++; } else { deck[zone].push({ fid: fid, name: card.name, type: card.type, qty: 1 }); }
    document.getElementById('deckSearch').value = '';
    document.getElementById('deckSearchResults').style.display = 'none';
    renderDeck();
  };

  window.removeDeckCard = function(fid, zone) {
    var idx = deck[zone].findIndex(function(d){ return d.fid === fid; });
    if (idx === -1) return;
    if (deck[zone][idx].qty > 1) { deck[zone][idx].qty--; } else { deck[zone].splice(idx, 1); }
    renderDeck();
  };

  function renderDeck() {
    ['main','extra','side'].forEach(function(zone) {
      var el = document.getElementById(zone + 'Deck');
      var count = deck[zone].reduce(function(s,d){ return s+d.qty; }, 0);
      var countEl = document.getElementById(zone + 'Count');
      countEl.textContent = count;
      
      // Fix #4: Deck size validation with visual indicators
      if (zone === 'main') {
        if (count >= 40 && count <= 60) {
          countEl.className = 'deck-zone-count ok';
          countEl.title = 'Valid deck size (40-60 cards)';
        } else if (count > 0) {
          countEl.className = 'deck-zone-count warn';
          countEl.title = count < 40 ? 'Too few cards (minimum 40)' : 'Too many cards (maximum 60)';
        } else {
          countEl.className = 'deck-zone-count';
          countEl.title = '';
        }
      } else if (zone === 'extra') {
        if (count <= 15) {
          countEl.className = 'deck-zone-count' + (count > 0 ? ' ok' : '');
          countEl.title = count > 0 ? 'Valid extra deck size (0-15 cards)' : '';
        } else {
          countEl.className = 'deck-zone-count warn';
          countEl.title = 'Too many cards (maximum 15)';
        }
      } else {
        if (count <= 15) {
          countEl.className = 'deck-zone-count' + (count > 0 ? ' ok' : '');
          countEl.title = count > 0 ? 'Valid side deck size (0-15 cards)' : '';
        } else {
          countEl.className = 'deck-zone-count warn';
          countEl.title = 'Too many cards (maximum 15)';
        }
      }
      if (!deck[zone].length) {
        el.innerHTML = '<div class="deck-drop-target">Search above to add cards</div>';
      } else {
        el.innerHTML = '';
        deck[zone].forEach(function(d) {
          var item = document.createElement('div');
          item.className = 'deck-card-item';
          item.style.cssText = 'display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:6px;background:rgba(255,255,255,0.02)';

          var nameEl = document.createElement('span');
          nameEl.className = 'deck-card-name';
          nameEl.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
          nameEl.textContent = d.name;
          nameEl.onclick = function(){ openCardModal(d.name); };

          // Qty controls
          var qtyWrap = document.createElement('div');
          qtyWrap.style.cssText = 'display:flex;align-items:center;gap:3px;flex-shrink:0';

          var minusBtn = document.createElement('button');
          minusBtn.className = 'deck-card-rm';
          minusBtn.innerHTML = '&#8722;';
          minusBtn.title = 'Remove one copy';
          minusBtn.onclick = function(){ removeDeckCard(d.fid, zone); };

          var qtyEl = document.createElement('span');
          qtyEl.className = 'deck-card-qty';
          qtyEl.style.cssText = 'min-width:20px;text-align:center';
          qtyEl.textContent = 'x' + d.qty;

          var plusBtn = document.createElement('button');
          plusBtn.className = 'deck-card-rm';
          plusBtn.style.color = 'var(--gold-pale)';
          plusBtn.innerHTML = '+';
          plusBtn.title = 'Add one copy';
          (function(fid, dname, dtype) {
            plusBtn.onclick = function() {
              // Check collection qty limit
              var collCard = cards.find(function(c){ return c.fid === fid; });
              var collQty = collCard ? (collCard.qty || 1) : 1;
              var totalInDeck = ['main','extra','side'].reduce(function(s,z){
                return s + deck[z].filter(function(x){ return x.fid === fid; }).reduce(function(s2,x){ return s2+x.qty; },0);
              }, 0);
              if (totalInDeck >= 3) { toast('Max 3 copies of ' + dname); return; }
              if (totalInDeck >= collQty) { toast('Only ' + collQty + ' cop' + (collQty===1?'y':'ies') + ' of ' + dname + ' in collection'); return; }
              addToDeck(fid, zone);
            };
          })(d.fid, d.name, d.type);

          qtyWrap.appendChild(minusBtn);
          qtyWrap.appendChild(qtyEl);
          qtyWrap.appendChild(plusBtn);
          item.appendChild(nameEl);
          item.appendChild(qtyWrap);
          el.appendChild(item);
        });
      }
    });
    var total = ['main','extra','side'].reduce(function(s,z){ return s + deck[z].reduce(function(s2,d){ return s2+d.qty; },0); }, 0);
    var mainCount = deck.main.reduce(function(s,d){ return s+d.qty; },0);
    document.getElementById('deckTotalCount').textContent = total + ' card' + (total !== 1 ? 's' : '') + ' — Main: ' + deck.main.reduce(function(s,d){return s+d.qty;},0) + ' • Extra: ' + deck.extra.reduce(function(s,d){return s+d.qty;},0) + ' • Side: ' + deck.side.reduce(function(s,d){return s+d.qty;},0);
  }

  window.exportDeck = function() {
    var name = document.getElementById('deckName').value || 'My Deck';
    var lines = ['# ' + name, '# Exported from Scott\'s YGO Collection Tracker', ''];
    var mainCount = deck.main.reduce(function(s,d){ return s+d.qty; },0);
    lines.push('#main');
    deck.main.forEach(function(d){ for(var i=0;i<d.qty;i++) lines.push(d.name); });
    lines.push('');
    lines.push('#extra');
    deck.extra.forEach(function(d){ for(var i=0;i<d.qty;i++) lines.push(d.name); });
    lines.push('');
    lines.push('#side');
    deck.side.forEach(function(d){ for(var i=0;i<d.qty;i++) lines.push(d.name); });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([lines.join('\n')], {type:'text/plain'}));
    a.download = name.replace(/[^a-z0-9]/gi,'_') + '.ydk';
    a.click();
    toast('Deck exported as .ydk!');
  };

  window.clearDeck = function() {
    deck = { main: [], extra: [], side: [] };
    loadedDeckId = null; // Reset loaded deck tracking
    renderDeck();
    updateSaveButton(); // Update button text back to "Save Deck"
    toast('Deck cleared');
  };

  // ── Import .ydk ────────────────────────────────────────────
  window.importYdk = function(input) {
    var file = input.files[0];
    if (!file) return;
    requireAuth(function() {
      var reader = new FileReader();
      reader.onload = function(e) {
        var lines = e.target.result.replace(/\r/g, '').split('\n');
        var zone = 'main';
        // Parse: { zone, cardId, count }
        var parsed = { main: {}, extra: {}, side: {} }; // cardId -> {zone, count}
        lines.forEach(function(line) {
          line = line.trim();
          if (!line || line[0] === '!' || line.slice(0,2) === '//') return;
          if (line === '#main')  { zone = 'main';  return; }
          if (line === '#extra') { zone = 'extra'; return; }
          if (line === '#side')  { zone = 'side';  return; }
          if (line[0] === '#') return;
          if (/^[0-9]+$/.test(line)) {
            parsed[zone][line] = (parsed[zone][line] || 0) + 1;
          }
        });
        var allIds = [];
        ['main','extra','side'].forEach(function(z) {
          Object.keys(parsed[z]).forEach(function(id) { if (allIds.indexOf(id) === -1) allIds.push(id); });
        });
        if (!allIds.length) { toast('No card IDs found in .ydk file'); input.value = ''; return; }
        toast('Fetching ' + allIds.length + ' card(s) from API...');
        // Fetch all card data from YGOPRODeck by ID
        var fetched = {};
        var pending = allIds.slice();
        function fetchBatch() {
          if (!pending.length) { processImport(); return; }
          var batch = pending.splice(0, 10);
          var url = 'https://db.ygoprodeck.com/api/v7/cardinfo.php?id=' + batch.join(',');
          fetch(url).then(function(r){ return r.json(); }).then(function(data) {
            if (data.data) {
              data.data.forEach(function(c) {
                fetched[String(c.id)] = c;
              });
            }
            fetchBatch();
          }).catch(function() { fetchBatch(); });
        }
        function processImport() {
          var addPromises = [];
          var deckResult = { main: [], extra: [], side: [] };
          var addedCount = 0;
          var skippedCount = 0;
          ['main','extra','side'].forEach(function(z) {
            Object.keys(parsed[z]).forEach(function(cardId) {
              var c = fetched[cardId];
              if (!c) { skippedCount++; return; }
              var qty = Math.min(parsed[z][cardId], 3);
              // Check if card already in collection
              var existing = cards.find(function(col) { return String(col.cardImageId) === cardId; });
              if (existing) {
                deckResult[z].push({ fid: existing.fid, name: existing.name, type: existing.type, qty: qty });
              } else {
                // Add to collection
                var fs = (c.card_sets && c.card_sets.length) ? c.card_sets[0] : {};
                var newCard = {
                  name: c.name, type: c.type, race: c.race||'—',
                  level: c.level||c.linkval||null,
                  cardImageId: c.card_images && c.card_images.length ? c.card_images[0].id : null,
                  attribute: c.attribute||'—', archetype: c.archetype||'—',
                  atk: c.atk !== undefined ? (c.atk === -1 ? '?' : String(c.atk)) : '—',
                  def: c.def !== undefined ? (c.def === -1 ? '?' : String(c.def)) : '—',
                  setName: fs.set_name||'—', setCode: fs.set_code||'—',
                  cardNumber: fs.set_code||'—', rarity: fs.set_rarity||'Common',
                  condition: 'Near Mint', edition: '1st Edition',
                  qty: qty, price: 0, notes: '', addedAt: Date.now()
                };
                addPromises.push(
                  col.add(newCard).then(function(ref) {
                    addedCount++;
                    deckResult[z].push({ fid: ref.id, name: c.name, type: c.type, qty: qty });
                  })
                );
              }
            });
          });
          Promise.all(addPromises).then(function() {
            // Prepare deck data for saving
            var deckData = {
              main: deckResult.main,
              extra: deckResult.extra,
              side: deckResult.side,
              mainCount: deckResult.main.reduce(function(s, c) { return s + c.qty; }, 0),
              extraCount: deckResult.extra.reduce(function(s, c) { return s + c.qty; }, 0),
              sideCount: deckResult.side.reduce(function(s, c) { return s + c.qty; }, 0)
            };
            
            // Get deck name from file
            var defaultName = file.name.replace(/\.ydk$/i, '').replace(/_/g, ' ');
            var deckName = prompt('Enter a name for this deck:', defaultName);
            
            if (!deckName || !deckName.trim()) {
              toast('Import cancelled - no deck name provided');
              input.value = '';
              return;
            }
            
            deckData.name = deckName.trim();
            deckData.savedAt = Date.now();
            
            // Save directly to Firestore
            if (!activeProfileId) {
              toast('Error: No active profile');
              input.value = '';
              return;
            }
            
            db.collection('profiles').doc(activeProfileId).collection('decks').add(deckData)
              .then(function() {
                var msg = 'Deck "' + deckData.name + '" saved';
                if (addedCount) msg += ' — ' + addedCount + ' new card(s) added to collection';
                if (skippedCount) msg += ' — ' + skippedCount + ' card(s) not found';
                toast(msg);
                input.value = '';
                // Switch to Saved Decks tab to show the new deck
                switchTab('decks');
              })
              .catch(function(err) {
                toast('Error saving deck: ' + err.message);
                input.value = '';
              });
          });
        }
        fetchBatch();
      };
      reader.readAsText(file);
    });
  };

  // Duplicate feature replaced with inline +/- controls


  // ══ Wishlist ════════════════════════════════════════════════
  var wishlist = [];
  var wishlistUnsub = null;

  function loadWishlist() {
    if (!activeProfileId) return;
    if (wishlistUnsub) { wishlistUnsub(); wishlistUnsub = null; }
    wishlistUnsub = db.collection('profiles').doc(activeProfileId).collection('wishlist').onSnapshot(function(snap) {
      wishlist = [];
      snap.forEach(function(doc) {
        wishlist.push(Object.assign({ wid: doc.id }, doc.data()));
      });
      renderWishlist();
    });
  }

  function renderWishlist() {
    var grid = document.getElementById('wishlistGrid');
    if (!wishlist.length) {
      grid.innerHTML = '<div class="deck-empty">No cards in wishlist. Search for cards and add them!</div>';
      document.getElementById('wishlistCount').textContent = '';
      return;
    }
    
    document.getElementById('wishlistCount').textContent = wishlist.length + ' card' + (wishlist.length !== 1 ? 's' : '');
    grid.innerHTML = '';
    
    wishlist.forEach(function(w) {
      var card = document.createElement('div');
      card.className = 'wishlist-card';
      
      var header = document.createElement('div');
      header.style.cssText = 'display:flex;justify-content:space-between;align-items:start;margin-bottom:8px';
      
      var name = document.createElement('div');
      name.style.cssText = 'font-family:Cinzel,serif;font-size:14px;color:var(--gold-pale);flex:1;cursor:pointer';
      name.textContent = w.name;
      name.onclick = function() { openCardModal(w.name); };
      header.appendChild(name);
      
      var removeBtn = document.createElement('button');
      removeBtn.style.cssText = 'background:none;border:none;color:var(--silver-dim);cursor:pointer;font-size:18px;line-height:1';
      removeBtn.innerHTML = '&times;';
      removeBtn.onclick = function() { removeFromWishlist(w.wid); };
      header.appendChild(removeBtn);
      
      card.appendChild(header);
      
      if (w.notes) {
        var notes = document.createElement('div');
        notes.style.cssText = 'font-size:12px;color:var(--silver);font-style:italic;margin-bottom:8px';
        notes.textContent = w.notes;
        card.appendChild(notes);
      }
      
      var meta = document.createElement('div');
      meta.style.cssText = 'font-size:11px;color:var(--silver-dim);display:flex;gap:12px';
      if (w.priority) {
        var priority = document.createElement('span');
        priority.textContent = 'Priority: ' + w.priority;
        meta.appendChild(priority);
      }
      if (w.addedAt) {
        var date = document.createElement('span');
        date.textContent = 'Added: ' + new Date(w.addedAt).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'});
        meta.appendChild(date);
      }
      card.appendChild(meta);
      
      grid.appendChild(card);
    });
  }

  window.addToWishlist = function(cardName, notes, priority) {
    requireAuth(function() {
      if (!activeProfileId) return;
      var wishlistData = {
        name: cardName,
        notes: notes || '',
        priority: priority || 'Medium',
        addedAt: Date.now()
      };
      db.collection('profiles').doc(activeProfileId).collection('wishlist').add(wishlistData).then(function() {
        toast('Added to wishlist: ' + cardName);
      }).catch(function(e){ toast('Failed to add: ' + e.message); });
    });
  };

  window.removeFromWishlist = function(wid) {
    requireAuth(function() {
      if (!activeProfileId) return;
      db.collection('profiles').doc(activeProfileId).collection('wishlist').doc(wid).delete().then(function(){
        toast('Removed from wishlist');
      }).catch(function(e){ toast('Remove failed'); });
    });
  };

  // ══ Collection Statistics ═══════════════════════════════════
  var statsCharts = {}; // Store chart instances
  
  window.refreshStats = function() {
    renderStats();
    toast('Statistics refreshed');
  };
  
  function renderStats() {
    if (!cards.length) {
      toast('No cards in collection to analyze');
      return;
    }
    
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
      console.error('Chart.js not loaded');
      toast('Error: Chart library not loaded');
      return;
    }
    
    // Summary statistics
    var uniqueCards = cards.length;
    var totalCards = cards.reduce(function(sum, c) { return sum + (c.qty || 0); }, 0);
    var avgQty = (totalCards / uniqueCards).toFixed(1);
    
    document.getElementById('stat-unique-cards').textContent = uniqueCards;
    document.getElementById('stat-total-cards').textContent = totalCards;
    document.getElementById('stat-total-decks').textContent = savedDecks.length;
    document.getElementById('stat-avg-qty').textContent = avgQty;
    
    // Render all charts with error handling
    try {
      renderTypeChart();
      renderRarityChart();
      renderConditionChart();
      renderArchetypeChart();
      renderGrowthChart();
      renderTopCardsTable();
      renderDeckStatsTable();
    } catch (err) {
      console.error('Error rendering statistics:', err);
      toast('Error rendering statistics: ' + err.message);
    }
  }
  
  function renderTypeChart() {
    var canvas = document.getElementById('typeChart');
    if (!canvas) {
      console.error('typeChart canvas not found');
      return;
    }
    
    var types = { 'Monsters': 0, 'Spells': 0, 'Traps': 0 };
    cards.forEach(function(c) {
      var t = (c.type || '').toLowerCase();
      if (t.indexOf('spell') !== -1) types.Spells += c.qty || 1;
      else if (t.indexOf('trap') !== -1) types.Traps += c.qty || 1;
      else types.Monsters += c.qty || 1;
    });
    
    if (statsCharts.type) statsCharts.type.destroy();
    
    var ctx = document.getElementById('typeChart').getContext('2d');
    statsCharts.type = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(types),
        datasets: [{
          data: Object.values(types),
          backgroundColor: ['#8b1a1a', '#1a3a7a', '#2d6be0'],
          borderColor: '#1a0505',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            labels: { color: '#f0c040', font: { family: 'Cinzel', size: 12 } },
            position: 'bottom'
          }
        }
      }
    });
  }
  
  function renderRarityChart() {
    var canvas = document.getElementById('rarityChart');
    if (!canvas) {
      console.error('rarityChart canvas not found');
      return;
    }
    
    var rarities = {};
    cards.forEach(function(c) {
      var r = c.rarity || 'Unknown';
      rarities[r] = (rarities[r] || 0) + (c.qty || 1);
    });
    
    // Sort by count
    var sorted = Object.entries(rarities).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 8);
    
    if (statsCharts.rarity) statsCharts.rarity.destroy();
    
    var ctx = document.getElementById('rarityChart').getContext('2d');
    statsCharts.rarity = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sorted.map(function(e) { return e[0]; }),
        datasets: [{
          label: 'Cards',
          data: sorted.map(function(e) { return e[1]; }),
          backgroundColor: '#c0392b',
          borderColor: '#f0c040',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { 
            ticks: { color: '#c8c0d8', font: { family: 'Cinzel' } },
            grid: { color: 'rgba(180,40,40,0.2)' }
          },
          x: { 
            ticks: { color: '#f0c040', font: { family: 'Cinzel', size: 10 }, maxRotation: 45, minRotation: 45 },
            grid: { display: false }
          }
        }
      }
    });
  }
  
  function renderConditionChart() {
    var canvas = document.getElementById('conditionChart');
    if (!canvas) {
      console.error('conditionChart canvas not found');
      return;
    }
    
    var conditions = {};
    cards.forEach(function(c) {
      var cond = c.condition || 'Unknown';
      conditions[cond] = (conditions[cond] || 0) + (c.qty || 1);
    });
    
    if (statsCharts.condition) statsCharts.condition.destroy();
    
    var ctx = document.getElementById('conditionChart').getContext('2d');
    statsCharts.condition = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(conditions),
        datasets: [{
          data: Object.values(conditions),
          backgroundColor: ['#4ade80', '#7ec8f0', '#f0c040', '#fde68a', '#f87171', '#8b1a1a'],
          borderColor: '#1a0505',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            labels: { color: '#f0c040', font: { family: 'Cinzel', size: 11 } },
            position: 'bottom'
          }
        }
      }
    });
  }
  
  function renderArchetypeChart() {
    var canvas = document.getElementById('archetypeChart');
    if (!canvas) {
      console.error('archetypeChart canvas not found');
      return;
    }
    
    var archetypes = {};
    cards.forEach(function(c) {
      var arch = c.archetype;
      if (arch && arch !== '—') {
        archetypes[arch] = (archetypes[arch] || 0) + (c.qty || 1);
      }
    });
    
    var sorted = Object.entries(archetypes).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 10);
    
    if (statsCharts.archetype) statsCharts.archetype.destroy();
    
    var ctx = document.getElementById('archetypeChart').getContext('2d');
    statsCharts.archetype = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sorted.map(function(e) { return e[0]; }),
        datasets: [{
          label: 'Cards',
          data: sorted.map(function(e) { return e[1]; }),
          backgroundColor: '#2d6be0',
          borderColor: '#7ec8f0',
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { 
            ticks: { color: '#c8c0d8', font: { family: 'Cinzel' } },
            grid: { color: 'rgba(180,40,40,0.2)' }
          },
          y: { 
            ticks: { color: '#f0c040', font: { family: 'Cinzel', size: 10 } },
            grid: { display: false }
          }
        }
      }
    });
  }
  
  function renderGrowthChart() {
    var canvas = document.getElementById('growthChart');
    if (!canvas) {
      console.error('growthChart canvas not found');
      return;
    }
    
    var dateGroups = {};
    cards.forEach(function(c) {
      if (c.addedAt) {
        var date = new Date(c.addedAt);
        var key = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
        dateGroups[key] = (dateGroups[key] || 0) + (c.qty || 1);
      }
    });
    
    var sorted = Object.entries(dateGroups).sort(function(a, b) { return a[0].localeCompare(b[0]); });
    
    // Calculate cumulative
    var cumulative = [];
    var sum = 0;
    sorted.forEach(function(e) {
      sum += e[1];
      cumulative.push(sum);
    });
    
    if (statsCharts.growth) statsCharts.growth.destroy();
    
    var ctx = document.getElementById('growthChart').getContext('2d');
    statsCharts.growth = new Chart(ctx, {
      type: 'line',
      data: {
        labels: sorted.map(function(e) { return e[0]; }),
        datasets: [{
          label: 'Total Cards',
          data: cumulative,
          borderColor: '#f0c040',
          backgroundColor: 'rgba(240,192,64,0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            labels: { color: '#f0c040', font: { family: 'Cinzel', size: 12 } }
          }
        },
        scales: {
          y: { 
            ticks: { color: '#c8c0d8', font: { family: 'Cinzel' } },
            grid: { color: 'rgba(180,40,40,0.2)' }
          },
          x: { 
            ticks: { color: '#f0c040', font: { family: 'Cinzel' } },
            grid: { color: 'rgba(180,40,40,0.1)' }
          }
        }
      }
    });
  }
  
  function renderTopCardsTable() {
    var sorted = cards.slice().sort(function(a, b) { return (b.qty || 0) - (a.qty || 0); }).slice(0, 10);
    
    var html = '';
    sorted.forEach(function(c, i) {
      html += '<div class="stat-table-row">';
      html += '<span class="stat-table-label">' + (i + 1) + '. ' + c.name + '</span>';
      html += '<span class="stat-table-value">' + (c.qty || 0) + ' copies</span>';
      html += '</div>';
    });
    
    document.getElementById('topCardsTable').innerHTML = html || '<div style="color:var(--silver-dim);text-align:center;padding:20px">No data</div>';
  }
  
  function renderDeckStatsTable() {
    var cardsInDecks = 0;
    var cardsNotInDecks = 0;
    var totalDeckCards = 0;
    
    cards.forEach(function(c) {
      var inDecks = countCardInDecks(c.name);
      if (inDecks > 0) {
        cardsInDecks++;
        totalDeckCards += inDecks;
      } else {
        cardsNotInDecks++;
      }
    });
    
    var avgCardsPerDeck = savedDecks.length > 0 ? (totalDeckCards / savedDecks.length).toFixed(1) : 0;
    
    var html = '';
    html += '<div class="stat-table-row"><span class="stat-table-label">Cards used in decks</span><span class="stat-table-value">' + cardsInDecks + '</span></div>';
    html += '<div class="stat-table-row"><span class="stat-table-label">Cards not in any deck</span><span class="stat-table-value">' + cardsNotInDecks + '</span></div>';
    html += '<div class="stat-table-row"><span class="stat-table-label">Total deck slots used</span><span class="stat-table-value">' + totalDeckCards + '</span></div>';
    html += '<div class="stat-table-row"><span class="stat-table-label">Avg. cards per deck</span><span class="stat-table-value">' + avgCardsPerDeck + '</span></div>';
    html += '<div class="stat-table-row"><span class="stat-table-label">Total saved decks</span><span class="stat-table-value">' + savedDecks.length + '</span></div>';
    
    document.getElementById('deckStatsTable').innerHTML = html;
  }

  // ══ Deck Suggestions ════════════════════════════════════════
  var allSuggestions = [];
  var filteredSuggestions = [];

  // Popular archetypes to suggest
  var popularArchetypes = [
    'Blue-Eyes', 'Dark Magician', 'Red-Eyes', 'Cyber Dragon', 'Elemental HERO',
    'Gladiator Beast', 'Lightsworn', 'Six Samurai', 'Blackwing', 'Destiny HERO',
    'Synchron', 'Stardust', 'Ghostrick', 'Madolche', 'Burning Abyss',
    'Shaddoll', 'Qliphort', 'Nekroz', 'Kozmo', 'Phantom Knights',
    'ABC', 'Zoodiac', 'True Draco', 'SPYRAL', 'Trickstar',
    'Sky Striker', 'Salamangreat', 'Orcust', 'Thunder Dragon', 'Endymion',
    'Marincess', 'Eldlich', 'Dragonmaid', 'Tri-Brigade', 'Swordsoul',
    'Branded', 'Tearlaments', 'Kashtira', 'Purrely', 'Snake-Eye'
  ];

  window.loadDeckSuggestions = function() {
    if (!authed) {
      toast('Please unlock to view suggestions');
      return;
    }
    
    if (!cards || cards.length === 0) {
      document.getElementById('suggestionsGrid').innerHTML = '<div class="deck-empty">Add cards to your collection to see deck suggestions</div>';
      return;
    }
    
    document.getElementById('suggestionsLoading').style.display = 'block';
    document.getElementById('suggestionsGrid').innerHTML = '';
    
    // Analyze collection for archetype suggestions
    allSuggestions = analyzeArchetypeSuggestions();
    
    // Sort by match percentage and card count
    allSuggestions.sort(function(a, b) { 
      if (b.matchPercent !== a.matchPercent) return b.matchPercent - a.matchPercent;
      return b.ownedCount - a.ownedCount;
    });
    
    filteredSuggestions = allSuggestions.slice();
    document.getElementById('suggestionsLoading').style.display = 'none';
    renderSuggestions();
  };

  function analyzeArchetypeSuggestions() {
    var suggestions = [];
    var archetypeCards = {};
    
    // Group owned cards by archetype
    cards.forEach(function(card) {
      var archetype = card.archetype;
      if (archetype && archetype !== '—') {
        if (!archetypeCards[archetype]) {
          archetypeCards[archetype] = [];
        }
        archetypeCards[archetype].push(card);
      }
    });
    
    // Create suggestions for archetypes with enough cards
    Object.keys(archetypeCards).forEach(function(archetype) {
      var archetypeCardList = archetypeCards[archetype];
      var totalOwned = archetypeCardList.reduce(function(sum, c) { return sum + (c.qty || 0); }, 0);
      var uniqueCards = archetypeCardList.length;
      
      // Only suggest if we have at least 5 cards from the archetype
      if (totalOwned >= 5) {
        // Estimate deck completion (typical deck has 15-25 archetype cards)
        var estimatedDeckSize = Math.max(40, totalOwned + 10);
        var matchPercent = Math.min(100, Math.round((totalOwned / estimatedDeckSize) * 100));
        
        suggestions.push({
          name: archetype + ' Deck',
          archetype: archetype,
          ownedCount: totalOwned,
          uniqueCards: uniqueCards,
          totalCards: estimatedDeckSize,
          matchPercent: matchPercent,
          cards: archetypeCardList,
          missingCards: [] // We don't know specific missing cards
        });
      }
    });
    
    // If no archetypes found, suggest based on popular ones in collection
    if (suggestions.length === 0) {
      var cardTypes = {};
      cards.forEach(function(card) {
        var type = card.type || '';
        if (type.includes('Monster')) {
          cardTypes['Monster'] = (cardTypes['Monster'] || 0) + (card.qty || 0);
        } else if (type.includes('Spell')) {
          cardTypes['Spell'] = (cardTypes['Spell'] || 0) + (card.qty || 0);
        } else if (type.includes('Trap')) {
          cardTypes['Trap'] = (cardTypes['Trap'] || 0) + (card.qty || 0);
        }
      });
      
      if (cardTypes['Monster'] > 0) {
        suggestions.push({
          name: 'Mixed Strategy Deck',
          archetype: 'Generic',
          ownedCount: cards.reduce(function(s, c) { return s + (c.qty || 0); }, 0),
          uniqueCards: cards.length,
          totalCards: 40,
          matchPercent: Math.min(100, Math.round((cards.reduce(function(s, c) { return s + (c.qty || 0); }, 0) / 40) * 100)),
          cards: cards,
          missingCards: []
        });
      }
    }
    
    return suggestions;
  }

  window.filterSuggestions = function() {
    var minMatch = parseInt(document.getElementById('matchFilter').value);
    filteredSuggestions = allSuggestions.filter(function(d) {
      return d.matchPercent >= minMatch;
    });
    renderSuggestions();
  };

  function renderSuggestions() {
    var grid = document.getElementById('suggestionsGrid');
    
    if (!filteredSuggestions.length) {
      grid.innerHTML = '<div class="deck-empty">No deck suggestions found. Try adjusting filters or add more cards to your collection.</div>';
      document.getElementById('suggestionsCount').textContent = '0 decks';
      return;
    }
    
    document.getElementById('suggestionsCount').textContent = filteredSuggestions.length + ' deck' + (filteredSuggestions.length !== 1 ? 's' : '');
    
    grid.innerHTML = '';
    filteredSuggestions.forEach(function(suggestion) {
      var card = document.createElement('div');
      card.className = 'suggestion-card';
      
      var header = document.createElement('div');
      header.className = 'suggestion-header';
      
      var name = document.createElement('div');
      name.className = 'suggestion-name';
      name.textContent = suggestion.name;
      header.appendChild(name);
      
      var matchDiv = document.createElement('div');
      matchDiv.style.textAlign = 'right';
      var matchPercent = document.createElement('div');
      matchPercent.className = 'suggestion-match';
      matchPercent.textContent = suggestion.matchPercent + '%';
      var matchLabel = document.createElement('div');
      matchLabel.className = 'suggestion-match-label';
      matchLabel.textContent = 'Progress';
      matchDiv.appendChild(matchPercent);
      matchDiv.appendChild(matchLabel);
      header.appendChild(matchDiv);
      
      card.appendChild(header);
      
      var info = document.createElement('div');
      info.className = 'suggestion-info';
      info.textContent = 'You own ' + suggestion.ownedCount + ' cards (' + suggestion.uniqueCards + ' unique)';
      card.appendChild(info);
      
      var meta = document.createElement('div');
      meta.className = 'suggestion-meta';
      
      var cardsItem = document.createElement('div');
      cardsItem.className = 'suggestion-meta-item';
      cardsItem.innerHTML = '<div class="suggestion-meta-label">Total Cards</div><div class="suggestion-meta-value">' + suggestion.ownedCount + '</div>';
      meta.appendChild(cardsItem);
      
      var uniqueItem = document.createElement('div');
      uniqueItem.className = 'suggestion-meta-item';
      uniqueItem.innerHTML = '<div class="suggestion-meta-label">Unique</div><div class="suggestion-meta-value">' + suggestion.uniqueCards + '</div>';
      meta.appendChild(uniqueItem);
      
      var archetypeItem = document.createElement('div');
      archetypeItem.className = 'suggestion-meta-item';
      archetypeItem.innerHTML = '<div class="suggestion-meta-label">Archetype</div><div class="suggestion-meta-value">' + suggestion.archetype + '</div>';
      meta.appendChild(archetypeItem);
      
      card.appendChild(meta);
      
      var actions = document.createElement('div');
      actions.className = 'suggestion-actions';
      
      var viewBtn = document.createElement('button');
      viewBtn.className = 'suggestion-btn view';
      viewBtn.textContent = 'View Your Cards';
      viewBtn.onclick = function() { viewSuggestedDeck(suggestion); };
      actions.appendChild(viewBtn);
      
      card.appendChild(actions);
      grid.appendChild(card);
    });
  }

  window.viewSuggestedDeck = function(suggestion) {
    // Show the cards you own for this archetype
    var deckData = {
      name: suggestion.name + ' (Your Collection)',
      main: [],
      extra: [],
      side: [],
      mainCount: 0,
      extraCount: 0,
      sideCount: 0
    };
    
    suggestion.cards.forEach(function(card) {
      var cardData = {
        name: card.name,
        qty: card.qty || 1,
        type: card.type || '—',
        fid: card.fid
      };
      
      // Determine zone based on card type
      var type = (card.type || '').toLowerCase();
      var isExtra = type.includes('fusion') || type.includes('synchro') || type.includes('xyz') || type.includes('link');
      
      if (isExtra) {
        deckData.extra.push(cardData);
        deckData.extraCount += cardData.qty;
      } else {
        deckData.main.push(cardData);
        deckData.mainCount += cardData.qty;
      }
    });
    
    openDeckDetailModal(deckData);
  };

  // ── Theme ──────────────────────────────────────────────────
  window.applyTheme = function(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    if (activeProfileId) {
      db.collection('profiles').doc(activeProfileId).update({ theme: theme }).catch(function(){});
    }
    localStorage.setItem('theme_' + (activeProfileId || 'default'), theme);
  };

  function loadTheme() {
    var stored = localStorage.getItem('theme_' + (activeProfileId || 'default')) || '';
    document.documentElement.setAttribute('data-theme', stored);
    var sel = document.getElementById('themeSelect');
    if (sel) sel.value = stored;
  }

  // Patch selectProfile to load theme on profile switch
  var _origSelectProfile = window.selectProfile;
  // (theme loading injected into selectProfile below)

  // ── Drag and drop: collection rows → deck zones ────────────
  function makeDraggable() {
    var rows = document.querySelectorAll('#collBody tr');
    rows.forEach(function(row) {
      var fidCell = row.querySelector('[data-fid]') || row.querySelector('.qty-btn');
      if (!fidCell) return;
      var fid = fidCell.dataset.fid;
      if (!fid) return;
      row.setAttribute('draggable', true);
      row.style.cursor = 'grab';
      row.addEventListener('dragstart', function(ev) {
        ev.dataTransfer.setData('text/plain', fid);
        ev.dataTransfer.effectAllowed = 'copy';
        row.style.opacity = '0.5';
      });
      row.addEventListener('dragend', function() {
        row.style.opacity = '';
      });
    });
  }

  // Make deck zones drop targets
  ['main','extra','side'].forEach(function(zone) {
    var el = document.getElementById(zone + 'Deck');
    if (!el) return;
    el.addEventListener('dragover', function(ev) {
      ev.preventDefault();
      ev.dataTransfer.dropEffect = 'copy';
      el.style.background = 'rgba(240,192,64,0.06)';
    });
    el.addEventListener('dragleave', function() {
      el.style.background = '';
    });
    el.addEventListener('drop', function(ev) {
      ev.preventDefault();
      el.style.background = '';
      var fid = ev.dataTransfer.getData('text/plain');
      if (fid) addToDeck(fid, zone);
    });
  });

  // Re-run makeDraggable after every renderTable
  var _origRenderTable = renderTable;
  renderTable = function() {
    _origRenderTable();
    setTimeout(makeDraggable, 0);
  };

  // Init deck render
  renderDeck();
  loadTheme();

  // ── Tab switching ─────────────────────────────────────────
  window.switchTab = function(tab) {
    ['collection','stats','decks','wishlist','suggestions'].forEach(function(t) {
      document.getElementById('pane-' + t).classList.toggle('active', t === tab);
      document.getElementById('tab-' + t).classList.toggle('active', t === tab);
    });
    if (tab === 'stats') {
      // Delay to ensure canvas elements are visible
      setTimeout(function() {
        renderStats();
      }, 100);
    }
    if (tab === 'decks') renderSavedDecks();
    if (tab === 'wishlist') renderWishlist();
    if (tab === 'suggestions') {
      if (allSuggestions.length === 0) {
        loadDeckSuggestions();
      }
    }
  };

  // ── Save deck to Firestore ─────────────────────────────────
  window.saveDeck = function() {
    var name = document.getElementById('deckName').value.trim();
    if (!name) { toast('Please enter a deck name first'); return; }
    var mainCount = deck.main.reduce(function(s,d){ return s+d.qty; },0);
    if (mainCount < 1) { toast('Deck is empty'); return; }
    requireAuth(function() {
      var deckData = {
        name: name,
        main:  deck.main.map(function(d){ return {fid:d.fid, name:d.name, type:d.type, qty:d.qty}; }),
        extra: deck.extra.map(function(d){ return {fid:d.fid, name:d.name, type:d.type, qty:d.qty}; }),
        side:  deck.side.map(function(d){ return {fid:d.fid, name:d.name, type:d.type, qty:d.qty}; }),
        mainCount:  deck.main.reduce(function(s,d){ return s+d.qty; },0),
        extraCount: deck.extra.reduce(function(s,d){ return s+d.qty; },0),
        sideCount:  deck.side.reduce(function(s,d){ return s+d.qty; },0),
        savedAt: Date.now()
      };
      if (!activeProfileId) { toast('No profile selected'); return; }
      
      // If we have a loadedDeckId, update the existing deck
      if (loadedDeckId) {
        db.collection('profiles').doc(activeProfileId).collection('decks').doc(loadedDeckId).update(deckData).then(function() {
          toast('Deck updated: ' + name);
        }).catch(function(e){ toast('Update failed: ' + e.message); });
      } else {
        // Otherwise, create a new deck
        db.collection('profiles').doc(activeProfileId).collection('decks').add(deckData).then(function() {
          toast('Deck saved: ' + name);
        }).catch(function(e){ toast('Save failed: ' + e.message); });
      }
    });
  };

  // Update the save button text based on whether a deck is loaded
  function updateSaveButton() {
    var btn = document.getElementById('saveDeckBtn');
    var saveAsNewBtn = document.getElementById('saveAsNewBtn');
    if (loadedDeckId) {
      btn.innerHTML = '&#x21bb; Update Deck';
      saveAsNewBtn.style.display = 'inline-block';
    } else {
      btn.innerHTML = '&#x2713; Save Deck';
      saveAsNewBtn.style.display = 'none';
    }
  }

  // Save current deck as a new deck (creates a copy)
  window.saveAsNewDeck = function() {
    loadedDeckId = null; // Clear the loaded deck ID
    updateSaveButton(); // Update button text
    saveDeck(); // Save as new
  };

  // ── Load saved decks from Firestore ───────────────────────
  var savedDecks = [];
  function loadSavedDecks() {
    if (!activeProfileId) return;
    if (decksUnsub) { decksUnsub(); decksUnsub = null; }
    decksUnsub = db.collection('profiles').doc(activeProfileId).collection('decks').orderBy('savedAt','desc').onSnapshot(function(snap) {
      savedDecks = [];
      snap.forEach(function(doc) {
        savedDecks.push(Object.assign({ did: doc.id }, doc.data()));
      });
      var countEl = document.getElementById('savedDeckCount');
      if (countEl) countEl.textContent = savedDecks.length + ' deck' + (savedDecks.length !== 1 ? 's' : '');
      // Always re-render — both when tab is active and when a save just happened
      renderSavedDecks();
    }, function(err) {
      console.error('Decks listener error:', err);
    });
  }
  // Do NOT call loadSavedDecks() here — called by selectProfile once profile is active

  function renderSavedDecks() {
    var grid = document.getElementById('savedDecksGrid');
    if (!savedDecks.length) {
      grid.innerHTML = '<div class="deck-empty">No saved decks yet — build one in the Collection tab</div>';
      return;
    }
    grid.innerHTML = '';
    savedDecks.forEach(function(d) {
      var card = document.createElement('div');
      card.className = 'saved-deck-card';
      card.onclick = function(e) {
        // Don't open detail modal if clicking on action buttons
        if (e.target.closest('.deck-action-btn')) return;
        openDeckDetailModal(d);
      };

      var nameEl = document.createElement('div');
      nameEl.className = 'saved-deck-name';
      nameEl.textContent = d.name;
      card.appendChild(nameEl);

      var meta = document.createElement('div');
      meta.className = 'saved-deck-meta';
      meta.innerHTML = '<span>Main: <b style="color:var(--gold-pale)">' + (d.mainCount||0) + '</b></span>'
        + '<span>Extra: <b style="color:var(--gold-pale)">' + (d.extraCount||0) + '</b></span>'
        + '<span>Side: <b style="color:var(--gold-pale)">' + (d.sideCount||0) + '</b></span>';
      card.appendChild(meta);

      var date = document.createElement('div');
      date.className = 'saved-deck-date';
      date.textContent = d.savedAt ? new Date(d.savedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
      card.appendChild(date);

      // Card lists by zone
      ['main','extra','side'].forEach(function(zone) {
        var zoneCards = d[zone] || [];
        if (!zoneCards.length) return;
        var section = document.createElement('div');
        section.className = 'deck-card-list-section';
        var label = document.createElement('div');
        label.className = 'deck-card-list-section-label';
        var zoneName = zone === 'main' ? 'Main Deck' : zone === 'extra' ? 'Extra Deck' : 'Side Deck';
        label.textContent = zoneName + ' (' + zoneCards.reduce(function(s,c){return s+c.qty;},0) + ')';
        section.appendChild(label);
        zoneCards.forEach(function(c) {
          var item = document.createElement('div');
          item.className = 'deck-card-list-item';
          var nameSpan = document.createElement('span');
          nameSpan.textContent = c.name;
          nameSpan.style.cssText = 'overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1';
          var qtySpan = document.createElement('span');
          qtySpan.className = 'qty-tag';
          qtySpan.textContent = c.qty > 1 ? 'x' + c.qty : '';
          item.appendChild(nameSpan);
          item.appendChild(qtySpan);
          section.appendChild(item);
        });
        card.appendChild(section);
      });

      var actions = document.createElement('div');
      actions.className = 'saved-deck-actions';

      var loadBtn = document.createElement('button');
      loadBtn.className = 'deck-action-btn load';
      loadBtn.textContent = 'Load';
      loadBtn.onclick = function(e){ e.stopPropagation(); loadDeckIntoBuilder(d); };
      actions.appendChild(loadBtn);

      var dupBtn = document.createElement('button');
      dupBtn.className = 'deck-action-btn export';
      dupBtn.textContent = 'Duplicate';
      dupBtn.onclick = function(e){ e.stopPropagation(); duplicateDeck(d); };
      actions.appendChild(dupBtn);

      var expBtn = document.createElement('button');
      expBtn.className = 'deck-action-btn export';
      expBtn.textContent = 'Export .ydk';
      expBtn.onclick = function(e){ e.stopPropagation(); exportSavedDeck(d); };
      actions.appendChild(expBtn);

      var delBtn = document.createElement('button');
      delBtn.className = 'deck-action-btn del';
      delBtn.textContent = 'Delete';
      delBtn.onclick = function(e){ e.stopPropagation(); deleteSavedDeck(d.did, d.name); };
      actions.appendChild(delBtn);

      card.appendChild(actions);
      grid.appendChild(card);
    });
  }

  window.loadDeckIntoBuilder = function(d) {
    deck.main  = (d.main  || []).slice();
    deck.extra = (d.extra || []).slice();
    deck.side  = (d.side  || []).slice();
    document.getElementById('deckName').value = d.name;
    loadedDeckId = d.did; // Track this deck for updating
    renderDeck();
    updateSaveButton(); // Update button text
    switchTab('collection');
    // Scroll to deck builder
    setTimeout(function(){
      document.querySelector('.deck-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
    toast('Loaded: ' + d.name);
  };

  window.deleteSavedDeck = function(did, name) {
    requireAuth(function() {
      if (!activeProfileId) return;
      db.collection('profiles').doc(activeProfileId).collection('decks').doc(did).delete().then(function(){
        toast('Deleted: ' + name);
      }).catch(function(e){ toast('Delete failed'); });
    });
  };

  window.duplicateDeck = function(d) {
    requireAuth(function() {
      if (!activeProfileId) return;
      var copyName = d.name + ' (Copy)';
      var deckData = {
        name: copyName,
        main:  (d.main || []).map(function(c){ return {fid:c.fid, name:c.name, type:c.type, qty:c.qty}; }),
        extra: (d.extra || []).map(function(c){ return {fid:c.fid, name:c.name, type:c.type, qty:c.qty}; }),
        side:  (d.side || []).map(function(c){ return {fid:c.fid, name:c.name, type:c.type, qty:c.qty}; }),
        mainCount:  d.mainCount || 0,
        extraCount: d.extraCount || 0,
        sideCount:  d.sideCount || 0,
        savedAt: Date.now()
      };
      db.collection('profiles').doc(activeProfileId).collection('decks').add(deckData).then(function() {
        toast('Duplicated: ' + copyName);
      }).catch(function(e){ toast('Duplicate failed: ' + e.message); });
    });
  };

  window.exportSavedDeck = function(d) {
    var lines = ['# ' + d.name, '# Exported from Scott\'s YGO Collection Tracker', '', '#main'];
    (d.main||[]).forEach(function(c){ for(var i=0;i<c.qty;i++) lines.push(c.name); });
    lines.push('', '#extra');
    (d.extra||[]).forEach(function(c){ for(var i=0;i<c.qty;i++) lines.push(c.name); });
    lines.push('', '#side');
    (d.side||[]).forEach(function(c){ for(var i=0;i<c.qty;i++) lines.push(c.name); });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([lines.join('\n')],{type:'text/plain'}));
    a.download = d.name.replace(/[^a-z0-9]/gi,'_') + '.ydk';
    a.click();
    toast('Exported: ' + d.name);
  };

  // ══ Profile Management ══════════════════════════════════════

  function selectProfile(profileId, profileName) {
    // If switching from one profile to another, clear auth
    var wasSwitching = activeProfileId && activeProfileId !== profileId;
    
    activeProfileId = profileId;
    activeProfileName = profileName;
    localStorage.setItem('activeProfileId', profileId);
    localStorage.setItem('activeProfileName', profileName);
    
    // Load auth state for this profile (or require password if switching)
    if (wasSwitching) {
      authed = false;
      sessionStorage.setItem('authed_' + profileId, 'false');
    } else {
      authed = sessionStorage.getItem('authed_' + profileId) === 'true';
    }
    updateLockBtn();
    
    // label updated above
    // Hide profile screen, show app
    var ps = document.getElementById('profileScreen');
    if (ps) { ps.classList.remove('active'); ps.style.display = 'none'; }
    document.getElementById('activeProfileLabel').textContent = profileName;
    var hpn = document.getElementById('headerProfileName');
    if (hpn) hpn.textContent = profileName + "'s Yu-Gi-Oh!";
    document.title = profileName + "'s Yu-Gi-Oh! Collection Tracker";
    // Start scoped listeners
    startProfileListener(profileId);
    loadSavedDecks();
    loadWishlist();
    // Reset deck builder
    deck = { main: [], extra: [], side: [] };
    renderDeck();
  }

  window._showProfileScreen = window.showProfileScreen = function() {
    var ps = document.getElementById('profileScreen');
    if (!ps) { console.error('profileScreen element not found'); return; }
    if (decksUnsub) { decksUnsub(); decksUnsub = null; }
    if (wishlistUnsub) { wishlistUnsub(); wishlistUnsub = null; }
    if (cardsUnsub) { cardsUnsub(); cardsUnsub = null; }
    var psn = document.getElementById('profileScreenName');
    if (psn) psn.textContent = 'Collection';
    ps.style.display = 'flex';
    ps.classList.add('active');
    loadProfiles();
  };

  function loadProfiles() {
    var grid = document.getElementById('profileGrid');
    grid.innerHTML = '<div style="color:var(--silver-dim);font-family:Cinzel,serif;font-size:11px;letter-spacing:2px">Loading...</div>';
    db.collection('profiles').orderBy('createdAt','asc').get().then(function(snap) {
      grid.innerHTML = '';
      if (snap.empty) {
        // No profiles — just show the + card, handled below
      }
      snap.forEach(function(doc) {
        var p = doc.data();
        var initial = (p.name || '?')[0].toUpperCase();
        var card = document.createElement('div');
        card.className = 'ps-card';
        var avatarDiv = document.createElement('div');
        avatarDiv.className = 'ps-avatar';
        avatarDiv.textContent = initial;
        var labelDiv = document.createElement('div');
        labelDiv.className = 'ps-label';
        labelDiv.textContent = p.name;
        var metaDiv = document.createElement('div');
        metaDiv.className = 'ps-meta';
        metaDiv.textContent = (p.cardCount || 0) + ' cards';
        var delBtn = document.createElement('button');
        delBtn.className = 'ps-del';
        delBtn.title = 'Delete profile';
        delBtn.innerHTML = '&#x2715;';
        delBtn.onclick = function(e) { e.stopPropagation(); deleteProfile(doc.id, p.name); };
        card.appendChild(avatarDiv);
        card.appendChild(labelDiv);
        card.appendChild(metaDiv);
        card.appendChild(delBtn);
        card.onclick = function() { selectProfile(doc.id, p.name); };
        grid.appendChild(card);
      });
      // Add "New Profile" card
      var newCard = document.createElement('div');
      newCard.className = 'ps-card ps-new';
      var navatarDiv = document.createElement('div');
      navatarDiv.className = 'ps-avatar';
      navatarDiv.style.cssText = 'font-size:26px;border-style:dashed;background:none';
      navatarDiv.textContent = '+';
      var nlabelDiv = document.createElement('div');
      nlabelDiv.className = 'ps-label';
      nlabelDiv.style.color = 'var(--silver-dim)';
      nlabelDiv.textContent = 'New Profile';
      newCard.appendChild(navatarDiv);
      newCard.appendChild(nlabelDiv);
      newCard.onclick = function() {
        document.getElementById('newProfileModal').style.display = 'flex';
        setTimeout(function(){ document.getElementById('newProfileName').focus(); }, 50);
      };
      grid.appendChild(newCard);
    }).catch(function(e) {
    var rulesSnippet = [
      'rules_version = "2";',
      'service cloud.firestore {',
      '  match /databases/{database}/documents {',
      '    match /{document=**} {',
      '      allow read: if true;',
      '      allow write: if false;',
      '    }',
      '  }',
      '}'
    ].join('\n');
      grid.innerHTML = '<div style="text-align:center;grid-column:1/-1;padding:20px">'
        + '<div style="color:#f87171;font-family:Cinzel,serif;font-size:12px;letter-spacing:1px;margin-bottom:12px">Firestore permission error</div>'
        + '<div style="color:var(--silver-dim);font-size:12px;line-height:1.8;margin-bottom:16px">'
        + 'Update your Firestore security rules to allow reads.<br>'
        + 'Go to <b style="color:var(--gold-pale)">Firebase Console → Firestore → Rules</b> and paste:<br></div>'
        + '<code style="display:block;background:rgba(0,0,0,0.4);border:1px solid var(--border);border-radius:8px;padding:12px 16px;font-size:11px;color:#4ade80;text-align:left;white-space:pre;max-width:480px;margin:0 auto">'
        + rulesSnippet
        + '</code>'
        + '<div style="color:var(--silver-dim);font-size:11px;margin-top:12px">Then reload this page.</div>'
        + '</div>';
    });
  }

  window.createProfile = function() {
    var name = document.getElementById('newProfileName').value.trim();
    var pw   = document.getElementById('newProfilePw').value;
    var errEl = document.getElementById('newProfileError');
    if (!name) { errEl.textContent = 'Please enter a name'; return; }
    if (name.length > 24) { errEl.textContent = 'Name too long (max 24 chars)'; return; }
    if (!pw) { errEl.textContent = 'Password required'; return; }
    errEl.textContent = 'Verifying...';
    sha256(pw).then(function(hash) {
      if (hash !== PW_HASH) {
        errEl.textContent = 'Incorrect password';
        document.getElementById('newProfilePw').value = '';
        return;
      }
      errEl.textContent = '';
      db.collection('profiles').add({
        name: name,
        cardCount: 0,
        createdAt: Date.now()
      }).then(function(ref) {
        authed = true;
        updateLockBtn();
        closeNewProfileModal();
        selectProfile(ref.id, name);
      }).catch(function(e) {
        errEl.textContent = 'Error: ' + e.message;
      });
    });
  };

  window.closeNewProfileModal = function() {
    document.getElementById('newProfileModal').style.display = 'none';
    document.getElementById('newProfileName').value = '';
    document.getElementById('newProfilePw').value = '';
    document.getElementById('newProfileError').textContent = '';
  };

  function deleteProfile(profileId, profileName) {
    requireAuth(function() {
      if (!confirm('Delete profile "' + profileName + '"? This cannot be undone.')) return;
      // Delete all cards and decks subcollections then the profile doc
      // Firestore doesn't auto-delete subcollections — batch delete cards first
      var batch = db.batch();
      var profileRef = db.collection('profiles').doc(profileId);
      // Get all cards and decks to delete
      Promise.all([
        profileRef.collection('cards').get(),
        profileRef.collection('decks').get()
      ]).then(function(results) {
        results.forEach(function(snap) {
          snap.forEach(function(doc) { batch.delete(doc.ref); });
        });
        batch.delete(profileRef);
        return batch.commit();
      }).then(function() {
        toast('Profile deleted: ' + profileName);
        if (activeProfileId === profileId) {
          activeProfileId = null;
          activeProfileName = null;
          localStorage.removeItem('activeProfileId');
          localStorage.removeItem('activeProfileName');
          showProfileScreen();
        } else {
          loadProfiles();
        }
      }).catch(function(e) { toast('Delete failed: ' + e.message); });
    });
  }

  // ── Key handler for new profile modal ──
  var npnEl = document.getElementById('newProfileName');
  if (npnEl) npnEl.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeNewProfileModal();
  });
  var nppEl = document.getElementById('newProfilePw');
  if (nppEl) nppEl.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeNewProfileModal();
  });

  // ── On load: show profile screen (auto-select if remembered) ──
  if (activeProfileId && activeProfileName) {
    // Verify profile still exists before auto-selecting
    db.collection('profiles').doc(activeProfileId).get().then(function(doc) {
      if (doc.exists) {
        selectProfile(activeProfileId, activeProfileName);
      } else {
        localStorage.removeItem('activeProfileId');
        localStorage.removeItem('activeProfileName');
        loadProfiles();
      }
    }).catch(function() { loadProfiles(); });
  } else {
    loadProfiles();
  }

  function esc(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

}; // window.onload
</script>
</body>
</html>
